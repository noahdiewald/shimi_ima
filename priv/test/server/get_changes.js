var simple_doc = {
  '_id': '25250e2ead108a8f60213f2404007c91',
  '_rev': '1-6ec90301ac115fed382a77207e81a9ca',
  'doctype': 'bim',
  'description': '',
  'fieldsets': [{
    'id': 'b9ad37ea17a58d9be32160f393770e5d',
    'multiple': false,
    'collapse': false,
    'name': 'hip',
    'label': 'Hip',
    'order': 50,
    'fields': [{
      'id': '25250e2ead108a8f60213f24040007e4',
      'name': 'caltest',
      'label': 'CalTest',
      'head': false,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '25250e2ead108a8f60213f2404005d38',
      'regex': '',
      'order': 50,
      'subcategory': 'date',
      'value': '1990-08-23'
    },
    {
      'id': '25250e2ead108a8f60213f240400248f',
      'name': 'ff',
      'label': 'FF',
      'head': false,
      'reversal': false,
      'required': false,
      'min': 0,
      'max': 10,
      'instance': '25250e2ead108a8f60213f2404006a4d',
      'regex': '',
      'order': 50,
      'subcategory': 'integer',
      'value': ''
    },
    {
      'id': 'b9ad37ea17a58d9be32160f393771cdd',
      'name': 'yer',
      'label': 'Yer',
      'head': true,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '25250e2ead108a8f60213f240400717c',
      'regex': '',
      'order': 50,
      'subcategory': 'boolean',
      'value': false
    }]
  }],
  'created_at_': 'Tue Aug 23 2011 22:03:24 GMT-0500 (CDT)',
  'created_by_': 'admin'
};
var simple_doc2 = {
  '_id': '25250e2ead108a8f60213f2404007c91',
  '_rev': '1-6ec90301ac115fed382a77207e81a9ca',
  'doctype': 'bim',
  'description': '',
  'fieldsets': [{
    'id': 'b9ad37ea17a58d9be32160f393770e5d',
    'multiple': false,
    'collapse': false,
    'name': 'hip',
    'label': 'Hip',
    'order': 50,
    'fields': [{
      'id': '25250e2ead108a8f60213f24040007e4',
      'name': 'caltest',
      'label': 'CalTest',
      'head': false,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '25250e2ead108a8f60213f2404005d38',
      'regex': '',
      'order': 50,
      'subcategory': 'date',
      'value': '1990-08-23'
    },
    {
      'id': '25250e2ead108a8f60213f240400248f',
      'name': 'ff',
      'label': 'FF',
      'head': false,
      'reversal': false,
      'required': false,
      'min': 0,
      'max': 10,
      'instance': '25250e2ead108a8f60213f2404006a4d',
      'regex': '',
      'order': 50,
      'subcategory': 'integer',
      'value': 900
    },
    {
      'id': 'b9ad37ea17a58d9be32160f393771cdd',
      'name': 'yer',
      'label': 'Yer',
      'head': true,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '25250e2ead108a8f60213f240400717c',
      'regex': '',
      'order': 50,
      'subcategory': 'boolean',
      'value': false
    }]
  }],
  'created_at_': 'Tue Aug 23 2011 22:03:24 GMT-0500 (CDT)',
  'created_by_': 'admin'
};
var simple_doc3 = {
  '_id': '25250e2ead108a8f60213f2404007c91',
  '_rev': '1-6ec90301ac115fed382a77207e81a9ca',
  'doctype': 'bim',
  'description': '',
  'deleted_': true,
  'fieldsets': [{
    'id': 'b9ad37ea17a58d9be32160f393770e5d',
    'multiple': false,
    'collapse': false,
    'name': 'hip',
    'label': 'Hip',
    'order': 50,
    'fields': [{
      'id': '25250e2ead108a8f60213f24040007e4',
      'name': 'caltest',
      'label': 'CalTest',
      'head': false,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '25250e2ead108a8f60213f2404005d38',
      'regex': '',
      'order': 50,
      'subcategory': 'date',
      'value': '1990-08-23'
    },
    {
      'id': '25250e2ead108a8f60213f240400248f',
      'name': 'ff',
      'label': 'FF',
      'head': false,
      'reversal': false,
      'required': false,
      'min': 0,
      'max': 10,
      'instance': '25250e2ead108a8f60213f2404006a4d',
      'regex': '',
      'order': 50,
      'subcategory': 'integer',
      'value': 900
    },
    {
      'id': 'b9ad37ea17a58d9be32160f393771cdd',
      'name': 'yer',
      'label': 'Yer',
      'head': true,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '25250e2ead108a8f60213f240400717c',
      'regex': '',
      'order': 50,
      'subcategory': 'boolean',
      'value': false
    }]
  }],
  'created_at_': 'Tue Aug 23 2011 22:03:24 GMT-0500 (CDT)',
  'created_by_': 'admin'
};
var simple_multifieldset_doc = {
  '_id': '68b6ef8471724e551c7428f8650367df',
  '_rev': '2-3013dd31a27379111586d03d06329bd2',
  'description': 'I\'m real sour on all this.',
  'doctype': 'Sour',
  'created_at_': 'Wed, 06 Feb 2013 02:47:16 GMT',
  'created_by_': 'admin',
  'updated_at_': 'Fri, 19 Apr 2013 03:30:21 GMT',
  'updated_by_': 'admin',
  'prev_': '1-efc065e8c0c85059dffc40b11aee111f',
  'deleted_': false,
  'fieldsets': [{
    'id': 'ddbcb7e9814be078df660ee6e9032e57',
    'multiple': true,
    'collapse': false,
    'name': 'climp',
    'label': 'Climp',
    'order': 50,
    'multifields': [{
      'fields': [{
        'id': '1a22914ae12176903f953c060294464f',
        'name': 'seven',
        'label': 'Seven',
        'head': true,
        'reversal': false,
        'required': false,
        'min': '',
        'max': '',
        'instance': '6cfbfe0501e6c8b947a4c2cc8941b2da',
        'charseq': null,
        'regex': '',
        'order': 50,
        'subcategory': 'text',
        'value': 'plan',
        'sortkey': ''
      }]
    }, {
      'fields': [{
        'id': '1a22914ae12176903f953c060294464f',
        'name': 'seven',
        'label': 'Seven',
        'head': true,
        'reversal': false,
        'required': false,
        'min': '',
        'max': '',
        'instance': '7d41ecb5b802930928313f9c95706296',
        'charseq': null,
        'regex': '',
        'order': 50,
        'subcategory': 'text',
        'value': 'fan',
        'sortkey': ''
      }]
    }]
  }, {
    'id': 'dfbc77b0972b3a9ed03602deb8f71122',
    'multiple': false,
    'collapse': false,
    'name': 'dimple',
    'label': 'Dimple',
    'order': 50,
    'fields': [{
      'id': 'ce2a7aa6cdf5ba6607761195f8ab5726',
      'name': 'nix',
      'label': 'Nix',
      'head': false,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '6a0b89d82acc684d00feb8b2db5b7f92',
      'charseq': null,
      'regex': '',
      'order': 50,
      'subcategory': 'text',
      'value': 'nerf',
      'sortkey': ''
    }]
  }],
  'index': {
    '1a22914ae12176903f953c060294464f': [
      ['', 'plan'],
      ['', 'fan']
    ],
    'ce2a7aa6cdf5ba6607761195f8ab5726': ['', 'nerf']
  },
  'changes': null,
  'head': ['1a22914ae12176903f953c060294464f'],
  'reverse': []
};
var simple_multifieldset_doc2 = {
  '_id': '68b6ef8471724e551c7428f8650367df',
  '_rev': '2-3013dd31a27379111586d03d06329bd2',
  'description': 'I\'m real sour on all this.',
  'doctype': 'Sour',
  'created_at_': 'Wed, 06 Feb 2013 02:47:16 GMT',
  'created_by_': 'admin',
  'updated_at_': 'Fri, 19 Apr 2013 03:30:21 GMT',
  'updated_by_': 'admin',
  'prev_': '1-efc065e8c0c85059dffc40b11aee111f',
  'deleted_': false,
  'fieldsets': [{
    'id': 'ddbcb7e9814be078df660ee6e9032e57',
    'multiple': true,
    'collapse': false,
    'name': 'climp',
    'label': 'Climp',
    'order': 50,
    'multifields': [{
      'fields': [{
        'id': '1a22914ae12176903f953c060294464f',
        'name': 'seven',
        'label': 'Seven',
        'head': true,
        'reversal': false,
        'required': false,
        'min': '',
        'max': '',
        'instance': '6cfbfe0501e6c8b947a4c2cc8941b2da',
        'charseq': null,
        'regex': '',
        'order': 50,
        'subcategory': 'text',
        'value': 'hand',
        'sortkey': ''
      }]
    }, {
      'fields': [{
        'id': '1a22914ae12176903f953c060294464f',
        'name': 'seven',
        'label': 'Seven',
        'head': true,
        'reversal': false,
        'required': false,
        'min': '',
        'max': '',
        'instance': '7d41ecb5b802930928313f9c95706296',
        'charseq': null,
        'regex': '',
        'order': 50,
        'subcategory': 'text',
        'value': 'fan',
        'sortkey': ''
      }]
    }]
  }, {
    'id': 'dfbc77b0972b3a9ed03602deb8f71122',
    'multiple': false,
    'collapse': false,
    'name': 'dimple',
    'label': 'Dimple',
    'order': 50,
    'fields': [{
      'id': 'ce2a7aa6cdf5ba6607761195f8ab5726',
      'name': 'nix',
      'label': 'Nix',
      'head': false,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '6a0b89d82acc684d00feb8b2db5b7f92',
      'charseq': null,
      'regex': '',
      'order': 50,
      'subcategory': 'text',
      'value': 'ballon',
      'sortkey': ''
    }]
  }],
  'index': {
    '1a22914ae12176903f953c060294464f': [
      ['', 'plan'],
      ['', 'fan']
    ],
    'ce2a7aa6cdf5ba6607761195f8ab5726': ['', 'nerf']
  },
  'changes': null,
  'head': ['1a22914ae12176903f953c060294464f'],
  'reverse': []
};
var simple_multifieldset_doc3 = {
  '_id': '68b6ef8471724e551c7428f8650367df',
  '_rev': '2-3013dd31a27379111586d03d06329bd2',
  'description': 'I\'m real sour on all this.',
  'doctype': 'Sour',
  'created_at_': 'Wed, 06 Feb 2013 02:47:16 GMT',
  'created_by_': 'admin',
  'updated_at_': 'Fri, 19 Apr 2013 03:30:21 GMT',
  'updated_by_': 'admin',
  'prev_': '1-efc065e8c0c85059dffc40b11aee111f',
  'deleted_': false,
  'fieldsets': [{
    'id': 'ddbcb7e9814be078df660ee6e9032e57',
    'multiple': true,
    'collapse': false,
    'name': 'climp',
    'label': 'Climp',
    'order': 50,
    'multifields': [{
      'fields': [{
        'id': '1a22914ae12176903f953c060294464f',
        'name': 'seven',
        'label': 'Seven',
        'head': true,
        'reversal': false,
        'required': false,
        'min': '',
        'max': '',
        'instance': '7d41ecb5b802930928313f9c95706296',
        'charseq': null,
        'regex': '',
        'order': 50,
        'subcategory': 'text',
        'value': 'fan',
        'sortkey': ''
      }]
    }]
  }, {
    'id': 'dfbc77b0972b3a9ed03602deb8f71122',
    'multiple': false,
    'collapse': false,
    'name': 'dimple',
    'label': 'Dimple',
    'order': 50,
    'fields': [{
      'id': 'ce2a7aa6cdf5ba6607761195f8ab5726',
      'name': 'nix',
      'label': 'Nix',
      'head': false,
      'reversal': false,
      'required': false,
      'min': '',
      'max': '',
      'instance': '6a0b89d82acc684d00feb8b2db5b7f92',
      'charseq': null,
      'regex': '',
      'order': 50,
      'subcategory': 'text',
      'value': 'ballon',
      'sortkey': ''
    }]
  }],
  'index': {
    '1a22914ae12176903f953c060294464f': [
      ['', 'plan'],
      ['', 'fan']
    ],
    'ce2a7aa6cdf5ba6607761195f8ab5726': ['', 'nerf']
  },
  'changes': null,
  'head': ['1a22914ae12176903f953c060294464f'],
  'reverse': []
};

// Avoid having to clutter the global name space and get lint complaints
Object.prototype.testEnv = true;

// This is because v8 doesn't have it
Array.concat = function(x, y) {
  return x.concat(y);
};

var identity = function(value) {
  'use strict';

  return value;
};

var fromFieldset = function(fieldset, mapfun) {
  'use strict';

  var map = function(fields) {
    return fields.map(function(x) {
      return mapfun(x, fieldset);
    });
  };

  if (fieldset.multiple) {
    return fieldset.multifields.reduce(function(acc, multifield) {
      return Array.concat(acc, map(multifield.fields));
    }, []);
  } else {
    return map(fieldset.fields);
  }
};

var fromFieldsetsMapFold = function(fieldsets, mapfun, foldfun, init) {
  'use strict';

  if (init === undefined) {
    init = [];
  }
  return fieldsets.reduce(function(acc, fieldset) {
    return foldfun(acc, fromFieldset(fieldset, mapfun), fieldset);
  }, init);
};

var fromFieldsets = function(fieldsets) {
  'use strict';

  return fromFieldsetsMapFold(fieldsets, identity, function(acc, fields) {
    return Array.concat(acc, fields);
  });
};

var fromFieldsetsFold = function(fieldsets, foldfun, init) {
  'use strict';

  return fromFieldsetsMapFold(fieldsets, identity, foldfun, init);
};

var fromFieldsetsMap = function(fieldsets, mapfun) {
  'use strict';

  return fromFieldsetsMapFold(fieldsets, mapfun, function(acc, fields) {
    return Array.concat(acc, fields);
  });
};

exports.fromFieldsetsMapFold = fromFieldsetsMapFold;
exports.fromFieldsets = fromFieldsets;
exports.fromFieldsetsFold = fromFieldsetsFold;
exports.fromFieldsetsMap = fromFieldsetsMap;
var get_head_values = function(d) {
  'use strict';

  return d['head'].map(function(x) {
    var h = d.index[x];
    if (typeof h[0] === 'string') {
      return [JSON.stringify(h[1])];
    } else {
      return h.map(function(y) {
        return [JSON.stringify(y[1])];
      });
    }
  });
};

var stamp = function(newDoc, doc, req) {
  'use strict';

  var now = (new Date()).toUTCString();
  var message = {
    document_id: newDoc._id,
    doctype: newDoc.doctype,
    changes: newDoc.changes
  };

  if (newDoc.head) {
    message.head_ids = newDoc.head;
    message.head_values = get_head_values(newDoc);
  }

  if (!doc) {
    if (newDoc._id) {
      newDoc.created_at_ = now;
      newDoc.created_by_ = req.userCtx.name;
      message.timestamp = newDoc.created_at_;
      message.user = newDoc.created_by_;
    } else {
      newDoc = null;
      message = 'This application expects the document _id in the JSON body';
    }
  } else {
    newDoc.updated_at_ = now;
    newDoc.updated_by_ = req.userCtx.name;
    newDoc.created_at_ = doc.created_at_;
    newDoc.created_by_ = doc.created_by_;
    message.timestamp = newDoc.updated_at_;
    message.user = newDoc.updated_by_;
    newDoc.prev_ = doc._rev;
  }

  return {
    doc: newDoc,
    message: message
  };
};

var get_changes = function(newDoc, doc) {
  'use strict';

  // This function is not implemented as efficiently as it could be but
  // I am more concerned with clarity at this point.
  var foldFields;
  var changes = {};

  if (doc) {
    if (Object.testEnv) {
      foldFields = Object.foldFields;
    } else {
      foldFields = require('lib/fields').fromFieldsetsFold;
    }

    var makeChangeObject = function(field, fieldset) {
      var obj = {
        fieldset: fieldset.id,
        fieldsetLabel: fieldset.label,
        fieldsetInstance: fieldset.instance ? fieldset.instance : null,
        field: field.id,
        fieldLabel: field.label
      };

      return obj;
    };
    var oldInstances = foldFields(doc.fieldsets, function(acc, fields, fieldset) {
      fields.forEach(function(field) {
        var obj = makeChangeObject(field, fieldset);
        obj.originalValue = JSON.stringify(field.value);
        acc[field.instance] = obj;
      });
      return acc;
    }, {});
    changes = foldFields(newDoc.fieldsets, function(acc, fields, fieldset) {
      fields.forEach(function(field) {
        var val = JSON.stringify(field.value);
        if (acc[field.instance] === undefined) {
          acc[field.instance] = makeChangeObject(field, fieldset);
          acc[field.instance]['newValue'] = val;
        } else if (acc[field.instance]['originalValue'] === val) {
          delete acc[field.instance];
        } else {
          acc[field.instance]['newValue'] = val;
        }
      });
      return acc;
    }, oldInstances);
  }

  if (Object.keys(changes).length === 0) {
    return null;
  } else {
    return changes;
  }
};

exports.get_changes = get_changes;
exports.stamp = stamp;

Object.prototype.foldFields = fromFieldsetsFold;

var should = require('should');

describe('CouchDB get_changes function', function() {
  describe('When making a single change', function() {
    var changes = get_changes(simple_doc2, simple_doc);
    it('should record it correctly', function() {
      changes['25250e2ead108a8f60213f2404006a4d'].newValue.should.equal('900');
      changes['25250e2ead108a8f60213f2404006a4d'].originalValue.should.equal('""');
    });
    it('should record it and only it', function() {
      Object.keys(changes).length.should.equal(1);
    });
    it('should contain the fieldset label', function() {
      changes['25250e2ead108a8f60213f2404006a4d'].fieldsetLabel.should.equal('Hip');
    });
    it('should have null for the fieldset instance if it doesn\'t exist', function() {
      should.strictEqual(changes['25250e2ead108a8f60213f2404006a4d'].fieldsetInstance, null);
    });
  });
  describe('When deleting and restoring', function() {
    var changes = get_changes(simple_doc3, simple_doc2);
    it('should changes should be null', function() {
      should.strictEqual(changes, null);
    });
  });
  describe('When making multiple changes', function() {
    var changes = get_changes(simple_multifieldset_doc2, simple_multifieldset_doc);
    it('should record them correctly', function() {
      changes['6cfbfe0501e6c8b947a4c2cc8941b2da'].newValue.should.equal('"hand"');
      changes['6cfbfe0501e6c8b947a4c2cc8941b2da'].originalValue.should.equal('"plan"');
      changes['6a0b89d82acc684d00feb8b2db5b7f92'].newValue.should.equal('"ballon"');
      changes['6a0b89d82acc684d00feb8b2db5b7f92'].originalValue.should.equal('"nerf"');
    });
  });
  describe('When removing a multifieldset field', function() {
    var changes = get_changes(simple_multifieldset_doc3, simple_multifieldset_doc2);
    it('should have an original but not new value', function() {
      should.not.exist(changes['6cfbfe0501e6c8b947a4c2cc8941b2da'].newValue);
      changes['6cfbfe0501e6c8b947a4c2cc8941b2da'].originalValue.should.equal('"hand"');
    });
  });
  describe('When adding a multifieldset field', function() {
    var changes = get_changes(simple_multifieldset_doc2, simple_multifieldset_doc3);
    it('should have an new but not original value', function() {
      should.not.exist(changes['6cfbfe0501e6c8b947a4c2cc8941b2da'].originalValue);
      changes['6cfbfe0501e6c8b947a4c2cc8941b2da'].newValue.should.equal('"hand"');
    });
  });
  describe('When creating a document', function() {
    var changes = get_changes(simple_multifieldset_doc2, null);
    it('should changes should be null', function() {
      should.strictEqual(changes, null);
    });
  });
});
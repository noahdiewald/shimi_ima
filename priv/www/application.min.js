/*! Dictionary Maker - v0.1.0 - 2012-11-25
* http://ling.wisc.edu/
* Copyright (c) 2012 UW Madison Board of Regents; Licensed GNU GPLv3 */
function initTabs(){return shimi.doctypeTab().init(),$("#main-tabs").tabs(),shimi.charseqTab().init(),!0}function initHelpText(){return $("#doctype-info").hide(),$("#charseq-info").hide(),$("#doctype-info-toggle").click(function(){return $("#doctype-info").toggle("blind",{},500),!1}),$("#charseq-info-toggle").click(function(){return $("#charseq-info").toggle("blind",{},500),!1}),!0}function fieldDialog(e,t){var n=shimi.fieldElems().get(t),r=$("#field-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.clearDisabled().getFieldInputVals(),i=function(t){shimi.doctypeTab().initFields(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.field,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r}function fieldElems(){var e={};return e.attrs=["name","label","order","description","subcategory","head","reversal","default","required","allowed","source","max","min","regex","doctype","fieldset","charseq","rev","field"],e.get=function(t){var n={};return n.attrs=e.attrs,n.notDefault=function(){return[n.charseq,n.allowed,n.source,n.min,n.max,n.regex]},n.disable=function(){return n.notDefault().forEach(function(e){e.attr("disabled","disabled")}),n},n.clearDisabled=function(){return n.notDefault().forEach(function(e){e.attr("disabled")&&e.val("")}),n},n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t]),n[t].is("input[type=checkbox]")&&e[t]==="true"&&n[t].attr("checked",!0)}),n},n.getFieldInputVals=function(){var e={category:"field",name:n.name.val(),label:n.label.val(),"default":n.decodeDefaults(n.subcategory.val(),n["default"].val()),head:n.head.is(":checked"),reversal:n.reversal.is(":checked"),required:n.required.is(":checked"),order:n.order.val()*1,allowed:n.allowed.val().split(",").trimAll(),source:n.decodeSource(n.subcategory.val(),n.source.val()),min:n.decodeBound(n.subcategory.val(),n.min.val()),max:n.decodeBound(n.subcategory.val(),n.max.val()),regex:n.regex.val(),description:n.description.val(),charseq:n.charseq.val(),doctype:n.doctype.val(),fieldset:n.fieldset.val(),subcategory:n.subcategory.val()};return e},n.clear=function(){return shimi.form().clear($("#field-dialog .input")).removeClass("ui-state-error"),n.disable(),n},n.decodeBound=function(e,t){return e==="date"?t:shimi.utils().stringToNumber(n.min.val())},n.decodeSource=function(e,t){return e==="file"?t.split("/").trimAll():t},n.decodeDefaults=function(e,t){switch(e){case"docmultiselect":case"multiselect":return t.split(",").trimAll();case"file":return t.split("/").trimAll();default:return t}},n.displayFields=function(e){switch(e){case"select":case"multiselect":n.disable(),n.allowed.removeAttr("disabled");break;case"docselect":case"docmultiselect":case"file":n.disable(),n.source.removeAttr("disabled");break;case"text":case"textarea":n.disable(),n.charseq.removeAttr("disabled"),n.regex.removeAttr("disabled");break;case"date":case"integer":case"rational":n.disable(),n.min.removeAttr("disabled"),n.max.removeAttr("disabled");break;default:n.disable()}},n.attrs.forEach(function(e){n[e]=$("#field-"+e+"-input")}),n.copyValues(t),n.displayFields(n.subcategory.val()),n.subcategory.change(function(){n.displayFields(n.subcategory.val())}),n},e}function fieldsetElems(){var e={};return e.attrs=["name","label","order","description","doctype","rev","multiple","collapse","fieldset"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t]),n[t].is("input[type=checkbox]")&&e[t]==="true"&&n[t].attr("checked",!0)}),n},n.getFieldsetInputVals=function(){var e={category:"fieldset",name:n.name.val(),label:n.label.val(),order:n.order.val()*1,description:n.description.val(),doctype:n.doctype.val(),multiple:n.multiple.is(":checked"),collapse:n.collapse.is(":checked")};return e},n.clear=function(){return shimi.form().clear($("#fieldset-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#fieldset-"+e+"-input")}),n.copyValues(t),n},e}function loadHash(e){return e&&shimi.vui({id:e}).get(),!1}String.prototype.parseQuoted=function(e){var t=e||"'",n=[],r=this.split(""),i=!1,s=0,o=[],u=function(){i&&s%2===0?++s:i&&s%2===1?(++s,o.push("'")):i||(i=!0)},a=function(){n.push(o.join("")),o=[],s=0,i=!1};return r.forEach(function(e){if(/'/.test(e))u();else if(s%2===1)a();else if(s%2===0){s=0;if(i)o.push(e);else if(/\S/.test(e))return!1}}),n.push(o.join("")),n},String.prototype.isBlank=function(){return/^\s*$/.test(this)&&!/\S/.test(this)&&this!==null},String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")},Array.prototype.trimAll=function(){return this.map(function(e){return e.trim()}).filter(function(e){return!e.match(/^$/)})};var uiToggle=function(){var e=function(e){var t;$(e.target).attr("data-target")&&(t=$("#"+$(e.target).attr("data-target")),t.toggle())};$(".toggler").live("click",function(t){e(t)})},panelToggle=function(){var e=function(e){var t;$(e.target).attr("data-panel")?t=$("#"+$(e.target).attr("data-panel")):t=$(e.target).closest(".panel"),t.toggle()};$("#panel-toggle li").live("click",function(t){e(t)}),$(".panel > h2").live("dblclick",function(t){e(t)})};$(function(){$(".notification").hide(),$("#loading").hide().ajaxStart(function(){$(this).show()}).ajaxStop(function(){$(this).hide()}),panelToggle(),uiToggle(),$(".remove-button").button({icons:{primary:"ui-icon-minus"},text:!1}).click(function(){$(this).parent().remove()}),$(".help-button").button({icons:{primary:"ui-icon-help"},text:!1}),$(".link-button").button({icons:{primary:"ui-icon-link"}}),$(".edit-button").button({icons:{primary:"ui-icon-pencil"}}),$(".create-continue-button").button({icons:{primary:"ui-icon-disk",secondary:"ui-icon-arrowthick-1-e"}}),shimi.form().initDateFields()}),shimi.utils=function(){var e={};return e.stringToNumber=function(e){return typeof e=="string"&&!isNaN(e)&&e!==""?e*1:""},e.isBlank=function(e){return/^\s*$/.test(e)||e===null||e===undefined||typeof e=="number"&&isNaN(e)||Object.prototype.toString.call(e)==="[object Array]"&&e.length===0},e.validID=function(e){return!!e.match(/^[a-f0-9]{32}$/)},e};var identity=function(e){return e};Function.prototype.r=function(){return[this,arguments]},Function.prototype.t=function(){var e=[this,arguments],t=arguments[arguments.length-1];while(e[0]!==t)e=e[0].apply(this,e[1]);return t.apply(this,e[1])},shimi.store=function(e){var t={};return t.get=function(t){var n=function(e,t,r){var i=t.attr("data-group-id"),s=$("#"+i),o=s.attr("data-"+e),u=s.attr("data-group-id");return o===undefined&&u!==undefined&&i!==u?n.r(e,s,r):r.r(o)};return n.t(t,e,identity)},t.put=function(t,n){var r=e.attr("data-group-id");$("#"+r).attr("data-"+t,n)},t.fs=function(e){return t.get("fieldset-"+e)},t.f=function(e){return t.get("field-"+e)},t.d=function(e){return t.get("document-"+e)},t},shimi.path=function(e,t,n){var r={},i;t?i=t+"-":i="",n?r.string=n+"/":r.string="",r.category=t,r.origin=e,r.type=i+"path",r.valid_components=["doctype","fieldset","field"];var s=shimi.store(r.origin);return r.valid_components.forEach(function(e){r[e]=function(){var t=s.get(i+e);return t}()}),r.rev=s.get(i+"rev"),r.doctype=s.get(i+"doctype"),r.send=function(e,t,n,i){return shimi.form().send(r.toString(),e,t,n,i),r},r.put=function(e,t,n){return r.send(e,"PUT",t,n),r},r.post=function(e,t,n){return r.send(e,"POST",t,n),r},r.del=function(e,t){return r.send({},"DELETE",e,t),r},r.toString=function(){var e,t=r.string.concat(r.valid_components.map(function(e){var t=e+"s",n=r[e],i=null;return n?i=t+"/"+n:e===r.category&&(i=t),i}).filter(function(e){return typeof e=="string"&&!e.isBlank()}).join("/"));return r.rev&&(t=t.concat("?rev="+r.rev)),t},r},function(e){function t(t){if(typeof t.data!="string")return;var n=t.handler,r=t.data.toLowerCase().split(" ");t.handler=function(t){var i=t.type!=="keypress"&&e.hotkeys.specialKeys[t.which],s=String.fromCharCode(t.which).toLowerCase(),o,u="",a={};t.altKey&&i!=="alt"&&(u+="alt+"),t.ctrlKey&&i!=="ctrl"&&(u+="ctrl+"),t.metaKey&&!t.ctrlKey&&i!=="meta"&&(u+="meta+"),t.shiftKey&&i!=="shift"&&(u+="shift+"),i?a[u+i]=!0:(a[u+s]=!0,a[u+e.hotkeys.shiftNums[s]]=!0,u==="shift+"&&(a[e.hotkeys.shiftNums[s]]=!0));for(var f=0,l=r.length;f<l;f++)if(a[r[f]])return n.apply(this,arguments)}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})}(jQuery),function(e){e.fn.inputDisable=function(){return this.val(""),this.attr("disabled","disabled"),this.addClass("ui-state-disabled"),this},e.fn.inputEnable=function(){return this.removeAttr("disabled"),this.removeClass("ui-state-disabled"),this}}(jQuery),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}),Array.prototype.reduce||(Array.prototype.reduce=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;if(n===0&&arguments.length===1)throw new TypeError;var r=0,i;if(arguments.length>=2)i=arguments[1];else do{if(r in t){i=t[r++];break}if(++r>=n)throw new TypeError}while(!0);while(r<n)r in t&&(i=e.call(undefined,i,t[r],r,t)),r++;return i}),shimi.dispatcher=function(e){var t=function(t){var n=$(t.target);Object.keys(e).forEach(function(t){if(n.is(t)){var r=e[t];r(n)}})};return t},shimi.clickDispatch=function(e){var t=shimi.doctypeTab,n=shimi.charseqTab,r=shimi.eui,i=shimi.vui,s=shimi.iiui,o=shimi.ieui,u=shimi.ipui,a=shimi.dispatcher({".edit-field-button span":function(e){t(e.parent("a")).editField()},".delete-field-button span":function(e){t(e.parent("a")).deleteField()},".add-field-button span":function(e){t(e.parent("a")).addField()},".edit-fieldset-button span":function(e){t(e.parent("a")).editFieldset()},".delete-fieldset-button span":function(e){t(e.parent("a")).deleteFieldset()},".add-fieldset-button span":function(e){t(e.parent("a")).addFieldset()},".delete-doctype-button span":function(e){t(e.parent("a")).deleteDoctype()},".edit-doctype-button span":function(e){t(e.parent("a")).editDoctype()},".touch-doctype-button span":function(e){t(e.parent("a")).touchDoctype()},"#doctype-add-button span":function(e){t(e.parent("a")).addDoctype()},".delete-charseq-button span":function(e){n(e.parent("a")).del()},".edit-charseq-button span":function(e){n(e.parent("a")).edit()},"#charseq-add-button span":function(e){n().add()},"#maintenance-upgrade-button span":function(e){shimi.upgradeButton(e.parent("a"))},".add-button span":function(e){r({target:e.parent()}).initFieldset()},".remove-button span":function(e){r({target:e.parent()}).removeFieldset()},"#save-document-button span":function(e){r({target:e.parent()}).save()},"#create-document-button span":function(e){r({target:e.parent()}).create()},"#clear-document-button span":function(e){r({target:e.parent()}).clear()},"#document-edit-button span":function(e){i({target:e.parent()}).edit()},"#document-delete-button span":function(e){i({target:e.parent()}).confirmDelete()},"#document-restore-button span":function(e){i({target:e.parent()}).confirmRestore()},"#document-view-tree > ul > li > b":function(e){i({target:e}).collapseToggle()},".revision-link":function(e){i({target:e}).fetchRevision()},".expander":function(e){r({target:e}).toggleTextarea()},"label span":function(e){r({target:e}).showHelpDialog()},"#new-index-button":function(e){o().newCond()},".remove-condition-button":function(e){o().remCond(e)},"#delete-index-button":function(e){o().del()},"#save-index-button":function(e){o().save()},"#replace-button":function(e){o().replace()},"#add-index-condition-button":function(e){o().addCond()}});a(e)},$(function(){$("body").click(function(e){shimi.clickDispatch(e)})}),shimi.index=function(e){var t={},n,r=shimi.state;t.url=e.url+"?",t.indexId=e.indexId,t.limitField=$("#index-limit"),t.limit=t.limitField.val()*1,t.target=e.target,t.state={},t.get=function(e,r,i,s){return n=JSON.stringify($("#index-filter").val()),t.state={sk:e,sid:r,pks:i,pids:s},t.state.pks||(t.state.sk=window.btoa(window.unescape(window.encodeURIComponent(n))),t.state.pks=[],t.state.pids=[]),t.state.sk&&(t.url=t.url+"&startkey="+window.escape(window.atob(t.state.sk)),t.state.sid&&(t.url=t.url+"&startkey_docid="+t.state.sid)),t.limit?t.url=t.url+"&limit="+(t.limit+1):(t.limitField.val(25),t.url=t.url+"&limit=26"),t.indexId&&(t.url=t.url+"&index="+t.indexId),shimi.form().send(t.url,!1,"GET",function(e,n){t.fill(n)},this),t},t.fill=function(e){return t.target.html(e.responseText),$("#previous-index-page").button({icons:{primary:"ui-icon-circle-arrow-w"}}).click(function(){t.get(r.pks.pop(),r.pids.pop(),r.pks,r.pids)}),$("#next-index-page").button({icons:{secondary:"ui-icon-circle-arrow-e"}}).click(function(e){var n=$(e).attr("data-startkey"),i=$(e).attr("data-startid"),s=$("#first-index-element").attr("data-first-key"),o=$("#first-index-element").attr("data-first-id");r.pks.push(s),r.pids.push(o),t.get(n,i,r.prevkeys,r.previds)}),r.pks.length===0&&$("#previous-index-page").button("disable"),$("#next-index-page").attr("data-last-page")&&$("#next-index-page").button("disable"),$("nav.pager").buttonset(),t}},shimi.charseqDialog=function(e){var t=shimi.charseqElems().get(e),n=$("#charseq-dialog").dialog({width:650,autoOpen:!1,modal:!0,buttons:{Save:function(){var n=t.getCharseqInputVals(),r="config/charseqs",i="POST",s=function(e){shimi.charseqTab().init(),$(e).dialog("close")};e.rev&&!e.rev.isBlank()&&(i="PUT",r="config/charseqs/"+n._id+"?rev="+n.rev),shimi.form().send(r,n,i,s,this)},Cancel:function(){$(this).dialog("close")}},close:function(){t.clear()}});return n},shimi.charseqElems=function(){var e={};return e.attrs=["description","characters","name","sort_ignore","locale","tailoring","vowels","consonants","ietf_tag","iso639_tag","charseq","rev"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t])}),n},n.getCharseqInputVals=function(){var e={category:"charseq",description:n.description.val(),characters:n.parse(n.characters.val()),name:n.name.val(),sort_ignore:n.parse(n.sort_ignore.val()),locale:n.locale.val(),tailoring:n.tailoring.val(),vowels:n.parse(n.vowels.val()),consonants:n.parse(n.consonants.val()),ietf_tag:n.ietf_tag.val(),iso639_tag:n.iso639_tag.val(),_id:n.charseq.val()||undefined,rev:n.rev.val()||undefined};return e},n.parse=function(e){return e&&!e.isBlank()?JSON.parse(e):[]},n.clear=function(){return shimi.form().clear($("#charseq-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#charseq-"+e+"-input")}),n.copyValues(t),n},e},shimi.chaseqTab=function(e){var t={};return t.add=function(){return $("#charseq-add-dialog").dialog("open"),t},t.edit=function(){var n={},r=shimi.charseqElems().attrs;return r.forEach(function(t){n[t]=shimi.store(e).get("charseq-"+t)}),shimi.charseqDialog(n).dialog("open"),t},t.del=function(){var n=shimi.store(e),r=n.get("charseq-charseq"),i=n.get("charseq-rev"),s="config/charseqs/"+r+"?rev="+i,o=function(){t.init()};return window.confirm("Are you sure? This is permanent.")&&shimi.form().send(s,{},"DELETE",o,this),t},t.init=function(){var e=$("#charseq-tabs"),n=$("#charseq-tabs-headings"),r="config/charseqs";return e.tabs(),$.get(r,function(t){n.empty(),n.find(".ui-tabs-panel").remove(),e.tabs("destroy"),n.html(t);var r=function(e,t){$(".link-button").button()};e.tabs({load:function(e,t){r(e,t)}})}),t},t},shimi.upgradeButton=function(e){$.post("config/upgrade"),window.alert("Upgrade In Progress")},$(function(){initTabs(),initHelpText(),$(".link-button").button(),$(".simple-tabs").tabs()}),shimi.doctypeDialog=function(e,t){var n=shimi.doctypeElems().get(t);t.rev&&!t.rev.isBlank()&&n.doctype.attr("disabled","disabled");var r=$("#doctype-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.getDoctypeInputVals(),i=function(e){shimi.doctypeTab().init(),$(e).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.doctype,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r},shimi.doctypeElems=function(){var e={};return e.attrs=["description","doctype","rev"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t])}),n},n.getDoctypeInputVals=function(){var e={category:"doctype",description:n.description.val(),_id:n.doctype.val()};return e},n.clear=function(){return shimi.form().clear($("#doctype-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#doctype-"+e+"-input")}),n.copyValues(t),n},e},shimi.doctypeTab=function(e){var t={},n=function(e){e.field=!1,$.get(e.toString(),function(t){var n=$("#fields-"+e.fieldset);n.empty(),n.html(t),$(".link-button").button()})};t.initFieldsets=function(e){$.get(e.toString(),function(t){var n=$("#fieldsets-"+e.doctype);n.empty(),n.accordion("destroy"),n.html(t),$(".link-button").button(),n.accordion({autoHeight:!1,collapsible:!0,active:!1})})},t.init=function(){var e="config/doctypes";$("#doctype-tabs").tabs(),$.get(e,function(e){var n=$("#fieldset-doctype-input");$("#doctype-tabs-headings").empty(),$("#doctype-tabs-headings + .ui-tabs-panel").remove(),$("#doctype-tabs").tabs("destroy"),$("#doctype-tabs-headings").html(e),$(".link-button").button();var r=function(e,n){var r=$(n.panel).children("div[data-fieldset-doctype]"),i=shimi.path(r,"fieldset","config");t.initFieldsets(i)};$("#doctype-tabs").tabs({load:function(e,t){r(e,t)}})})};var r=function(e,t){return shimi.path(e,t,"config")};t.editField=function(){var t=r(e,"field"),n={},i=shimi.fieldElems().attrs,s="config/charseqs?as=options";$.get(s,function(r){$("#field-charseq-input").html(r),i.forEach(function(t){n[t]=shimi.store(e).get("field-"+t)}),shimi.fieldDialog(t,n).dialog("open")})},t.deleteField=function(){var t=window.confirm("Are you sure? This is permanent.");if(t){var i=r(e,"field"),s=function(){i.field=!1,i.rev=!1,n(i)};i.del(s,this)}},t.addField=function(){var t=r(e,"field"),n="config/charseqs?as=options";$.get(n,function(e){$("#field-charseq-input").html(e),shimi.fieldDialog(t,{fieldset:t.fieldset,doctype:t.doctype}).dialog("open")})},t.editFieldset=function(){var t=r(e,"fieldset"),n={},i=shimi.fieldsetElems().attrs;i.forEach(function(t){n[t]=shimi.store(e).get("fieldset-"+t)}),shimi.fieldsetDialog(t,n).dialog("open")},t.deleteFieldset=function(){var n=r(e,"fieldset"),i=function(){n.fieldset=!1,n.rev=!1,t.initFieldsets(n)};window.confirm("Are you sure? This is permanent.")&&n.del(i,this)},t.addFieldset=function(){var t=r(e,"fieldset");shimi.fieldsetDialog(t,{doctype:t.doctype}).dialog("open")};var i=function(){var t=r(e,"doctype"),n={},i=shimi.doctypeElems().attrs;i.forEach(function(t){n[t]=shimi.store(e).get("doctype-"+t)}),shimi.doctypeDialog(t,n).dialog("open")};return t.touchDoctype=function(){var t=shimi.store(e).get("doctype-doctype");$.post("config/doctypes/"+t+"/touch"),window.alert("Touch In Progress")},t.deleteDoctype=function(){var n=r(e,"doctype"),i=function(){n.doctype=!1,n.rev=!1,t.initDoctypeTabs()};window.confirm("Are you sure? This is permanent.")&&n.del(i,this)},t.addDoctype=function(){var t=r(e,"doctype");shimi.doctypeDialog(t,{}).dialog("open")},t},shimi.fieldsetDialog=function(e,t){var n=shimi.fieldsetElems().get(t),r=$("#fieldset-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.getFieldsetInputVals(),i=function(t){e.fieldset=!1,e.rev=!1,shimi.doctypeTab().initFieldsets(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.fieldset,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r};var searchAllFieldsSwitch=function(){$("#search-all-fields-switch a").live("click",function(){shimi.sui.clearSearchVals()})},searchFieldItems=function(){$(".search-field-item").live("click",function(e){shimi.sui.removeSearchField(e)})},fieldViews=function(){$(".search-result-field-id a, .field-view b, .field-container label span").live("dblclick",function(e){shimi.sui.addSearchField(e)})},searchIndex=function(){$("#index-index-input-label").live("dblclick",function(e){shimi.sui.addSearchIndex(e)})},excludeCheck=function(){$("#document-search-exclude").live("change",function(e){shimi.sui.toggleExclusion(e)})},loadDocument=function(e){$("#document-view").html("<em>Loading...</em>"),shimi.eui().clear(),shimi.vui({id:e}).get()},jumpForm=function(){$("#view-jump-id").live("keydown",function(e){if(e.which===13){var t=$("#view-jump-id").val();loadDocument(t)}return!0})},documentLinks=function(){$(".view-document-link").live("click",function(){loadDocument(this.hash.slice(1))})},searchForm=function(){shimi.sui.clearSearchVals(!0).loadSearchVals(),searchAllFieldsSwitch(),searchFieldItems(),fieldViews(),excludeCheck(),searchIndex(),$("#document-search-term").live("keydown",function(e){return e.which===13?(shimi.sui.getSearch(),!1):!0})};$(function(){var e;documentLinks(),shimi.iui().iOpts().get(),jumpForm(),searchForm(),shimi.eui().init(),$("#index-filter-form input").keyup(function(){clearTimeout(e),e=setTimeout(function(){shimi.iui().get()},500)}),$("#index-filter-form select").change(function(){shimi.iui().get()}),loadHash($(location)[0].hash.split("#")[1])}),shimi.efs=function(){var e={},t=shimi.store,n=shimi.eui(),r=shimi.utils(),i=function(e){return $("#container-"+e)},s=function(e,t){var n=shimi.path(e,t);return n.doctype=!1,n},o=function(e,t,n){var r=null;r=localStorage.getItem(e),r?t(r):$.get(e,n)},u=function(e,n){e=e.children(".field-container").children(".field");var r={fields:[]};return e.each(function(e,i){i=$(i);var s=t(i);r.fields[e]={id:s.f("field"),name:s.f("name"),label:s.f("label"),head:s.f("head")==="true",reversal:s.f("reversal")==="true",required:s.f("required")==="true",min:a(s.f("subcategory"),s.f("min")),max:a(s.f("subcategory"),s.f("max")),instance:s.f("instance"),charseq:s.f("charseq"),regex:s.f("regex"),order:s.f("order")*1,subcategory:s.f("subcategory"),value:p(i)},n>=0&&(r.fields[e].index=n)}),r},a=function(e,t){return e==="date"?t:r.stringToNumber(t)},f=function(e){switch(e){case"true":e=!0;break;case"false":e=!1;break;default:e=null}return e},l=function(e){return r.isBlank(e)?e="":isNaN(e)||(e*=1),e},c=function(e){return e?e=e.map(function(e){return h(e)}):e=null,e},h=function(e){return window.decodeURIComponent(e.replace(/\+/g," "))},p=function(e){var n;switch(t(e).f("subcategory")){case"boolean":n=e.is("input:checkbox:checked");break;case"openboolean":n=f(e.val());break;case"integer":case"rational":n=l(e.val());break;case"multiselect":case"docmultiselect":n=c(e.val());break;case"select":case"docselect":n=h(e.val());break;default:n=e.val()}return n},d=function(e,n,r){var i=s($(e),"fieldset").toString(),u=t($(e)).fs("fieldset"),a=$("#container-"+u),f=function(e){a.append(e),v(a,n,r)},l=function(e){localStorage.setItem(i,e),f(e)};return r&&localStorage.removeItem(i),o(i.toString(),f,l),!1},v=function(e,t,r){var i=s(e,"field"),u=e.children(".fields").last(),a=function(e){u.prepend(e),t&&t(u),n.afterFreshRefresh()},f=function(e){localStorage.setItem(i,e),a(e)};return r&&localStorage.removeItem(i),o(i.toString(),a,f),!0},m=function(e){e=$(e);var n=t(e).fs("fieldset"),r=$("#container-"+n),i=s(e,"fieldset");r.html(""),e.find(".multifield").each(function(e,t){d(r,function(e){y($(t),e)})})},g=function(e){y($(e))},y=function(e,t){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),$("#save-document-button").removeAttr("disabled"),e.find(".field-view").each(function(e,n){var r=$(n).attr("data-field-value"),i=$(n).attr("data-field-field");t||(t=$("body")),b(t.find(".field[data-field-field="+i+"]"),r)})},b=function(e,t){e.is("input.boolean")?e.attr("checked",t==="true"):t&&e.is("select.multiselect")?e.val(t.split(",")):t&&(e.is("input.text")||e.is("select.file"))?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.is("textarea.textarea")?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.val(t)};return e.fieldsetsToObject=function(e){var n={fieldsets:[]};return e.find("fieldset").each(function(e,r){r=$(r);var s=t(r),o,a={id:s.fs("fieldset"),multiple:s.fs("multiple")==="true",collapse:s.fs("collapse")==="true",name:s.fs("name"),label:s.fs("label"),order:s.fs("order")*1};o=i(a.id).children(".fields"),a.multiple?(a.multifields=[],o.each(function(e,t){t=$(t),a.multifields[e]=u(t,e)})):$.extend(a,u(o.first())),n.fieldsets[e]=a}),n},e.initFieldsets=function(){var n,r=$("#create-document-button"),i=t(r),s=i.d("doctype"),o=s+"_version",u=localStorage.getItem(o),a=i.d("version");return n=u!==a,localStorage.setItem(o,a),$("fieldset").each(function(e,t){d(t,!1,n)}),e},e.fillFieldsets=function(){return $(".fieldset-view").each(function(e,n){t($(n)).fs("multiple")==="true"?m(n):g(n)}),n.afterEditRefresh(),e},e},shimi.eui=function(e){var t={},n=shimi.iui,r=shimi.vui,i=shimi.efs,s=shimi.store,o=shimi.flash;return t.priv={},t.target=e.target,t.rev=e.rev,t.id=e.id,t.saveButton=$("#save-document-button"),t.addButton=$(".add-button"),t.clearButton=$("#clear-document-button"),t.createButton=$("#create-document-button"),t.editButton=$("#document-edit-button"),t.removeButton=$(".remove-button"),t.init=function(){var e="documents/edit";return $.get(e,function(e){$("#document-edit").html(e),$("#edit-tabs").tabs(),t.priv.keyboard(),i().initFieldsets(),t.priv.buttons()}),t},t.priv.keyboard=function(){var e="input, select",n=$("#edit-tabs"),r=function(){var t=n.find(".ui-tabs-selected a").attr("href");$(t).find(e+", textarea").first().focus()};return $(document).bind("keydown","Alt+p",function(e){var t=n.tabs("length"),i=n.tabs("option","selected");return i!==0?(n.tabs("select",i-1),r()):(n.tabs("select",t-1),r()),!1}),$(document).bind("keydown","Alt+n",function(e){var t=n.tabs("length"),i=n.tabs("option","selected");return i<t-1?(n.tabs("select",i+1),r()):(n.tabs("select",0),r()),!1}),t},t.priv.buttons=function(){return t.addButton.button({icons:{primary:"ui-icon-plus"}}),t.saveButton.button({icons:{primary:"ui-icon-disk"}}),t.saveButton.hide(),t.saveButton.attr("disabled","disabled"),t.createButton.button({icons:{primary:"ui-icon-document"}}),t.clearButton.button({icons:{primary:"ui-icon-refresh"}}),t},t.priv.removeButton=function(){return t.removeButton.button({icons:{primary:"ui-icon-minus"}}),t},t.priv.validationError=function(e){var n=JSON.parse(e.responseText),r=e.statusText,i=$("[data-field-instance="+n.instance+"]"),s=$("[href=#"+i.parents("fieldset").attr("id")+"]").parent("li");return s.addClass("ui-state-error"),i.addClass("ui-state-error"),o(r,n.fieldname+" "+n.message).error(),t},t.priv.afterEditRefresh=function(){var e=["data-document-id","data-document-rev"];return e.forEach(function(e){t.saveButton.attr(e,t.editButton.attr(e))}),t.saveButton.show(),t.priv.afterRefresh(),t},t.afterFreshRefresh=function(){return t.priv.removeButton(),t.priv.afterRefresh(),t},t.priv.afterRefresh=function(){return t.priv.dateFields(),t.priv.instances(),t},t.priv.instances=function(){var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],n=function(){return e.map(function(){return e[Math.floor(Math.random()*e.length)]}).join("")};return $("[data-field-instance]").each(function(e,t){var r=n();$(t).first().attr("data-field-instance",r),$(t).first().attr("data-group-id",r),$(t).first().attr("id",r),$(t).first().next(".expander").attr("data-group-id",r),$(t).first().next().next(".expander").attr("data-group-id",r)}),t},t.resetFields=function(){return $(".field").each(function(e){var t=$(this),n=t.attr("data-field-default");n&&n!==""?t.is("select.multiselect")?t.val(n.split(",")):t.is("input.boolean")?t.attr("checked",n===!0):t.val(n):(t.val(""),t.removeAttr("checked"))}),t},t.save=function(){if(t.saveButton.hasClass("oldrev")&&!window.confirm("This data is from an older version of this document. Are you sure you want to restore it?"))return!1;var e,u,a=s(t.saveButton),f=$("#edit-document-form"),l=a.d("document"),c=a.d("rev"),h="./documents/"+l+"?rev="+c,p={doctype:a.d("doctype"),description:a.d("description")};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),t.saveButton.button("disable"),$.extend(p,i().fieldsetsToObject(f)),$.ajax({type:"PUT",url:h,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(p),complete:function(i,s){i.status===204||i.status===200?(u="Success",e="Your document was saved.",r({id:l}).get(),n().get(),o(u,e).highlight(),t.saveButton.removeClass("oldrev"),t.saveButton.button("enable")):i.status===403?(t.priv.validationError(i),t.saveButton.button("enable")):i.status===409&&(e=JSON.parse(i.responseText),u=i.statusText,o(u,e.message).error(),t.saveButton.button("enable"))}})},t.create=function(){var e=s(t.createButton),u=$("#edit-document-form"),a={doctype:e.d("doctype"),description:e.d("description")};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),t.createButton.button("disable"),$.extend(a,i().fieldsetsToObject(u));var f=$.ajax({type:"POST",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(a),complete:function(e,s){if(e.status===201){var u="Success",a="Your document was created.",l=f.getResponseHeader("Location").match(/[a-z0-9]*$/);t.saveButton.hide(),t.saveButton.attr("disabled","true"),$(".fields").remove(),i().initFieldsets(),r({id:l}).get(),n().get(),o(u,a).highlight(),t.createButton.button("enable")}else e.status===403&&(t.priv.validationError(e),t.createButton.button("enable"))}})},t.clear=function(){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),t.saveButton.hide(),t.saveButton.attr("disabled","disabled"),$(".fields").remove(),i().initFieldsets()},t.removeFieldset=function(){t.target.parent().remove()},t.showHelpDialog=function(){t.target.is(".label-text")&&(t.target=t.target.parent("label").find(".ui-icon-help")),$("#help-dialog").dialog().dialog("open").find("#help-dialog-text").html(t.target.attr("title"))},t.toggleTextarea=function(){var e=$("#"+t.target.attr("data-group-id"));e.toggleClass("expanded"),t.target.toggleClass("expanded")},t},shimi.iui=function(){var e={},t=shimi.vui,n=shimi.eui,r=shimi.store,i=shimi.flash,s=shimi.index;e.get=function(t,n,r,i){var o="documents/index",u=$("#index-index-input").val(),a=$("#index-listing");return s({url:o,indexId:u,target:a}).get(t,n,r,i),e},e.iOpts=function(){var t="/projects/project-"+$("#container").attr("data-project-id")+"/indexes?as=options";return $.get(t,function(e){$("#index-index-input").html(e)}),e}},shimi.sui=function(){var e={},t=shimi.utils(),n=window.localStorage,r=$("#document-search-index"),i=$("#document-search-term"),s=$("#document-search-field"),o=$("#document-search-exclude"),u=$("#search-listing"),a=function(){var e={};return $("fieldset").each(function(t,n){var r=$(n).attr("data-fieldset-label");$(n).find(".field-container").each(function(t,n){var i=$(n).attr("data-field-field"),s=$(n).find(".label-text").first().text();e[i]=r+": "+s})}),e},f=function(e){var t=n.getItem(e);return t===""||t==="null"?null:t},l=function(){var e=o.is(":checked");return e?e:null},c=function(e,t,r,i){return i?(n.setItem("searchIndex",i),n.setItem("searchIndexLabel",t),n.setItem("searchLabels",null),n.setItem("searchFields",null),n.setItem("searchExclude",null)):(n.setItem("searchIndex",null),n.setItem("searchIndexLabel",null),n.setItem("searchLabels",t),n.setItem("searchFields",e),n.setItem("searchExclude",r)),!0};e.getSearch=function(){var t=i.val(),n="documents/search?q="+window.encodeURIComponent(t),f=s.val(),l=o.is(":checked"),c=r.val(),h=a();return c?n=n+"&index="+c:(f&&(n=n+"&field="+f),l&&(n+="&exclude=true")),u.hide(),$.get(n,function(e){u.html(e),$(".search-result-field-id").each(function(e,t){var n=h[$(t).attr("data-field-field")],r=$(t).children("a").first();r.html(n),r.attr("data-search-label",n)}),$(".search-results th").each(function(e,n){var r=$.trim($(n).children("a").html()),i=new RegExp("("+t+")","g"),s=r.replace(i,"<span class='highlight'>$1</span>");$(n).children("a").html(s)}),u.show()}),e},e.toggleExclusion=function(t){var r=e.excludedVal(),i=$("#search-exclude-label");return r?i.show():i.hide(),n.setItem("searchExclude",r),e},e.clearSearchVals=function(t){return s.val(null),r.val(null),$("#document-search-exclude:checked").click(),$(".search-optional, #search-exclude-label").hide(),$(".search-field-item").remove(),$("#search-index-label").empty(),t||(n.setItem("searchLabels",null),n.setItem("searchFields",null),n.setItem("searchExclude",null),n.setItem("searchIndex",null),n.setItem("searchIndexLabel",null)),e},e.loadSearchVals=function(){var t=f("searchIndex"),i=f("searchFields");return t!==null?(r.val(t),$("#search-index-label").html(n.getItem("searchIndexLabel")),$(".search-optional").show(),o.parent("div").hide()):i!==null&&(s.val(i),$("#search-field-label").html(n.getItem("searchLabels")),f("searchExclude")!==e.excludedVal()&&o.click(),$(".search-optional").show()),e},e.removeSearchField=function(t){var n=$(t.target),r=n.attr("data-index"),i=s,o=i.val(),u=JSON.parse(o),a=e.excludedVal(),f=null;if(u.length===1)e.clearSearchVals();else{var l=u.indexOf(r);l>=0&&(u.splice(l,1),f=JSON.stringify(u),i.val(JSON.stringify(u))),n.remove()}return c(f,$("#search-field-label").html(),a),e},e.addSearchIndex=function(n){var i=$("#index-index-input").val(),u=$("option[value="+i+"]").text();return t.validID(i)&&($("#search-all-fields-switch").show(),$("#search-field-label").hide(),$("#search-exclude-label").empty(),s.val(null),o.parent("div").hide(),$("#search-index-label").html(u).show(),r.val(i),c(null,u,null,i)),e},e.addSearchField=function(n){var r=$(n.target).closest("[data-field-field]").attr("data-field-field");if(t.validID(r)){var i=a()[r],o=s,u=o.val(),f=$("#search-field-label"),l=e.excludedVal(),h,p=null,d='<a href="#" data-index="'+r+'" class="search-field-item" title="click to remove">'+i+"</a>",v=function(e){f.html()?f.children().last().after(d):f.html(d),p=JSON.stringify(e),o.val(p),c(p,f.html(),l)};if(u!==""){var m=JSON.parse(u);m.indexOf(r)<0&&(h=m.concat(r),v(h))}else h=[r],v(h);$(".search-optional").show()}return e}},shimi.vui=function(e){var t={},n=shimi.vui,r=shimi.iui,i=shimi.eui,s=shimi.efs(),o=shimi.store,u=shimi.flash;return t.target=e.target,t.rev=e.rev,t.id=e.id,t.formatTimestamps=function(){return $(".timestamp").each(function(e,t){var n=(new Date($(t).text())).toLocaleString();n!=="Invalid Date"&&$(t).text(n)}),t},t.rev=function(e){return t.rev=e,t},t.id=function(e){return t.id=e,t},t.target=function(e){return t.target=e,t},t.get=function(e){var n="documents/"+t.id,r=$("#document-view");return t.rev&&(n="documents/"+t.id+"/"+t.rev),r.hide(),$.get(n,function(n){r.html(n),t.formatTimestamps(),e&&e(),r.show();if(!t.rev){var i=$("#document-restore-button"),s=$("#document-edit-button"),u=$("#document-delete-button");s.button({icons:{primary:"ui-icon-pencil"}}),u.button({icons:{primary:"ui-icon-trash"}}),i.button({icons:{primary:"ui-icon-refresh"}}),o(i).d("deleted")==="true"?(s.hide(),u.hide()):i.hide()}}),t},t.restore=function(){var e="./documents/"+t.id+"?rev="+t.rev,n=$("#document-restore-button"),i,s;return $.ajax({type:"DELETE",url:e,dataType:"json",contentType:"application/json",complete:function(e,n){e.status===200?(s="Success",i="Your document was restored.",t.rev(null).get(function(){r().get()}),u(s,i).highlight()):e.status===409?(i=JSON.parse(e.responseText),s=e.statusText,u(s,i.message).error()):e.status===404&&(i="Document was erased and cannot be restored.",s=e.statusText,u(s,i).error())}}),t},t.del=function(){var e="./documents/"+t.id+"?rev="+t.rev,n=$("#document-restore-button"),i,s;return $.ajax({type:"DELETE",url:e,dataType:"json",contentType:"application/json",complete:function(e,t){if(e.status===200){s="Success",i="Your document was deleted.";var a=JSON.parse(e.responseText);o(n).put("document-rev",a.rev),$("#document-delete-button").hide(),$("#document-edit-button").hide(),n.show(),$("#document-view h2").text("Deleted Document"),$("#document-view").fadeTo("slow",.5),r().get(),u(s,i).highlight()}else e.status===409?(i=JSON.parse(e.responseText),s=e.statusText,u(s,i.message).error()):e.status===404&&(i="Document appears to have been deleted already.",s=e.statusText,u(s,i).error())}}),t},t.confirmIt=function(e){if(window.confirm("Are you sure?")){var n=o(t.target),r=n.d("document"),i=n.d("rev");e(r,i)}return t},t.edit=function(){return i().resetFields(),$("#document-view-tree").hasClass("oldrev")?$("#save-document-button").addClass("oldrev"):$("#save-document-button").removeClass("oldrev"),s.fillFieldsets(),t},t.confirmDelete=function(){return t.confirmIt(function(e,n){t.id(e).rev(n).del()})},t.confirmRestore=function(){return t.confirmIt(function(e,n){t.id(e).rev(n).restore()})},t.collapseToggle=function(){return t.target.parent("li").toggleClass("collapsed"),t},t.fetchRevision=function(){var e=o(t.target),r=e.d("document"),i=e.d("rev"),s=e.d("oldrev");return i!==s?$("#document-view-tree").addClass("oldrev"):$("#document-view-tree").removeClass("oldrev"),n({rev:s,id:r}).get(),t},t},$(function(){shimi.fm().refreshListings(),$("#file-upload-target").load(function(){var e=$("#file-upload-target").contents().find("body pre").html(),t=function(){return e&&e.length>0?JSON.parse(e):{message:!1}};t()&&t().message&&t().status==="error"?(shimi.flash("Error",t().message).error(),shimi.fm().refreshListings()):t().message&&(shimi.flash("Success",t().message).highlight(),shimi.fm().refreshListings())})}),shimi.fm=function(){var e={},t=function(t){t===undefined&&(t=""),$.get("file_manager/list_dirs/"+t,function(n){$("#file-paths").html(n),$(".dir").click(function(t){var n=$(t.target).attr("data-path");e.refreshListings(n)}),$("#up-dir").button().click(function(){var n=t.split("/");n.pop(),n=n.join("/"),e.refreshListings(n)}),$("#root-dir").button().click(function(){e.refreshListings()})})},n=function(e){e===undefined&&(e=""),$.get("file_manager/list_files/"+e,function(t){$("#file-listing").html(t),s(e)})},r=function(e){$(".edit-file-button").button({icons:{primary:"ui-icon-pencil"}}).click(function(t){var n=$(t.target).parent("a"),r=n.attr("data-file-id"),i="file_manager/"+r;$.getJSON(i,function(t){o(t,e).dialog("open")})})},i=function(t){$(".delete-file-button").button({icons:{primary:"ui-icon-trash"}}).click(function(n){var r=$(n.target).parent("a"),i=r.attr("data-file-id"),s=r.attr("data-file-rev"),o="file_manager/"+i+"?rev="+s,u=function(){e.refreshListings(t),shimi.flash("Success","File Deleted").highlight()};shimi.form().send(o,null,"DELETE",u,r)})},s=function(e){r(),i()},o=function(t,n){var r=$("#file-path-input");t.path?r.val(t.path.join("/")):r.val("");var i=$("#edit-path-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Move:function(){var s="file_manager/"+t._id+"?rev="+t._rev,o=function(){e.refreshListings(n),shimi.flash("Success","File Moved").highlight()};t.path=r.val().replace(/^\s*|\s*$/g,"").replace(/\/+/g,"/").replace(/^\/|\/$/g,"").split("/"),shimi.form().send(s,t,"PUT",o,i),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return i};return e.refreshListings=function(e){t(e),n(e)},e},shimi.initIndexBuilderDialog=function(e){var t=$("#builder-or-input"),n=$("#builder-paren-input"),r=$("#builder-negate-input"),i=$("#builder-operator-input").inputDisable(),s=$("#builder-argument-input").inputDisable(),o=$("#builder-fieldset-input").inputDisable(),u=$("#builder-field-input").inputDisable(),a=[i,o,u],f="doctypes/"+e+"/fieldsets",l="indexes/condition",c=shimi.ihelpers().evs;$(".ui-helper-reset div").show();var h=function(e){var t=$("#index-conditions-listing tbody");return t.append(e),t.sortable(),shimi.eiui().initCondButtons(t),!1};shimi.ihelper().fOpts(f,o,function(){o.inputEnable()}),t.change(function(){t.is(":checked")?($("#builder-conditions").hide(),$("#builder-parens").hide()):($("#builder-conditions").show(),$("#builder-parens").show())}),n.change(function(){n.val()?($("#builder-or").hide(),$("#builder-conditions").hide()):($("#builder-or").show(),$("#builder-conditions").show())});var p=function(){c.setIndexFieldsetEvents(e,o,u,function(){return i.inputDisable(),u.inputDisable(),s.inputDisable(),function(){u.inputEnable()}})},d=function(){c.setIndexFieldEvents(e,o,u,function(){return i.inputDisable(),s.inputDisable(),function(){i.inputEnable()}})},v=function(){c.setIndexOperatorEvents(s,i,u,function(){return s.inputDisable(),function(){s.inputEnable()}})},m=$("#index-builder-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var e=!0;!t.is(":checked")&&!n.val()&&a.forEach(function(t){t.val().isBlank()?(t.addClass("ui-state-error"),e=!1):t.removeClass("ui-state-error")}),e&&(t.is(":checked")?$.get(l,{is_or:!0},function(e){h(e)}):n.val()?$.get(l,{is_or:!1,parens:n.val(),negate:!1},function(e){h(e)}):$.get(l,{is_or:!1,parens:!1,negate:r.is(":checked"),fieldset:o.val(),field:u.val(),operator:i.val(),argument:s.val()},function(e){h(e)}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){$("#builder-conditions").show(),o.unbind("change"),u.unbind("change"),i.unbind("change"),shimi.form().clear($(".input")).removeClass("ui-state-error")}});return p(),d(),v(),m},shimi.ieui=function(){var e={},t=$("#new-index-button"),n=$("#delete-index-button"),r=$("#save-index-button"),i=$("#add-index-condition-button"),s=$("#replace-button"),o=$("#index-conditions-listing tbody"),u=$("#button-bar"),a=function(){return $("#index-editing-data")},f=function(e,t,n){switch(t){case"integer":case"rational":e*=1}switch(n){case"hasExactly":case"hasGreater":case"hasLess":e=Math.floor(e*1)}return e},l=function(e,t){var n=t.map(function(t,n){n=$(n);var r=n.find("td.or-condition").attr("data-value")==="true",i=n.find("td.paren-condition").attr("data-value"),s;if(r)s={is_or:!0,parens:!1};else if(i)s={is_or:!1,parens:i};else{var o=n.find("td.field-condition").attr("data-value"),u=n.find("td.fieldset-condition").attr("data-value"),a=n.find("td.argument-condition").attr("data-value"),l=shimi.ihelpers().getFieldDoc(o,u,e),c=n.find("td.negate-condition").attr("data-value")==="true",h=n.find("td.operator-condition").attr("data-value");a=f(a,l.subcategory,h),s={is_or:!1,parens:!1,negate:c,fieldset:u,field:o,operator:h,argument:a}}return s}).toArray();return n},c=function(e,t){var n=e.attr("data-index-id"),r=e.attr("data-index-rev"),i="indexes/"+n+"?rev="+r,s=e.attr("data-index-doctype"),o={_id:n,category:"index",doctype:s,show_deleted:e.attr("data-index-show_deleted")==="true",fields:JSON.parse(e.attr("data-index-fields")),fields_label:JSON.parse(e.attr("data-index-fields_label")),name:e.attr("data-index-name"),conditions:l(s,$("#index-conditions-listing tbody tr"))};return e.attr("data-index-replace_function")&&(o.replace_function=e.attr("data-index-replace_function")),shimi.form().send(i,o,"PUT",t,this),!1},h=function(e,t,n,r){var i="indexes/"+e+"?rev="+t,s,o;return $.ajax({type:"DELETE",url:i,dataType:"json",contentType:"application/json",complete:function(e,t){e.status===204?(s="Success",o=n,r(),shimi.flash(s,o).highlight()):e.status===409?(o=JSON.parse(e.responseText),s=e.statusText,shimi.flash(s,o.message).error()):e.status===404&&(o="Index appears to have been deleted already.",s=e.statusText,shimi.flash(s,o).error())}}),!1};return e.initButtons=function(){return t.button({icons:{primary:"ui-icon-plus"}}),n.button({icons:{primary:"ui-icon-trash"}}),r.button({icons:{primary:"ui-icon-document"}}),i.button({icons:{primary:"ui-icon-plus"}}),s.button({icons:{primary:"ui-icon-shuffle"}}),u.buttonset(),e},e.initCondButtons=function(){return o.find(".remove-condition-button").button({icons:{primary:"ui-icon-minus"}}),e},e.init=function(t){var n="indexes/"+t,r=$("#index-conditions");return $.get(n,function(t){r.html(t),o.sortable(),e.initCondButtons(),shimi.piui().get()}),!1},e.save=function(){var t=a();if(t.length!==0){var n=function(){e.init(t.attr("data-index-id")),shimi.flash("Success","Your index has been saved.").highlight()};c(t,n)}else shimi.flash("Info","No index has been chosen to save.").highlight()},e.replace=function(){var t=a();return t.length!==0?shimi.initReplaceDialog().dialog("open"):shimi.flash("Info","You must choose an index first.").highlight(),e},e.addCond=function(){var t=a();return t.length!==0?shimi.initIndexBuilderDialog(t.attr("data-index-doctype")).dialog("open"):shimi.flash("Info","You must choose an index first.").highlight(),e},e.remCond=function(t){return $(t).closest("tr").remove(),e},e.newCond=function(){return shimi.initIndexNewDialog().dialog("open"),e},e.del=function(){var t=a();if(t.length!==0){var n=t.attr("data-index-id"),r=t.attr("data-index-rev"),i="Your index has been deleted.",s=function(){$("#index-conditions").empty(),shimi.iiui().init()};window.confirm("Are you sure?")&&h(n,r,i,s)}else shimi.flash("Info","No index has been chosen to delete.").highlight();return e},e},shimi.ihelpers=function(){var e={},t=shimi.sess();e.evs={};var n=function(e,t){return e.children().show(),t.forEach(function(t){e.children("option:contains("+t+")").hide()}),!1},r=function(e){var t=$("#builder-operator-input");switch(e.subcategory){case"select":case"docselect":case"text":case"textarea":n(t,["member","true"]);break;case"integer":case"rational":case"date":n(t,["member","true","match"]);break;case"boolean":case"openboolean":n(t,["equal","greater","less","member","match"]);break;case"multiselect":case"docmultiselect":n(t,["equal","greater","less","true","match"])}return!1};return e.alterArg=function(n,r,i,o){var u=function(){return t.get(i.val())};o(),n.removeAttr("disabled").datepicker("destroy"),n.removeAttr("disabled").autocomplete("destroy");var a=function(t,n){return n.subcategory==="date"?(t.removeAttr("disabled"),t.datepicker({dateFormat:"yy-mm-dd"})):(t.removeAttr("disabled"),t.autocomplete({source:n.allowed})),e},f=u();if(f)switch(r.val()){case"true":case"isDefined":case"blank":n.attr("disabled","disabled").val("");break;case"equal":case"member":case"greater":case"less":case"hasExactly":case"hasGreater":case"hasLess":a(n,f)}return e},e.alterOpts=function(t,n,i){return r(t),i(),e},e.fOpts=function(t,n,r){return $.get(t,function(e){n.html(e),r&&r()}),e},e.getFieldDoc=function(e,n,r,i){var o=t.get(e),u="doctypes/"+r+"/fieldsets/"+n+"/fields/"+e+"?format=json";return o?(i&&i(o),o):($.ajax({url:u,async:!1,dataType:"json",success:function(n){t.put(n),i&&i(t.get(e))}}),t.get(e))},e.evs.setIndexDoctypeEvents=function(t,n,r){return t.change(function(){var i="doctypes/"+t.val()+"/fieldsets",s;r&&(s=r()),e.fOpts(i,n,s)}),!1},e.evs.setIndexFieldsetEvents=function(t,n,r,i){return n.change(function(){var s;typeof t!="string"&&(t=t.val());if(n.val()){var o="doctypes/"+t+"/fieldsets/"+n.val()+"/fields?as=options";i&&(s=i()),e.fOpts(o,r,s)}}),e},e.evs.setIndexFieldEvents=function(t,n,r,i){return r.change(function(){var s=r.val(),o=n.val(),u;i&&(u=i()),s.isBlank()||e.getFieldDoc(s,o,t,function(e){shimi.ihelpers().alterOpts(e,s,u)})}),e},e.evs.setIndexOperatorEvents=function(t,n,r,i){return n.change(function(){var s;i&&(s=i()),e.alterArg(t,n,r,s)}),e},e},shimi.iiui=function(){var e={};return e.init=function(){var t="indexes",n=$("#index-index-listing");return $.get(t,function(e){n.html(e),n.click(function(e){shimi.eiui().init($(e.target).attr("data-index-id"))})}),e},e},$(function(){$("#index-builder-dialog").hide(),$("#index-new-dialog").hide(),$("#index-replace-dialog").hide(),shimi.eiui.initButtons(),shimi.iiui().init()}),shimi.piui=function(){var e={},t=shimi.index;return e.get=function(n,r,i,s){var o="documents/index",u=$("#index-editing-data").attr("data-index-id"),a=$("#index-list-view"),f=$("#index-filter-form input");return t({url:e.url,indexId:u,target:a}).get(n,r,i,s),f.keyup(function(){e.get()}),e},e},shimi.initIndexNewDialog=function(){var e=$("#index-doctype-input"),t=$("#index-fieldset-input").inputDisable(),n=$("#index-field-input").inputDisable(),r=$("#index-name-input"),i=$("#index-show_deleted-input"),s=shimi.ihelpers().evs,o=function(){s.setIndexDoctypeEvents(e,t,function(){return t.inputDisable(),n.inputDisable(),function(){t.inputEnable()}})},u=function(){s.setIndexFieldsetEvents(e,t,n,function(){return n.inputDisable(),function(){n.inputEnable()}})},a=function(e){return $('#index-new-dialog option[value="'+e+'"]').text()},f=function(){return[a(t.val()),a(n.val())].join(":")},l=$("#index-new-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var t=!0;if(t){var s={category:"index",name:r.val(),show_deleted:i.is(":checked"),conditions:[],doctype:e.val(),fields_label:[f()],fields:[n.val()]},o=function(e){shimi.iiui().init(),$(e).dialog("close")};shimi.form().send("indexes",s,"POST",o,this)}},Cancel:function(){$(this).dialog("close")}},close:function(){t.unbind("change"),e.unbind("change"),shimi.form().clear($(".input")).removeClass("ui-state-error")}});return o(),u(),l},shimi.initReplaceDialog=function(){var e=$("#index-replace_function-input"),t=$("#index-editing-data"),n=$("#index-remove_function-input");t.attr("data-index-replace_function")?e.val(t.attr("data-index-replace_function")):shimi.form().clear(e).removeClass("ui-state-error");var r=$("#index-replace-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){$(".input").removeClass("ui-state-error");var r=!0;n.is(":checked")?(t.removeAttr("data-index-replace_function"),$("#replace-function-message").empty()):(e.val().isBlank()?e.addClass("ui-state-error"):e.removeClass("ui-state-error"),r&&(t.attr("data-index-replace_function",e.val()),$("#replace-function-message").text("This index has a replacement function."))),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){shimi.form().clear(e).removeClass("ui-state-error")}});return r},$(function(){shimi.pui().init(),$("#create-project").button({icons:{primary:"ui-icon-plus"}}).click(function(){shimi.pui().addProjectDialog().dialog("open")})}),shimi.pui=function(){var e={},t=function(t){window.confirm("Are you sure? This is permanent.")&&$.ajax({type:"DELETE",url:"/projects/"+t,dataType:"json",contentType:"application/json",complete:function(t,n){t.status===204?e.init():window.alert("An error occurred"+t.status)}})};return e.addProjectDialog=function(){var t=$("#project-name"),n=$("#project-description"),r=$(".validate-tips"),i=$([]).add(t).add(n),s=$("#add-dialog").dialog({autoOpen:!1,modal:!0,buttons:{"Add project":function(){i.removeClass("ui-state-error");var s=shimi.form().checkLength(t,"project name",1,50,r);s&&($.ajax({type:"POST",url:"projects/index",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({name:t.val(),description:n.val()}),complete:function(t,n){t.status===201?e.init():window.alert("An error occurred"+t.status)}}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){i.val("").removeClass("ui-state-error")}});return s},e.init=function(){var e="/projects/index";$.get(e,function(e){$("tbody").empty(),$("tbody").html(e),$(".configure-button").button({icons:{primary:"ui-icon-wrench"}}),$(".delete-button").button({icons:{primary:"ui-icon-trash"}}).click(function(e){var n=$(e.target).attr("id");t(n),$("#delete-dialog").dialog("open")})})},e};
var shimi={};shimi.globals={},String.prototype.isBlank=function(){return/^\s*$/.test(this)&&!/\S/.test(this)&&null!==this},String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")},Array.prototype.trimAll=function(){return this.map(function(e){return e.trim()}).filter(function(e){return!e.match(/^$/)})},shimi.panelToggle=function(){var e={};return e.toggler=function(t){var i;return i=$(t).attr("data-panel")?$("#"+$(t).attr("data-panel")):$(t).closest(".panel"),"none"===i.css("display")?i.css("display","table-cell"):i.css("display","none"),e},e}(),shimi.utils=function(){var e={};return e.stringToNumber=function(e){return"string"!=typeof e||isNaN(e)||""===e?"":1*e},e.isBlank=function(e){return/^\s*$/.test(e)||null===e||void 0===e||"number"==typeof e&&isNaN(e)||"[object Array]"===Object.prototype.toString.call(e)&&0===e.length},e.validID=function(e){return!!e.match(/^[a-f0-9]{32}$/)},e.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var i,n,r,a,s,o,c,d="",u=0;for(t=e.Base64._utf8_encode(t);t.length>u;)i=t.charCodeAt(u++),n=t.charCodeAt(u++),r=t.charCodeAt(u++),a=i>>2,s=(3&i)<<4|n>>4,o=(15&n)<<2|r>>6,c=63&r,isNaN(n)?o=c=64:isNaN(r)&&(c=64),d=d+this._keyStr.charAt(a)+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(c);return d},decode:function(t){var i,n,r,a,s,o,c,d="",u=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");t.length>u;)a=this._keyStr.indexOf(t.charAt(u++)),s=this._keyStr.indexOf(t.charAt(u++)),o=this._keyStr.indexOf(t.charAt(u++)),c=this._keyStr.indexOf(t.charAt(u++)),i=a<<2|s>>4,n=(15&s)<<4|o>>2,r=(3&o)<<6|c,d+=String.fromCharCode(i),64!==o&&(d+=String.fromCharCode(n)),64!==c&&(d+=String.fromCharCode(r));return d=e.Base64._utf8_decode(d)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;e.length>i;i++){var n=e.charCodeAt(i);128>n?t+=String.fromCharCode(n):n>127&&2048>n?(t+=String.fromCharCode(192|n>>6),t+=String.fromCharCode(128|63&n)):(t+=String.fromCharCode(224|n>>12),t+=String.fromCharCode(128|63&n>>6),t+=String.fromCharCode(128|63&n))}return t},_utf8_decode:function(e){for(var t="",i=0,n=0,r=0,a=0;e.length>i;)n=e.charCodeAt(i),128>n?(t+=String.fromCharCode(n),i++):n>191&&224>n?(r=e.charCodeAt(i+1),t+=String.fromCharCode((31&n)<<6|63&r),i+=2):(r=e.charCodeAt(i+1),a=e.charCodeAt(i+2),t+=String.fromCharCode((15&n)<<12|(63&r)<<6|63&a),i+=3);return t}},e},shimi.sets=function(){var e={};return e.arraysToCSV=function(e){return e.map(function(e){return e.map(function(e){return'"'+(""+e).replace(/"/,'""')+'"'}).join(",")}).join("\n")},e}(),shimi.sets=function(){var e={};return e.member=function(e,t){var i=e.some(function(e){return t===e});return i},e.unique=function(t,i){i||(i=e.member);var n=t.reduce(function(e,t){return i(e,t)?e:e.concat([t])},[]);return n},e.union=function(t,i,n){n||(n=e.member);var r=e.unique(t.concat(i),n);return r},e.intersection=function(t,i,n){n||(n=e.member);var r=t.filter(function(e){return n(i,e)});return r},e.relativeComplement=function(t,i,n){n||(n=e.member);var r=t.filter(function(e){return!n(i,e)});return r},e.symmetricDifference=function(t,i,n){n||(n=e.member);var r=e.relativeComplement(t,i,n),a=e.relativeComplement(i,t,n),s=e.union(r,a,n);return s},e}(),shimi.flash=function(e,t){var i={},n=function(e,t,i){var n=function(){e.fadeOut()};e.find(".notification-summary").text(t+": "),e.find(".notification-message").text(i);var r=window.setTimeout(n,7e3);e.fadeIn(),e.find(".close").click(function(){window.clearTimeout(r),e.hide()})};return i.error=function(){return n($("#notifications-main .ui-state-error"),e,t),i},i.highlight=function(){return n($("#notifications-main .ui-state-highlight"),e,t),i},i};var identity=function(e){return e};Function.prototype.r=function(){return[this,arguments]},Function.prototype.t=function(){for(var e=[this,arguments],t=arguments[arguments.length-1];e[0]!==t;)e=e[0].apply(this,e[1]);return t.apply(this,e[1])},shimi.store=function(e){var t={};return t.get=function(t){var i=e.attr("data-"+t);if(i)return i;var n=function(e,t,i){var r=t.attr("data-group-id"),a=$("#"+r),s=a.attr("data-"+e),o=a.attr("data-group-id");return void 0===s&&void 0!==o&&r!==o?n.r(e,a,i):i.r(s)};return n.t(t,e,identity)},t.get64=function(e){var i=t.get(e);return i=shimi.utils().Base64.decode(i.replace(/"/g,"")).replace(/(^"|"$)/g,"")},t.put=function(t,i){var n=e.attr("data-group-id");$("#"+n).attr("data-"+t,i)},t.fs=function(e){return t.get("fieldset-"+e)},t.f=function(e){return t.get("field-"+e)},t.d=function(e){return t.get("document-"+e)},t},shimi.path=function(e,t,i){var n,r={};n=t?t+"-":"",r.string=i?i+"/":"",r.category=t,r.origin=e,r.type=n+"path",r.valid_components=["doctype","fieldset","field"];var a=shimi.store(r.origin);return r.valid_components.forEach(function(e){r[e]=function(){var t=a.get(n+e);return t}()}),r.rev=a.get(n+"rev"),r.doctype=a.get(n+"doctype"),r.send=function(e,t,i,n){return shimi.form.send(""+r,e,t,i,n),r},r.put=function(e,t,i){return r.send(e,"PUT",t,i),r},r.post=function(e,t,i){return r.send(e,"POST",t,i),r},r.del=function(e,t){return r.send({},"DELETE",e,t),r},r.toString=function(){var e=r.string.concat(r.valid_components.map(function(e){var t=e+"s",i=r[e],n=null;return i?n=t+"/"+i:e===r.category&&(n=t),n}).filter(function(e){return"string"==typeof e&&!e.isBlank()}).join("/"));return r.rev&&(e=e.concat("?rev="+r.rev)),e},r},function(e){function t(t){if("string"==typeof t.data){var i=t.handler,n=t.data.toLowerCase().split(" ");t.handler=function(t){var r="keypress"!==t.type&&e.hotkeys.specialKeys[t.which],a=String.fromCharCode(t.which).toLowerCase(),s="",o={};t.altKey&&"alt"!==r&&(s+="alt+"),t.ctrlKey&&"ctrl"!==r&&(s+="ctrl+"),t.metaKey&&!t.ctrlKey&&"meta"!==r&&(s+="meta+"),t.shiftKey&&"shift"!==r&&(s+="shift+"),r?o[s+r]=!0:(o[s+a]=!0,o[s+e.hotkeys.shiftNums[a]]=!0,"shift+"===s&&(o[e.hotkeys.shiftNums[a]]=!0));for(var c=0,d=n.length;d>c;c++)if(o[n[c]])return i.apply(this,arguments)}}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})}(jQuery),function(e){e.fn.inputDisable=function(){return this.val(""),this.attr("disabled","disabled"),this.addClass("ui-state-disabled"),this},e.fn.inputEnable=function(){return this.removeAttr("disabled"),this.removeClass("ui-state-disabled"),this}}(jQuery),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t,i=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&i.push(t);return i}),Array.prototype.reduce||(Array.prototype.reduce=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw new TypeError;if(0===i&&1===arguments.length)throw new TypeError;var n,r=0;if(arguments.length>=2)n=arguments[1];else for(;;){if(r in t){n=t[r++];break}if(++r>=i)throw new TypeError}for(;i>r;)r in t&&(n=e.call(void 0,n,t[r],r,t)),r++;return n}),shimi.dispatcher=function(e){var t=function(t){var i=$(t.target);Object.keys(e).forEach(function(t){if(i.is(t)){var n=e[t];n(i)}})};return t},shimi.dblclickDispatch=function(e){var t=shimi.searchui,i=shimi.worksheetui,n=shimi.dispatcher({".search-result-field-id a":function(e){t.addField($(e).parent("h5"))},".field-view b":function(e){t.addField($(e).parent("li"))},".field-container label span":function(e){t.addField($(e).parent("label").parent("div"))},"#index-index-input-label":function(){t.addIndex()},".panel > h2":function(e){shimi.panelToggle.toggler(e)},"#toggle-handles":function(){i.hideHandles()},".fieldset-handle":function(e){i.hideFieldset($(e).attr("data-field-fieldset"))},".field-handle":function(e){i.hideField($(e).attr("data-field-field"))}});n(e)},shimi.clickDispatch=function(e){var t=shimi.doctypeTab,i=shimi.charseqTab,n=shimi.editui,r=shimi.viewui,a=shimi.indexui,s=shimi.setsui,o=shimi.searchui,c=shimi.worksheetui,d=shimi.fieldsets,u=shimi.ieditui,l=shimi.form,f=shimi.projectui,h=shimi.fm,m=shimi.dispatcher({".edit-field-button":function(e){t.editField(e)},".delete-field-button":function(e){t.deleteField(e)},".add-field-button":function(e){t.addField(e)},".edit-fieldset-button":function(e){t.editFieldset(e)},".delete-fieldset-button":function(e){t.deleteFieldset(e)},".add-fieldset-button":function(e){t.addFieldset(e)},".delete-doctype-button":function(e){t.deleteDoctype(e)},".edit-doctype-button":function(e){t.editDoctype(e)},".touch-doctype-button":function(e){t.touchDoctype(e)},"#doctype-add-button":function(e){t.addDoctype(e)},".delete-charseq-button":function(e){i.del(e)},".edit-charseq-button":function(e){i.edit(e)},"#charseq-add-button":function(){i.add()},"#maintenance-upgrade-button":function(e){shimi.upgradeButton(e)},".add-button":function(e){d.initFieldset(e,!1,!0)},".remove-button":function(e){d.removeFieldset(e)},"#save-document-button":function(){n.save()},"#create-document-button":function(){n.create()},"#clear-document-button":function(){n.clear()},".expander":function(e){n.toggleTextarea(e)},"label span.ui-icon-help":function(e){n.showHelpDialog(e)},"#document-edit-button":function(e){r.edit(e)},"#document-delete-button":function(){r.confirmDelete()},"#document-restore-button":function(){r.confirmRestore()},"#document-view-tree > ul > li > b":function(e){r.collapseToggle(e)},".revision-link":function(e){r.fetchRevision(e)},"#search-all-fields-switch a":function(){o.allFields()},".search-field-item":function(e){o.removeField(e)},".select-results":function(e){o.toggleSelection(e)},"#save-search-results a":function(){$("#new-set-target-input").val("search"),$("#new-set-dialog").show()},"#save-set-results a":function(){$("#new-set-target-input").val("sets"),$("#new-set-dialog").show()},"#new-set-save-button":function(){shimi.dispatch.send("new-set-form-submit")},"#select-all-set-elements":function(e){s.toggleSelectAll(e)},".view-document-link span":function(e){var t=e[0].parentNode;window.console.log("==="+t.id),a.load(t)},".view-document-link":function(e){a.load(e)},".select-worksheet-column":function(e){var t=$(e),i=t.is(":checked"),n=t.attr("data-field-field");c.columnSelection(n,i)},".select-worksheet-row":function(e){var t=$(e),i=t.is(":checked"),n=t.attr("data-row");c.rowSelection(n,i)},"#select-all-worksheet-rows":function(e){var t=$(e).is(":checked");c.selectAllRows(t)},"#toggle-handles":function(){c.showHandles()},".fieldset-handle":function(e){c.showFieldset($(e).attr("data-field-fieldset"))},".field-handle":function(e){c.showField($(e).attr("data-field-field"))},".field-header":function(e){c.hideField($(e).attr("data-field-field"))},"#new-index-button":function(){u.newCond()},".remove-condition-button":function(e){u.remCond(e)},"#delete-index-button":function(){u.del()},"#save-index-button":function(){u.save()},"#replace-button":function(){u.replace()},"#add-index-condition-button":function(){u.addCond()},"#index-index-listing ul li a":function(e){u.init(e)},"#create-project":function(){f.add().dialog("open")},".project-delete-button":function(e){f.del(e)},"#up-dir":function(){h.upDir()},"#root-dir":function(){h.rootDir()},".dir":function(e){h.goDir(e)},".delete-file-button":function(e){h.deleteFile(e)},".edit-file-button":function(e){h.editFile(e)},".toggler":function(e){l.toggle(e)},".cancel-dialog":function(e){l.cancelDialog(e)},"#panel-toggle li":function(e){shimi.panelToggle.toggler(e)}});m(e)},$(function(){$("body").click(function(e){shimi.clickDispatch(e)}),$("body").dblclick(function(e){shimi.dblclickDispatch(e)})}),$(document).on("keydown","#document-worksheets-form",function(e){return 13===e.which?(shimi.dispatch.send("worksheet-form-submit"),!1):!0}),$(document).on("keydown","#document-sets-form",function(e){return 13===e.which?(shimi.dispatch.send("sets-form-submit"),!1):!0}),$("#new-set-form").on("keydown",function(e){return 13===e.which?(shimi.dispatch.send("new-set-form-submit"),!1):!0}),$(document).bind("keydown","Alt+n",function(){var e=function(){return $("#edit-tabs")},t=e().find("li").length,i=e().tabs("option","active");return t-1>i?(e().tabs("option","active",i+1),shimi.dispatch.send("lost-focus")):(e().tabs("option","active",0),shimi.dispatch.send("lost-focus")),!1}),$(document).bind("keydown","Alt+c",function(){var e=$(document.activeElement).attr("id");return shimi.dispatch.send("initiated-command",e),!0}),$(document).bind("keydown","Alt+p",function(){var e=function(){return $("#edit-tabs")},t=e().find("li").length,i=e().tabs("option","active");return 0!==i?(e().tabs("option","active",i-1),shimi.dispatch.send("lost-focus")):(e().tabs("option","active",t-1),shimi.dispatch.send("lost-focus")),!1}),$(document).on("keydown","#edit-command-input",function(e){if(13===e.which){var t=$("#edit-command-input").val();shimi.dispatch.send("submitted-command",t)}return!0}),$(document).on("keydown","#edit-document-form input",function(e){return 13===e.which&&("none"===$("#save-document-button").css("display")?shimi.editui.create():shimi.editui.save()),!0}),$(document).on("keydown","#edit-document-form textarea","Alt+x",function(e){return shimi.editui.toggleTextarea($(e.target)),!1}),$(document).on("keypress","#view-jump-id",function(e){if(13===e.which){var t=$("#view-jump-id").val();return shimi.viewui.get(t),!1}return!0}),$(document).on("keydown","#document-search-term",function(e){return 13===e.which?(shimi.searchui.getSearch(),!1):!0}),$(document).on("change","#document-search-exclude",function(){return shimi.searchui.toggleExclusion(),!0}),$(document).on("change","#document-search-invert",function(){return shimi.searchui.toggleInversion(),!0}),shimi.dispatch=function(){var e={};return e.send=function(e,t){switch(e){case"bad-session-state":shimi.documents.clearSession();break;case"doctype-info-ready":shimi.documents.makeLabels();break;case"labels-ready":shimi.searchui.loadSearchVals(),shimi.worksheetui.buildTemplate();break;case"new-set-form-submit":shimi.setsui.saveSelected();break;case"sets-changed":shimi.setsui.updateSelection();break;case"sets-form-submit":shimi.setsui.performOp();break;case"session-cleared":shimi.documents.setVersion(),shimi.documents.loadDoctype();break;case"worksheet-form-submit":shimi.worksheetui.fillWorksheet();break;case"initiated-command":shimi.commands.dialogOpen(t);break;case"executed-command":shimi.commands.dialogClose();break;case"submitted-command":shimi.commands.execute(t);break;case"lost-focus":shimi.editui.selectInput()}return!1},e}(),shimi.index=function(e){var t={};return t.get=function(i,n,r,a){var s=e.url+"?",o=e.indexId,c=$("#index-limit"),d=1*c.val(),u=e.target,l=JSON.stringify($("#index-filter").val()),f={sk:i,sid:n,pks:r,pids:a};return f.pks||(f.sk=window.btoa(window.unescape(window.encodeURIComponent(l))),f.pks=[],f.pids=[]),f.sk&&(s=s+"&startkey="+window.escape(window.atob(f.sk)),f.sid&&(s=s+"&startkey_docid="+f.sid)),d?s=s+"&limit="+(d+1):(c.val(25),s+="&limit=26"),o&&(s=s+"&index="+o),shimi.form.send(s,!1,"GET",function(e,i){t.fill(i,f,u)},this),t},t.fill=function(e,i,n){return n.html(e.responseText),$("#previous-index-page").click(function(){t.get(i.pks.pop(),i.pids.pop(),i.pks,i.pids)}),$("#next-index-page").click(function(){var e=$("#next-index-page").attr("data-startkey"),n=$("#next-index-page").attr("data-startid"),r=$("#first-index-element").attr("data-first-key"),a=$("#first-index-element").attr("data-first-id");i.pks.push(r),i.pids.push(a),t.get(e,n,i.pks,i.pids)}),0===i.pks.length&&$("#previous-index-page").hide(),$("#next-index-page").attr("data-last-page")&&$("#next-index-page").hide(),t},t},shimi.form=function(){var e={};return e.toggle=function(t){var i,n=$(t);return n.attr("data-target")&&(i=$("#"+n.attr("data-target")),i.toggle()),e},e.cancelDialog=function(t){var i,n,r=$(t);return r.attr("data-target")&&(n="#"+r.attr("data-target"),i=$(n),i.hide(),e.clear(void 0,i.find("form"))),e},e.clear=function(e,t){return void 0===e&&(e=$(t).find("input, select, textarea")),e.each(function(e,t){var i=$(t);i.attr("data-retain")||(i.is(":checked")&&i.attr("checked",!1),i.val(""))}),e},e.send=function(e,t,i,n,r){var a;return t&&(a=JSON.stringify(t)),$.ajax({type:i,url:e,dataType:"json",context:r,contentType:"application/json",processData:!1,data:a,complete:function(e){if(e.status>=200&&300>e.status)n(this,e);else if(500===e.status)shimi.flash("Unknown Server Error","Please report that you received this message").error();else if(e.status>=400){var t=JSON.parse(e.responseText),i=e.statusText;shimi.flash(i,t.fieldname+" "+t.message).error()}}}),!0},e.updateTips=function(e,t){return t.text(e).addClass("ui-state-highlight"),setTimeout(function(){t.removeClass("ui-state-highlight",1500)},500),!0},e.checkLength=function(t,i,n,r,a){return t.val().length>r||n>t.val().length?(t.addClass("ui-state-error"),e.updateTips("Length of "+i+" must be between "+n+" and "+r+".",a),!1):!0},e.checkRegexp=function(t,i,n,r){return i.test(t.val())?!0:(t.addClass("ui-state-error"),e.updateTips(n,r),!1)},e.initDateFields=function(){return $(".date").datepicker({dateFormat:"yy-mm-dd"}),!0},e.fillOptionsFromUrl=function(e,t,i){return $.get(e,function(e){t.html(e),i&&i()}),!1},e}(),shimi.sess=function(){var e={};return e.put=function(e){return window.sessionStorage[e._id]||(window.sessionStorage[e._id]=JSON.stringify(e)),e._id},e.get=function(e){var t=window.sessionStorage[e];return t?JSON.parse(t):null},e},shimi.charseqDialog=function(e){var t=shimi.charseqElems.get(e),i=$("#charseq-dialog").dialog({width:650,autoOpen:!1,modal:!0,buttons:{Save:function(){var i=t.getCharseqInputVals(),n="config/charseqs",r="POST",a=function(e){shimi.charseqTab.init(),$(e).dialog("close")};e&&e.rev&&(r="PUT",n="config/charseqs/"+i._id+"?rev="+i.rev),shimi.form.send(n,i,r,a,this)},Cancel:function(){$(this).dialog("close")}},close:function(){t.clear()}});return i},shimi.charseqElems=function(){var e={};return e.attrs=["description","characters","name","sort_ignore","locale","tailoring","vowels","consonants","ietf_tag","iso639_tag","charseq","rev"],e.get=function(t){var i={};return i.attrs=e.attrs,i.copyValues=function(e){return Object.keys(e).forEach(function(t){i[t].val(e[t])}),i},i.getCharseqInputVals=function(){var e={category:"charseq",description:i.description.val(),characters:i.parse(i.characters.val()),name:i.name.val(),sort_ignore:i.parse(i.sort_ignore.val()),locale:i.locale.val(),tailoring:i.tailoring.val(),vowels:i.parse(i.vowels.val()),consonants:i.parse(i.consonants.val()),ietf_tag:i.ietf_tag.val(),iso639_tag:i.iso639_tag.val(),_id:i.charseq.val()||void 0,rev:i.rev.val()||void 0};return e},i.parse=function(e){return e&&!e.isBlank()?JSON.parse(e):[]},i.clear=function(){return shimi.form.clear($("#charseq-dialog .input")).removeClass("ui-state-error"),i},i.attrs.forEach(function(e){i[e]=$("#charseq-"+e+"-input")}),t&&i.copyValues(t),i},e}(),shimi.charseqTab=function(){var e={};return e.add=function(){return shimi.charseqDialog().dialog("open"),e},e.edit=function(t){var i={},n=shimi.charseqElems.attrs;return n.forEach(function(e){i[e]=shimi.store(t).get64("charseq-"+e)}),shimi.charseqDialog(i).dialog("open"),e},e.del=function(t){var i=shimi.store(t),n=i.get("charseq-charseq"),r=i.get("charseq-rev"),a="config/charseqs/"+n+"?rev="+r,s=function(){e.init()};return window.confirm("Are you sure? This is permanent.")&&shimi.form.send(a,{},"DELETE",s,this),e},e.init=function(){var t=$("#charseq-tabs"),i=$("#charseq-tabs-headings"),n="config/charseqs";return t.tabs(),$.get(n,function(e){i.empty(),i.find(".ui-tabs-panel").remove(),t.tabs("destroy"),i.html(e),t.tabs()}),e},e}(),shimi.upgradeButton=function(){$.post("config/upgrade"),window.alert("Upgrade In Progress")},shimi.initTabs=function(){return shimi.doctypeTab.init(),$("#main-tabs").tabs(),shimi.charseqTab.init(),!0},shimi.doctypeDialog=function(e,t){var i=shimi.doctypeElems.get(t);t.rev&&!t.rev.isBlank()?i.doctype.attr("disabled","disabled"):i.doctype.removeAttr("disabled");var n=$("#doctype-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var n=i.getDoctypeInputVals(),r=function(e){shimi.doctypeTab.init(),$(e).dialog("close")};!t.rev||t.rev.isBlank()?e.post(n,r,this):(n._id=e.doctype,e.put(n,r,this))},Cancel:function(){$(this).dialog("close")}},close:function(){i.clear()}});return n},shimi.doctypeElems=function(){var e={};return e.attrs=["description","doctype","rev"],e.get=function(t){var i={};return i.copyValues=function(e){return Object.keys(e).forEach(function(t){i[t].val(e[t])}),i},i.getDoctypeInputVals=function(){var e={category:"doctype",description:i.description.val(),_id:i.doctype.val()};return e},i.clear=function(){return shimi.form.clear($("#doctype-dialog .input")).removeClass("ui-state-error"),i},e.attrs.forEach(function(e){i[e]=$("#doctype-"+e+"-input")}),i.copyValues(t),i},e}(),shimi.doctypeTab=function(){var e={},t=function(e,t){return shimi.path(e,t,"config")};return e.initFields=function(t){return t.field=!1,$.get(""+t,function(e){var i=$("#fields-"+t.fieldset);i.empty(),i.html(e)}),e},e.initFieldsets=function(e){$.get(""+e,function(t){var i=$("#fieldsets-"+e.doctype);i.empty(),i.accordion(),i.accordion("destroy"),i.html(t),i.accordion({autoHeight:!1,collapsible:!0,active:!1})})},e.init=function(){var t="config/doctypes";$("#doctype-tabs").tabs(),$.get(t,function(t){$("#fieldset-doctype-input"),$("#doctype-tabs-headings").empty(),$("#doctype-tabs-headings + .ui-tabs-panel").remove(),$("#doctype-tabs").tabs("destroy"),$("#doctype-tabs-headings").html(t);var i=function(t,i){var n=$(i.panel).children("div[data-fieldset-doctype]"),r=shimi.path(n,"fieldset","config");e.initFieldsets(r)};$("#doctype-tabs").tabs({load:function(e,t){i(e,t)}})})},e.editField=function(e){var i=t(e,"field"),n={},r=shimi.fieldElems.attrs,a="config/charseqs?as=options";$.get(a,function(t){$("#field-charseq-input").html(t),r.forEach(function(t){n[t]=shimi.store(e).get("field-"+t)}),shimi.fieldDialog(i,n).dialog("open")})},e.deleteField=function(i){var n=window.confirm("Are you sure? This is permanent.");if(n){var r=t(i,"field"),a=function(){r.field=!1,r.rev=!1,e.initFields(r)};r.del(a,this)}},e.addField=function(e){var i=t(e,"field"),n="config/charseqs?as=options";$.get(n,function(e){$("#field-charseq-input").html(e),shimi.fieldDialog(i,{fieldset:i.fieldset,doctype:i.doctype}).dialog("open")})},e.editFieldset=function(e){var i=t(e,"fieldset"),n={},r=shimi.fieldsetElems.attrs;r.forEach(function(t){n[t]=shimi.store(e).get("fieldset-"+t)}),shimi.fieldsetDialog(i,n).dialog("open")},e.deleteFieldset=function(i){var n=t(i,"fieldset"),r=function(){n.fieldset=!1,n.rev=!1,e.initFieldsets(n)};window.confirm("Are you sure? This is permanent.")&&n.del(r,this)},e.addFieldset=function(e){var i=t(e,"fieldset");shimi.fieldsetDialog(i,{doctype:i.doctype}).dialog("open")},e.editDoctype=function(e){var i=t(e,"doctype"),n={},r=shimi.doctypeElems.attrs;r.forEach(function(t){n[t]=shimi.store(e).get("doctype-"+t)}),shimi.doctypeDialog(i,n).dialog("open")},e.touchDoctype=function(e){var t=shimi.store(e).get("doctype-doctype");$.post("config/doctypes/"+t+"/touch"),window.alert("Touch In Progress")},e.deleteDoctype=function(i){var n=t(i,"doctype"),r=function(){n.doctype=!1,n.rev=!1,e.init()};window.confirm("Are you sure? This is permanent.")&&n.del(r,this)},e.addDoctype=function(e){var i=t(e,"doctype");shimi.doctypeDialog(i,{}).dialog("open")},e}(),shimi.fieldDialog=function(e,t){var i=shimi.fieldElems.get(t),n=$("#field-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var n=i.clearDisabled().getFieldInputVals(),r=function(t){shimi.doctypeTab.initFields(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(n,r,this):(n._id=e.field,e.put(n,r,this))},Cancel:function(){$(this).dialog("close")}},close:function(){i.clear()}});return n},shimi.fieldElems=function(){var e={};return e.attrs=["name","label","order","description","subcategory","head","reversal","default","required","allowed","source","max","min","regex","doctype","fieldset","charseq","rev","field"],e.get=function(t){var i={};return i.attrs=e.attrs,i.notDefault=function(){return[i.charseq,i.allowed,i.source,i.min,i.max,i.regex]},i.disable=function(){return i.notDefault().forEach(function(e){e.attr("disabled","disabled")}),i},i.clearDisabled=function(){return i.notDefault().forEach(function(e){e.attr("disabled")&&e.val("")}),i},i.copyValues=function(e){return Object.keys(e).forEach(function(t){i[t].val(e[t]),i[t].is("input[type=checkbox]")&&"true"===e[t]&&i[t].attr("checked",!0)}),i},i.getFieldInputVals=function(){var e={category:"field",name:i.name.val(),label:i.label.val(),"default":i.decodeDefaults(i.subcategory.val(),i["default"].val()),head:i.head.is(":checked"),reversal:i.reversal.is(":checked"),required:i.required.is(":checked"),order:1*i.order.val(),allowed:i.allowed.val().split(",").trimAll(),source:i.decodeSource(i.subcategory.val(),i.source.val()),min:i.decodeBound(i.subcategory.val(),i.min.val()),max:i.decodeBound(i.subcategory.val(),i.max.val()),regex:i.regex.val(),description:i.description.val(),charseq:i.charseq.val(),doctype:i.doctype.val(),fieldset:i.fieldset.val(),subcategory:i.subcategory.val()};return e},i.clear=function(){return shimi.form.clear($("#field-dialog .input")).removeClass("ui-state-error"),i.disable(),i},i.decodeBound=function(e,t){return"date"===e?t:shimi.utils().stringToNumber(i.min.val())},i.decodeSource=function(e,t){return"file"===e?t.split("/").trimAll():t},i.decodeDefaults=function(e,t){switch(e){case"docmultiselect":case"multiselect":return t.split(",").trimAll();case"file":return t.split("/").trimAll();default:return t}},i.displayFields=function(e){switch(e){case"select":case"multiselect":i.disable(),i.allowed.removeAttr("disabled");break;case"docselect":case"docmultiselect":case"file":i.disable(),i.source.removeAttr("disabled");break;case"text":case"textarea":i.disable(),i.charseq.removeAttr("disabled"),i.regex.removeAttr("disabled");break;case"date":case"integer":case"rational":i.disable(),i.min.removeAttr("disabled"),i.max.removeAttr("disabled");break;default:i.disable()}},i.attrs.forEach(function(e){i[e]=$("#field-"+e+"-input")}),i.copyValues(t),i.displayFields(i.subcategory.val()),i.subcategory.change(function(){i.displayFields(i.subcategory.val())}),i},e}(),shimi.fieldsetDialog=function(e,t){var i=shimi.fieldsetElems.get(t),n=$("#fieldset-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var n=i.getFieldsetInputVals(),r=function(t){e.fieldset=!1,e.rev=!1,shimi.doctypeTab.initFieldsets(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(n,r,this):(n._id=e.fieldset,e.put(n,r,this))},Cancel:function(){$(this).dialog("close")}},close:function(){i.clear()}});return n},shimi.fieldsetElems=function(){var e={};return e.attrs=["name","label","order","description","doctype","rev","multiple","collapse","fieldset"],e.get=function(t){var i={};return i.attrs=e.attrs,i.copyValues=function(e){return Object.keys(e).forEach(function(t){i[t].val(e[t]),i[t].is("input[type=checkbox]")&&"true"===e[t]&&i[t].attr("checked",!0)}),i},i.getFieldsetInputVals=function(){var e={category:"fieldset",name:i.name.val(),label:i.label.val(),order:1*i.order.val(),description:i.description.val(),doctype:i.doctype.val(),multiple:i.multiple.is(":checked"),collapse:i.collapse.is(":checked")};return e},i.clear=function(){return shimi.form.clear($("#fieldset-dialog .input")).removeClass("ui-state-error"),i},i.attrs.forEach(function(e){i[e]=$("#fieldset-"+e+"-input")}),i.copyValues(t),i},e}(),shimi.commands=function(){var e={},t=function(){return document.getElementById("edit-command-input")},i=function(){return $("#command-dialog")},n=function(e,t){return e.attr("data-last-active",t)},r=function(e){return e.attr("data-last-active")};return e.execute=function(t){var n=!0;switch(t){case"w":case"clear":shimi.editui.clear();break;case"c":case"create":shimi.editui.create(),n=!1;break;case"s":case"save":shimi.editui.save();break;case"d":case"delete":$("#document-view").show(),"none"!==$("#document-delete-button").css("display")&&$("#document-delete-button").click();break;case"e":case"edit":$("#document-view").show(),"none"!==$("#document-edit-button").css("display")&&($("#document-edit-button").click(),n=!1);break;case"r":case"restore":$("#document-view").show(),"none"!==$("#document-restore-button").css("display")&&$("#document-restore-button").click()}if(n){var a=i(),s=r(a);$("#"+s).focus()}else shimi.dispatch.send("lost-focus");return shimi.dispatch.send("executed-command"),e},e.dialogOpen=function(r){var a=t(),s=i();return a.value="",n(s,r).show(),a.focus(),e},e.dialogClose=function(){var r=t(),a=i();return n(a,"").hide(),r.value="",e},e}(),shimi.documents=function(){var e={},t=function(){var t;return $("#index-filter-form input").keyup(function(e){clearTimeout(t),t=setTimeout(function(){8!==e.which&&46!==e.which&&shimi.indexui.get()},500)}),$("#index-filter-form select").change(function(){shimi.indexui.get()}),e},i=function(t){return t&&shimi.viewui.get(t),e},n=function(){return $("#all-document-container")},r=function(){return e.identifier()+"_version"},a=function(){return e.identifier()+"_info"},s=function(){return e.identifier()+"_labels"},o=function(t){return sessionStorage.setItem(a(),t),shimi.dispatch.send("doctype-info-ready"),e};return e.getVersion=function(){return sessionStorage.getItem(r())},e.getCurrentVersion=function(){return shimi.store(n()).d("version")},e.isCurrentVersionStored=function(){return e.getVersion()&&e.getVersion()===e.getCurrentVersion()},e.setVersion=function(){return sessionStorage.setItem(r(),e.getCurrentVersion()),shimi.dispatch.send("version-set"),e},e.clearSession=function(){return sessionStorage.clear(),shimi.dispatch.send("session-cleared"),e},e.checkVersion=function(){return e.isCurrentVersionStored()?shimi.dispatch.send("labels-ready"):shimi.dispatch.send("bad-session-state"),e},e.name=function(){return shimi.store($("#all-document-container")).d("doctype")},e.project=function(){return shimi.store($("#container")).get("project-id")},e.identifier=function(){return e.project()+"_"+e.name()},e.info=function(){return JSON.parse(sessionStorage.getItem(a()))},e.loadDoctype=function(){return $.getJSON("./",function(e){o(JSON.stringify(e))}),e},e.makeLabels=function(){var t=e.info(),i={};return t.fieldsets.forEach(function(e){e.fields.forEach(function(t){i[t._id]=[e.label,t.label]})}),sessionStorage.setItem(s(),JSON.stringify(i)),shimi.dispatch.send("labels-ready"),e},e.init=function(){$("form").on("submit",function(){return!1}),e.checkVersion(),shimi.setsui.updateSelection(),shimi.indexui.iOpts().get(),t(),shimi.editui.init(),i($(location)[0].hash.split("#")[1])},e}(),shimi.editui=function(){var e={},t=shimi.store,i=shimi.flash,n=function(){return $("#save-document-button")},r=function(){return $("#create-document-button")},a=function(){return $("#document-edit-button")},s=function(t){var n=JSON.parse(t.responseText),r=t.statusText,a=$("[data-field-instance="+n.instance+"]"),s=$("[href=#"+a.parents("fieldset").attr("id")+"]").parent("li");return s.addClass("ui-state-error"),a.addClass("ui-state-error"),i(r,n.fieldname+" "+n.message).error(),e},o=function(t){var i=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],n=function(){return i.map(function(){return i[Math.floor(Math.random()*i.length)]}).join("")};return $("#last-added [data-field-instance]").each(function(e,i){var r=$(i).first(),a=r.attr("data-field-instance"),s=a;
t&&(s=n()),r.attr("data-group-id",s),r.attr("id",s),r.attr("data-field-instance",s),r.next(".expander").attr("data-group-id",s),r.next().next(".expander").attr("data-group-id",s)}),t&&$("#last-added").removeAttr("id"),e};e.init=function(){var t="documents/edit";return $.get(t,function(e){$("#document-edit").html(e),$("#edit-tabs").tabs(),shimi.fieldsets.initFieldsets()}),e},e.selectInput=function(){var t="input, select, textarea",i=function(){return $("#edit-tabs")},n=i().find(".ui-tabs-active a").attr("href");return $(n).find(t).first().focus(),e},e.afterFreshRefresh=function(t){return c(t),e},e.afterEditRefresh=function(){var t=["data-document-id","data-document-rev"];return t.forEach(function(e){n().attr(e,a().attr(e))}),n().show(),c(),e};var c=function(t){return shimi.form.initDateFields(),o(t),e};return e.resetFields=function(){return $(".field").each(function(){var e=$(this),t=e.attr("data-field-default");t&&""!==t?e.is("select.multiselect")?e.val(t.split(",")):e.is("input.boolean")?e.attr("checked",t===!0):e.val(t):(e.val(""),e.removeAttr("checked"))}),e},e.save=function(){if(n().hasClass("oldrev")&&!window.confirm("This data is from an older version of this document. Are you sure you want to restore it?"))return!1;var e,r,a=t(n()),o=$("#edit-document-form"),c=a.d("document"),d=a.d("rev"),u="./documents/"+c+"?rev="+d,l=$("#first-index-element").attr("data-first-key"),f=$("#first-index-element").attr("data-first-id"),h={doctype:a.d("doctype"),description:a.d("description")};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),n().hide(),$.extend(h,shimi.fieldsets.fieldsetsToObject(o)),$.ajax({type:"PUT",url:u,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(h),complete:function(t){204===t.status||200===t.status?(r="Success",e="Your document was saved.",shimi.viewui.get(c),shimi.indexui.get(l,f),i(r,e).highlight(),n().removeClass("oldrev").show()):403===t.status?(s(t),n().show()):409===t.status&&(e=JSON.parse(t.responseText),r=t.statusText,i(r,e.message).error(),n().hide())}})},e.create=function(){var e=t(r()),a=$("#edit-document-form"),o=$("#first-index-element").attr("data-first-key"),c=$("#first-index-element").attr("data-first-id"),d={doctype:e.d("doctype"),description:e.d("description")};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),r().hide(),$.extend(d,shimi.fieldsets.fieldsetsToObject(a));var u=$.ajax({type:"POST",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(d),complete:function(e){if(201===e.status){var t="Success",a="Your document was created.",d=u.getResponseHeader("Location").match(/[a-z0-9]*$/);n().hide().attr("disabled","true"),$(".fields").remove(),shimi.fieldsets.initFieldsets(),shimi.viewui.get(d),shimi.indexui.get(o,c),i(t,a).highlight(),r().show()}else 403===e.status&&(s(e),r().show())}})},e.clear=function(){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),n().hide().attr("disabled","disabled"),$(".fields").remove(),shimi.fieldsets.initFieldsets()},e.showHelpDialog=function(t){return t.is(".label-text")&&(t=t.parent("label").find(".ui-icon-help")),$("#help-dialog").dialog().dialog("open").find("#help-dialog-text").html(t.attr("title")),e},e.toggleTextarea=function(t){var i=$("#"+t.attr("data-group-id"));return t.attr("id")===i.attr("data-group-id")?(i.toggleClass("expanded"),i.next().next("span").toggleClass("expanded")):(i.toggleClass("expanded"),t.toggleClass("expanded")),e},e}(),shimi.fieldsets=function(){var e={},t=shimi.store,i=shimi.utils(),n=function(e){return $("#container-"+e)},r=function(e,t){var i=shimi.path(e,t);return i.doctype=!1,i},a=function(e,t,i){var n=null;n=sessionStorage.getItem(e),n?t(n):$.get(e,i)},s=function(e,i){e=e.children(".field-container").children(".field");var n={fields:[]};return e.each(function(e,r){r=$(r);var a=t(r),s=f(r),c=a.f("instance");n.fields[e]={id:a.f("field"),name:a.f("name"),label:a.f("label"),head:"true"===a.f("head"),reversal:"true"===a.f("reversal"),required:"true"===a.f("required"),min:o(a.f("subcategory"),a.f("min")),max:o(a.f("subcategory"),a.f("max")),instance:c,charseq:a.f("charseq"),regex:a.f("regex"),order:1*a.f("order"),subcategory:a.f("subcategory"),value:s},i>=0&&(n.fields[e].index=i)}),n},o=function(e,t){return"date"===e?t:i.stringToNumber(t)},c=function(e){switch(e){case"true":e=!0;break;case"false":e=!1;break;default:e=null}return e},d=function(e){return i.isBlank(e)?e="":isNaN(e)||(e=1*e),e},u=function(e){return e=e?e.map(function(e){return l(e)}):null},l=function(e){return window.decodeURIComponent(e.replace(/\+/g," "))},f=function(e){var i;switch(t(e).f("subcategory")){case"boolean":i=e.is("input:checkbox:checked");break;case"openboolean":i=c(e.val());break;case"integer":case"rational":i=d(e.val());break;case"multiselect":case"docmultiselect":i=u(e.val());break;case"select":case"docselect":i=l(e.val());break;default:i=e.val()}return i},h=function(e,t,i){var n=r(e,"field"),s=e.children(".fields").last(),o=function(e){i&&s.attr("id","last-added"),s.prepend(e),t&&t(s),shimi.editui.afterFreshRefresh(i)},c=function(e){sessionStorage.setItem(n,e),o(e)};return a(""+n,o,c),!0},m=function(i){i=$(i);var n=t(i).fs("fieldset"),a=$("#container-"+n);r(i,"fieldset"),a.html(""),i.find(".multifield").each(function(t,i){e.initFieldset(a,function(e){v($(i),e)})})},p=function(e){v($(e))},v=function(e,t){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),$("#save-document-button").show(),e.find(".field-view").each(function(e,i){var n,r=$(i).attr("data-field-value"),a=$(i).attr("data-field-field"),s=$(i).attr("data-field-instance");r&&(n=JSON.parse(r)),t||(t=$("body")),g(t.find(".field[data-field-field="+a+"]"),n,s)})},g=function(e,t,i){e.is("input.boolean")?e.prop("checked",t):t&&e.is("select.open-boolean")?e.val(""+t):t&&e.is("select.multiselect")?(t=t.map(function(e){return encodeURIComponent(e).replace(/[!'()]/g,window.escape).replace(/\*/g,"%2A").replace(/%20/g,"+")}),e.val(t)):t&&e.is("select.select")?(t=encodeURIComponent(t).replace(/[!'()]/g,window.escape).replace(/\*/g,"%2A").replace(/%20/g,"+"),e.val(t)):t&&(e.is("input.text")||e.is("select.file"))?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.val(t),e.attr("data-field-instance",i)};return e.initFieldset=function(e,i,n){var s=""+r($(e),"fieldset"),o=t($(e)).fs("fieldset"),c=$("#container-"+o),d=function(e){c.append(e),h(c,i,n)},u=function(e){sessionStorage.setItem(s,e),d(e)};return a(""+s,d,u),!1},e.fieldsetsToObject=function(e){var i={fieldsets:[]};return e.find("fieldset").each(function(e,r){r=$(r);var a,o=t(r),c={id:o.fs("fieldset"),multiple:"true"===o.fs("multiple"),collapse:"true"===o.fs("collapse"),name:o.fs("name"),label:o.fs("label"),order:1*o.fs("order")};a=n(c.id).children(".fields"),c.multiple?(c.multifields=[],a.each(function(e,t){t=$(t),c.multifields[e]=s(t,e)})):$.extend(c,s(a.first())),i.fieldsets[e]=c}),i},e.initFieldsets=function(){return $("fieldset").each(function(i,n){var r=t($(n));"false"===r.fs("multiple")&&e.initFieldset(n,!1)}),e},e.removeFieldset=function(e){e.parent().remove()},e.fillFieldsets=function(){return $(".fieldset-view").each(function(e,i){"true"===t($(i)).fs("multiple")?m(i):p(i)}),shimi.editui.afterEditRefresh(),e},e}(),shimi.indexui=function(){var e={};shimi.store,shimi.flash;var t=shimi.index;return e.get=function(i,n,r,a){var s="documents/index",o=$("#index-index-input").val(),c=$("#index-listing");return t({url:s,indexId:o,target:c}).get(i,n,r,a),e},e.iOpts=function(){var t,i="indexes?as=options";return $.getJSON(i,function(e){t=templates["index-options"].render(e),$("#index-index-input").html(t)}),e},e.load=function(t){var i=$(t).attr("href").slice(1);return $("#document-view").html("<em>Loading...</em>"),shimi.editui.clear(),shimi.viewui.get(i),e},e}(),shimi.searchui=function(){var e={};shimi.utils(),shimi.sets,shimi.setsui;var t=window.localStorage,i=function(){return $("#document-search-index")},n=function(){return $("#search-index-label")},r=function(){return $("#document-search-term")},a=function(){return $("#document-search-field")},s=function(){return $("#search-field-label")},o=function(){return $("#document-search-exclude")},c=function(){return $("#document-search-invert")},d=function(){return $("#search-all-fields-switch")},u=function(){return $("#search-listing")},l=function(){return shimi.documents.identifier()},f=[i,n,a,s,o,c,d],h=function(){var e=$("#index-index-input").val();return 0===e.length?null:e},m=function(e){return e?!0:null},p=function(){var e=l();t.setItem(e+"_searchIndex",null),t.setItem(e+"_searchIndexLabel",null),t.setItem(e+"_searchFields",null),t.setItem(e+"_searchExclude",null),t.setItem(e+"_searchInvert",null)},v=function(){f.forEach(function(e){var t=e();switch(t.attr("type")){case"hidden":t.val("");break;case"checkbox":t.prop("checked",!1)}})},g=function(){f.forEach(function(e){var t=e();switch(t.attr("type")){case"hidden":break;case"checkbox":t.parent("div").hide();break;default:t.hide()}})},b=function(){var e=l(),t=JSON.parse(sessionStorage.getItem(e+"_labels"));return t},y=function(e,t){return templates["search-field-item"].render({fieldLabel:t,field:e})},w=function(e){var i=b(),n=JSON.stringify(e),r=s(),o=l();a().val(n),t.setItem(o+"_searchFields",n);var c=e.map(function(e){return y(e,i[e].join(": "))});return r.html(c.join(" ")),!0};return e.allFields=function(){return p(),g(),v(),e},e.singleField=function(t){return e.multipleFields(t),c().parent().show(),e},e.singleFieldInverse=function(i){var n=l();return e.singleField(i),c().prop("checked",!0),t.setItem(n+"_searchInvert",!0),e},e.multipleFields=function(t){return e.allFields(),w(t),[d(),s(),o().parent()].forEach(function(e){e.show()}),e},e.excludedFields=function(i){var n=l();return i.length>1?e.multipleFields(i):e.singleField(i),o().prop("checked",!0),t.setItem(n+"_searchExclude",!0),e},e.indexOnly=function(r,a){var s=l();return e.allFields(),t.setItem(s+"_searchIndex",r),t.setItem(s+"_searchIndexLabel",a),i().val(r),n().html(a),[d(),i(),n(),c().parent()].forEach(function(e){e.show()}),e},e.indexInverse=function(i,n){var r=l();return e.indexOnly(i,n),c().prop("checked",!0),t.setItem(r+"_searchInvert",!0),e},e.getSearch=function(){var t=r().val(),n="documents/search?q="+window.encodeURIComponent(t),s=a().val(),d=o().is(":checked"),l=c().is(":checked"),f=i().val(),h=b();return f?n=n+"&index="+f:(s&&(n=n+"&field="+s),d&&(n+="&exclude=true")),l&&(n+="&invert=true"),u().hide(),$.get(n,function(e){u().html(e),$(".search-result-field-id").each(function(e,t){var i=h[$(t).attr("data-field-field")].join(": "),n=$(t).children("a").first();n.html(i),n.attr("data-search-label",i)}),l||$(".search-results th").each(function(e,i){var n=$.trim($(i).children("a").html()),r=RegExp("("+t+")","g"),a=n.replace(r,"<span class='highlight'>$1</span>");$(i).children("a").html(a)}),u().show()}),e},e.removeField=function(i){var n,r,a=l(),s=t.getItem(a+"_searchFields"),o=JSON.parse(s),c=$(i).attr("data-field-field");return null!==o&&(r=o.filter(function(e){return e!==c}),n=JSON.stringify(r),t.setItem(a+"_searchFields",0===r.length?null:n),t.setItem(a+"_searchIndex",null),e.loadSearchVals()),e},e.addField=function(i){var n,r,a=l(),s=t.getItem(a+"_searchFields"),o=JSON.parse(s),c=$(i).attr("data-field-field");return null===o&&(o=[]),r=shimi.sets.union(o,c),n=JSON.stringify(r),t.setItem(a+"_searchFields",0===r.length?null:n),t.setItem(a+"_searchIndex",null),e.loadSearchVals(),e},e.addIndex=function(){var i=h(),n=l();return i&&(t.setItem(n+"_searchFields",null),t.setItem(n+"_searchIndex",i),t.setItem(n+"_searchIndexLabel",$("option[value="+i+"]").html()),e.loadSearchVals()),e},e.toggleInversion=function(){var i=l();return t.setItem(i+"_searchInvert",m(c().is(":checked"))),t.setItem(i+"_searchExclude",null),e.loadSearchVals(),e},e.toggleExclusion=function(){var i=l();return t.setItem(i+"_searchExclude",m(o().is(":checked"))),t.getItem(i+"_searchInvert",null),e.loadSearchVals(),e},e.loadSearchVals=function(){var i,n,r=l(),a=t.getItem(r+"_searchExclude"),s=t.getItem(r+"_searchInvert"),o=t.getItem(r+"_searchIndex"),c=t.getItem(r+"_searchFields"),d=[a,s,o,c].map(function(e){return"null"===e||"false"===e||"true"===e?JSON.parse(e):e}),u=d.every(function(e){return null===e});try{u?e.allFields():d[0]===!0?(i=JSON.parse(c),e.excludedFields(i)):null===d[1]&&null!==d[3]?(i=JSON.parse(c),i.length>1?e.multipleFields(i):e.singleField(i)):null!==d[3]?(i=JSON.parse(c),i.length>1?e.multipleFields(i):e.singleFieldInverse(i)):null===d[1]?(n=t.getItem(r+"_searchIndexLabel"),e.indexOnly(o,n)):d[1]===!0&&(n=t.getItem(r+"_searchIndexLabel"),e.indexInverse(o,n))}catch(f){window.console.log(f),e.allFields()}return e},e.toggleSelection=function(t){var i=$(t);return i.is(":checked")?i.next("label").next("table").addClass("selected-for-save"):i.next("label").next("table").removeClass("selected-for-save"),e},e}(),shimi.setsui=function(){var e={},t=shimi.sets,i=shimi.utils(),n=function(){return $("#document-set-a-input")},r=function(){return $("#document-set-b-input")},a=function(){return $("#document-worksheets-set-input")},s=function(){return $("#document-set-operation-input")},o=function(){return $("#set-listing")},c=function(){return shimi.documents.identifier()+"_sets"},d=function(e,t){return e.some(function(e){return t[0]===e[0]&&t[1]===e[1]})},u=function(e){var i=e[0],n=t.unique(e[1],d),r=[i,n];return r},l=function(i,n){var r=e.getSet(i)[1],a=e.getSet(n)[1],s=t.union(r,a,d);return I(s),e},f=function(i,n){var r=e.getSet(i)[1],a=e.getSet(n)[1],s=t.intersection(r,a,d);return I(s),e},h=function(i,n){var r=e.getSet(i)[1],a=e.getSet(n)[1],s=t.relativeComplement(r,a,d);return I(s),e},m=function(i,n){var r=e.getSet(i)[1],a=e.getSet(n)[1],s=t.symmetricDifference(r,a,d);return I(s),e},p=function(){var e=window.sessionStorage.getItem(c()),t=[];return null!==e&&(t=JSON.parse(e)),t},v=function(t){var i=e.getSet(t)[1];return I(i),e},g=function(t){return b(t),I([]),shimi.dispatch.send("sets-changed"),e};e.getSet=function(e){var t,i=p();return t=i.filter(function(t){return t[0]===e})[0]};var b=function(t){var i,n=p();return i=n.filter(function(e){return e[0]!==t}),w(i),e},y=function(){var e=p();return e.map(function(e){return e[0]})},w=function(t){var i;return Array.isArray(t)?(i=t.map(function(e){return u(e)}),window.sessionStorage.setItem(c(),JSON.stringify(i))):window.sessionStorage.settem(c(),"[]"),e},x=function(t){if(Array.isArray(t)&&2===t.length){var i=p(),n=t[0],r=i.filter(function(e){return e[0]!==n});w(r.concat([t]))}return e},k=function(e){var t=[];switch(e){case"search":t=C();break;case"sets":t=S()}return t},S=function(){var e,t=$("input.set-element-selection:checked");return e=$.map(t,function(e){var t=$(e).parent("td").next("td").find("a").first(),i=t.first().attr("href").replace(/^#/,""),n=t.html().trim();return[[n,i]]})},C=function(){var e,t=$("table.selected-for-save tr");return e=$.map(t,function(e){var t=$(e).find("th a").first().attr("href").replace(/^#/,""),i=$(e).find("td.search-result-context a").first().html().trim();return[[i,t]]})},I=function(t){var i=t.length,n=t.map(function(e){return{id:e[1],context:e[0]}}),r=templates["set-listing"].render({elements:n,total:i});return o().html(r),e};return e.performOp=function(){switch(s().val()){case"view-a":v(n().val());break;case"view-b":v(r().val());break;case"remove-a":g(n().val());break;case"remove-b":g(r().val());break;case"union":l(n().val(),r().val());break;case"intersection":f(n().val(),r().val());break;case"symmetric-difference":m(n().val(),r().val());break;case"relative-complement-b-in-a":h(n().val(),r().val());break;case"relative-complement-a-in-b":h(r().val(),n().val());break;default:}return e},e.updateSelection=function(){var t=y(),i=templates["set-options"].render({names:t});return n().html(i),r().html(i),a().html(i),e},e.saveSelected=function(){var t,n,r=$("#new-set-dialog"),a=$("#new-set-input").val(),s=$("#new-set-target-input").val();return i.isBlank(a)?shimi.flash("Input invalid:","You must supply a valid name.").error():(r.hide(),t=k(s),n=[a,t],x(n),$("#new-set-input").val(""),shimi.dispatch.send("sets-changed"),shimi.flash("Success:","Set '"+a+"' saved.").highlight()),e},e.toggleSelectAll=function(t){return $(t).is(":checked")?$("input.set-element-selection").prop("checked",!0):$("input.set-element-selection").prop("checked",!1),e},e}(),shimi.viewui=function(){var e={},t=function(){return $("#document-view")},i=function(){return $("#document-view-tree")},n=function(){return $("#document-view-info")},r=function(e){return Object.keys(e).reduce(function(t,i){return void 0===e[i].newValue&&(void 0===t[e[i].fieldset]&&(t[e[i].fieldset]={}),t[e[i].fieldset][i]=e[i]),t},{})},a=function(e){var t={};return e.changes&&(t=r(e.changes)),e.fieldsets.forEach(function(i){var n=i.id;void 0!==t[n]&&(i.removal=!0,i.altered=!0);var r=function(t){var n,r={};return e.changes&&(r=e.changes),n=r[t.instance],t.json_value=JSON.stringify(t.value),void 0!==n&&(t.changed=!0,i.altered=!0,void 0===n.originalValue?(i.addition=!0,t.newfield=!0):t.originalValue=JSON.parse(n.originalValue)),"textarea"===t.subcategory?t.is_textarea=!0:t.value&&t.subcategory.match("multi")&&(t.value=t.value.join(", ")),!0};return i.multiple?i.multifields.forEach(function(e){e.fields.forEach(function(e){return r(e),!0})}):i.fields.forEach(function(e){return r(e),!0}),!0}),!0};return e.formatTimestamps=function(){return $(".timestamp").each(function(e,t){var i=new Date($(t).text()).toLocaleString();"Invalid Date"!==i&&$(t).text(i)}),e},e.get=function(n,r,s){var o,c="documents/"+n,d=t();return r?(c=c+"/"+r,d=i(),o=function(e){return templates["document-view-tree"].render(e,{"document-view-field":templates["document-view-field"]})}):o=function(e){return templates["document-view"].render(e,{"document-view-tree":templates["document-view-tree"],"document-view-field":templates["document-view-field"]})},$.getJSON(c,function(i){var c;if(a(i,r),c=o(i),d.html(c),window.location.hash=n,e.formatTimestamps(),t().fadeTo("slow",1),s&&s(),r)$("#document-view-tree").addClass("oldrev");else{var u=$("#document-restore-button"),l=$("#document-edit-button"),f=$("#document-delete-button");"true"===shimi.store(u).d("deleted")&&(l.hide(),f.hide(),u.show())}}),e},e.restore=function(i,n){var r="./documents/"+i+"?rev="+n;$("#document-restore-button");var a,s,o=$("#first-index-element").attr("data-first-key"),c=$("#first-index-element").attr("data-first-id");return $.ajax({type:"DELETE",url:r,dataType:"json",contentType:"application/json",complete:function(n){200===n.status?(s="Success",a="Your document was restored.",e.get(i,null,function(){t().fadeTo("slow",1),shimi.indexui.get(o,c)}),shimi.flash(s,a).highlight()):409===n.status?(a=JSON.parse(n.responseText),s=n.statusText,shimi.flash(s,a.message).error()):404===n.status&&(a="Document was erased and cannot be restored.",s=n.statusText,shimi.flash(s,a).error())}}),e},e.del=function(i,n){var r,a,s="./documents/"+i+"?rev="+n,o=$("#document-restore-button"),c=$("#first-index-element").attr("data-first-key"),d=$("#first-index-element").attr("data-first-id");return $.ajax({type:"DELETE",url:s,dataType:"json",contentType:"application/json",complete:function(e){if(200===e.status){a="Success",r="Your document was deleted.";var i=JSON.parse(e.responseText);shimi.store(o).put("document-rev",i.rev),$("#document-delete-button").hide(),$("#document-edit-button").hide(),o.show(),t().fadeTo("slow",.5),shimi.indexui.get(c,d),shimi.flash(a,r).highlight()}else 409===e.status?(r=JSON.parse(e.responseText),a=e.statusText,shimi.flash(a,r.message).error()):404===e.status&&(r="Document appears to have been deleted already.",a=e.statusText,shimi.flash(a,r).error())}}),e},e.confirmIt=function(t){if(window.confirm("Are you sure?")){var i=shimi.store(n()),r=i.d("document"),a=i.d("rev");t(r,a)}return e},e.edit=function(){return shimi.editui.resetFields(),$("#document-view-tree").hasClass("oldrev")?$("#save-document-button").addClass("oldrev"):$("#save-document-button").removeClass("oldrev"),shimi.fieldsets.fillFieldsets(),e},e.confirmDelete=function(){var t=shimi.store(n()),i=t.d("document"),r=t.d("rev");return e.confirmIt(function(){e.del(i,r)})},e.confirmRestore=function(){var t=shimi.store(n()),i=t.d("document"),r=t.d("rev");return e.confirmIt(function(){e.restore(i,r)})},e.collapseToggle=function(t){return $(t).parent("li").toggleClass("collapsed"),e},e.fetchRevision=function(t){var i=shimi.store($(t)),n=i.d("document"),r=i.d("oldrev");return $(".revision-link").removeClass("selected-revision"),$(t).addClass("selected-revision"),e.get(n,r),e},e}(),shimi.worksheetui=function(){var e={},t=shimi.setsui,i=function(){return $("#document-worksheets-set-input")},n=function(){return $("#worksheet-area")},r=function(){return shimi.documents.identifier()+"_worksheet-template"};return e.selectAllRows=function(t){return t?($("#worksheet-table tbody tr").addClass("selected-row"),$("#worksheet-table tbody tr input").prop("checked",!0)):($("#worksheet-table tbody tr").removeClass("selected-row"),$("#worksheet-table tbody tr input:checked").prop("checked",!1)),e},e.rowSelection=function(t,i){return i?($("#"+t).addClass("selected-row"),$("#select-all-worksheet-rows").prop("checked",!1)):($("#"+t).removeClass("selected-row"),$("#select-all-worksheet-rows").prop("checked",!1)),e},e.columnSelection=function(t,i){return i?$(".field-column."+t).addClass("selected-column"):$(".field-column."+t).removeClass("selected-column"),e},e.showHandles=function(){return $("#worksheet-table .handle-column.fieldset").show(),e},e.hideHandles=function(){return $("#worksheet-table .handle-column.fieldset").hide(),e},e.showFieldset=function(t){return $("#worksheet-table .handle-column.field."+t).show(),e},e.hideFieldset=function(t){return $("#worksheet-table .handle-column.field."+t).hide(),e},e.showField=function(t){return $(".field-column."+t).show(),e},e.hideField=function(t){return $(".field-column."+t).hide(),e},e.buildTemplate=function(){var t=shimi.documents.info(),i="{{=<% %>=}}\n"+templates.worksheet.render(t);return shimi.globals[r()]=Hogan.compile(i),e},e.fillWorksheet=function(){var a=i().val(),s="worksheets",o=function(e,t){var i=JSON.parse(t.responseText),a=shimi.globals[r()].render(i);n().html(a)};if(!a.isBlank()){var c=t.getSet(a)[1];if(250>=c.lenght){var d=c.map(function(e){return e[1]});shimi.form.send(s,d,"POST",o)}else shimi.flash("Could not load worksheet","the current set size is limited to 250 items.").error()}return e},e}(),shimi.fm=function(){var e={},t=function(e){void 0===e&&(e=""),$.get("file_manager/list_dirs/"+e,function(e){$("#file-paths").html(e)})};e.init=function(){shimi.fm.refreshListings(),$("#file-upload-target").load(function(){var e=$("#file-upload-target").contents().find("body pre").html(),t=function(){return e&&e.length>0?JSON.parse(e):{message:!1}};t()&&t().message&&"success"!==t().status?(shimi.flash("Error",t().message).error(),shimi.fm.refreshListings()):t().message&&(shimi.flash("Success",t().message).highlight(),shimi.fm.refreshListings())})},e.goDir=function(t){var i=$(t).attr("data-path");return window.sessionStorage.fmPath=i,e.refreshListings(i),e},e.rootDir=function(){return window.sessionStorage.fmPath="",e.refreshListings(),e},e.upDir=function(){var t=window.sessionStorage.fmPath,i=t.split("/");return i.pop(),i=i.join("/"),window.sessionStorage.fmPath=i,e.refreshListings(i),e};var i=function(e){void 0===e&&(e=""),$.get("file_manager/list_files/"+e,function(e){$("#file-listing").html(e)})};e.editFile=function(t){var i=window.sessionStorage.fmPath,r=t.attr("data-file-id"),a="file_manager/"+r;return $.getJSON(a,function(e){n(e,i).dialog("open")}),e},e.deleteFile=function(t){var i=window.sessionStorage.fmPath,n=t.attr("data-file-id"),r=t.attr("data-file-rev"),a="file_manager/"+n+"?rev="+r,s=function(){e.refreshListings(i),shimi.flash("Success","File Deleted").highlight()};return shimi.form.send(a,null,"DELETE",s,t),e};var n=function(t,i){var n=$("#file-path-input");t.path?n.val(t.path.join("/")):n.val("");var r=$("#edit-path-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Move:function(){var a="file_manager/"+t._id+"?rev="+t._rev,s=function(){e.refreshListings(i),shimi.flash("Success","File Moved").highlight()};t.path=n.val().replace(/^\s*|\s*$/g,"").replace(/\/+/g,"/").replace(/^\/|\/$/g,"").split("/"),shimi.form.send(a,t,"PUT",s,r),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return r};return e.refreshListings=function(e){t(e),i(e)},e}(),shimi.initIndexBuilderDialog=function(e){var t=$("#builder-or-input"),i=$("#builder-paren-input"),n=$("#builder-negate-input"),r=$("#builder-operator-input").inputDisable(),a=$("#builder-argument-input").inputDisable(),s=$("#builder-fieldset-input").inputDisable(),o=$("#builder-field-input").inputDisable(),c=[r,s,o],d="doctypes/"+e+"/fieldsets",u="indexes/condition",l=shimi.ihelpers.evs;$(".ui-helper-reset div").show();var f=function(e){var t=$("#index-conditions-listing tbody");return t.append(e),t.sortable(),!1};shimi.ihelpers.fOpts(d,s,function(){s.inputEnable()}),t.change(function(){t.is(":checked")?($("#builder-conditions").hide(),$("#builder-parens").hide()):($("#builder-conditions").show(),$("#builder-parens").show())}),i.change(function(){i.val()?($("#builder-or").hide(),$("#builder-conditions").hide()):($("#builder-or").show(),$("#builder-conditions").show())});var h=function(){l.setIndexFieldsetEvents(e,s,o,function(){return r.inputDisable(),o.inputDisable(),a.inputDisable(),function(){o.inputEnable()}})},m=function(){l.setIndexFieldEvents(e,s,o,function(){return r.inputDisable(),a.inputDisable(),function(){r.inputEnable()}})},p=function(){l.setIndexOperatorEvents(a,r,o,function(){return a.inputDisable(),function(){a.inputEnable()}})},v=$("#index-builder-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var e=!0;t.is(":checked")||i.val()||c.forEach(function(t){t.val().isBlank()?(t.addClass("ui-state-error"),e=!1):t.removeClass("ui-state-error")}),e&&(t.is(":checked")?$.get(u,{is_or:!0},function(e){f(e)}):i.val()?$.get(u,{is_or:!1,parens:i.val(),negate:!1},function(e){f(e)}):$.get(u,{is_or:!1,parens:!1,negate:n.is(":checked"),fieldset:s.val(),field:o.val(),operator:r.val(),argument:a.val()},function(e){f(e)}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){$("#builder-conditions").show(),s.unbind("change"),o.unbind("change"),r.unbind("change"),shimi.form.clear($(".input")).removeClass("ui-state-error")}});return h(),m(),p(),v},shimi.ieditui=function(){var e={},t=function(){return $("#index-conditions-listing tbody")},i=function(){return $("#index-editing-data")},n=function(e,t,i){switch(t){case"integer":case"rational":e=1*e}switch(i){case"hasExactly":case"hasGreater":case"hasLess":e=Math.floor(1*e)}return e},r=function(e,t){var i=t.map(function(t,i){i=$(i);var r,a="true"===i.find("td.or-condition").attr("data-value"),s=i.find("td.paren-condition").attr("data-value");if(a)r={is_or:!0,parens:!1};else if(s)r={is_or:!1,parens:s};else{var o=i.find("td.field-condition").attr("data-value"),c=i.find("td.fieldset-condition").attr("data-value"),d=i.find("td.argument-condition").attr("data-value"),u=shimi.ihelpers.getFieldDoc(o,c,e),l="true"===i.find("td.negate-condition").attr("data-value"),f=i.find("td.operator-condition").attr("data-value");d=n(d,u.subcategory,f),r={is_or:!1,parens:!1,negate:l,fieldset:c,field:o,operator:f,argument:d}}return r}).toArray();return i},a=function(e,t){var i=e.attr("data-index-id"),n=e.attr("data-index-rev"),a="indexes/"+i+"?rev="+n,s=e.attr("data-index-doctype"),o={_id:i,category:"index",doctype:s,show_deleted:"true"===e.attr("data-index-show_deleted"),fields:JSON.parse(e.attr("data-index-fields")),fields_label:JSON.parse(e.attr("data-index-fields_label")),name:e.attr("data-index-name"),conditions:r(s,$("#index-conditions-listing tbody tr"))};return e.attr("data-index-replace_function")&&(o.replace_function=e.attr("data-index-replace_function")),shimi.form.send(a,o,"PUT",t,this),!1},s=function(e,t,i,n){var r,a,s="indexes/"+e+"?rev="+t;return $.ajax({type:"DELETE",url:s,dataType:"json",contentType:"application/json",complete:function(e){204===e.status?(r="Success",a=i,n(),shimi.flash(r,a).highlight()):409===e.status?(a=JSON.parse(e.responseText),r=e.statusText,shimi.flash(r,a.message).error()):404===e.status&&(a="Index appears to have been deleted already.",r=e.statusText,shimi.flash(r,a).error())}}),!1};return e.init=function(e){var i=$(e).attr("data-index-id"),n="indexes/"+i,r=$("#index-conditions");return $.get(n,function(e){r.html(e),t().sortable(),shimi.ipreviewui.get()}),!1},e.save=function(){var t=i();if(0!==t.length){var n=function(){e.init(t),shimi.flash("Success","Your index has been saved.").highlight()};a(t,n)}else shimi.flash("Info","No index has been chosen to save.").highlight()},e.replace=function(){var t=i();return 0!==t.length?shimi.initReplaceDialog().dialog("open"):shimi.flash("Info","You must choose an index first.").highlight(),e},e.addCond=function(){var t=i();return 0!==t.length?shimi.initIndexBuilderDialog(t.attr("data-index-doctype")).dialog("open"):shimi.flash("Info","You must choose an index first.").highlight(),e},e.remCond=function(t){return $(t).closest("tr").remove(),e},e.newCond=function(){return shimi.initIndexNewDialog().dialog("open"),e},e.del=function(){var t=i();if(0!==t.length){var n=t.attr("data-index-id"),r=t.attr("data-index-rev"),a="Your index has been deleted.",o=function(){$("#index-conditions").empty(),shimi.ilistingui.init()};window.confirm("Are you sure?")&&s(n,r,a,o)}else shimi.flash("Info","No index has been chosen to delete.").highlight();return e},e}(),shimi.ihelpers=function(){var e={},t=shimi.sess();e.evs={};var i=function(e,t){return e.children().show(),t.forEach(function(t){e.children("option:contains("+t+")").hide()}),!1},n=function(e){var t=$("#builder-operator-input");switch(e.subcategory){case"select":case"docselect":case"text":case"textarea":i(t,["member","true"]);break;case"integer":case"rational":case"date":i(t,["member","true","match"]);break;case"boolean":case"openboolean":i(t,["equal","greater","less","member","match"]);break;case"multiselect":case"docmultiselect":i(t,["equal","greater","less","true","match"])}return!1};return e.alterArg=function(i,n,r,a){var s=function(){return t.get(r.val())};a();try{i.removeAttr("disabled").datepicker("destroy"),i.removeAttr("disabled").autocomplete("destroy")}catch(o){window.console.log(o.message)}var c=function(t,i){return"date"===i.subcategory?(t.removeAttr("disabled"),t.datepicker({dateFormat:"yy-mm-dd"})):(t.removeAttr("disabled"),t.autocomplete({source:i.allowed})),e},d=s();if(d)switch(n.val()){case"true":case"isDefined":case"blank":i.attr("disabled","disabled").val("");break;case"equal":case"member":case"greater":case"less":case"hasExactly":case"hasGreater":case"hasLess":c(i,d)}return e},e.alterOpts=function(t,i,r){return n(t),r(),e},e.fOpts=function(t,i,n){return $.get(t,function(e){i.html(e),n&&n()}),e},e.getFieldDoc=function(e,i,n,r){var a=t.get(e),s="doctypes/"+n+"/fieldsets/"+i+"/fields/"+e+"?format=json";return a?(r&&r(a),a):($.ajax({url:s,async:!1,dataType:"json",success:function(i){t.put(i),r&&r(t.get(e))}}),t.get(e))},e.evs.setIndexDoctypeEvents=function(t,i,n){return t.change(function(){var r,a="doctypes/"+t.val()+"/fieldsets";n&&(r=n()),e.fOpts(a,i,r)}),!1},e.evs.setIndexFieldsetEvents=function(t,i,n,r){return i.change(function(){var a;if("string"!=typeof t&&(t=t.val()),i.val()){var s="doctypes/"+t+"/fieldsets/"+i.val()+"/fields?as=options";r&&(a=r()),e.fOpts(s,n,a)}}),e},e.evs.setIndexFieldEvents=function(t,i,n,r){return n.change(function(){var a,s=n.val(),o=i.val();r&&(a=r()),s.isBlank()||e.getFieldDoc(s,o,t,function(e){shimi.ihelpers.alterOpts(e,s,a)})}),e},e.evs.setIndexOperatorEvents=function(t,i,n,r){return i.change(function(){var a;r&&(a=r()),e.alterArg(t,i,n,a)}),e},e}(),shimi.ilistingui=function(){var e={};
return e.init=function(){var t,i="indexes",n=$("#index-index-listing");return $.getJSON(i,function(e){t=templates["index-listing"].render(e),n.html(t)}),e},e}(),shimi.ipreviewui=function(){var e={},t=shimi.index;return e.get=function(i,n,r,a){var s=$("#index-editing-data").attr("data-index-id"),o="indexes/"+s+"/view",c=$("#index-list-view");return $("#index-filter-form input"),s&&t({url:o,target:c}).get(i,n,r,a),e},e}(),shimi.initIndexNewDialog=function(){var e=$("#index-doctype-input"),t=$("#index-fieldset-input").inputDisable(),i=$("#index-field-input").inputDisable(),n=$("#index-name-input"),r=$("#index-show_deleted-input"),a=shimi.ihelpers.evs,s=function(){a.setIndexDoctypeEvents(e,t,function(){return t.inputDisable(),i.inputDisable(),function(){t.inputEnable()}})},o=function(){a.setIndexFieldsetEvents(e,t,i,function(){return i.inputDisable(),function(){i.inputEnable()}})},c=function(e){return $('#index-new-dialog option[value="'+e+'"]').text()},d=function(){return[c(t.val()),c(i.val())].join(":")},u=$("#index-new-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var t=!0;if(t){var a={category:"index",name:n.val(),show_deleted:r.is(":checked"),conditions:[],doctype:e.val(),fields_label:[d()],fields:[i.val()]},s=function(e){shimi.ilistingui.init(),$(e).dialog("close")};shimi.form.send("indexes",a,"POST",s,this)}},Cancel:function(){$(this).dialog("close")}},close:function(){t.unbind("change"),e.unbind("change"),shimi.form.clear($(".input")).removeClass("ui-state-error")}});return s(),o(),u},shimi.initReplaceDialog=function(){var e=$("#index-replace_function-input"),t=$("#index-editing-data"),i=$("#index-remove_function-input");t.attr("data-index-replace_function")?e.val(t.attr("data-index-replace_function")):shimi.form.clear(e).removeClass("ui-state-error");var n=$("#index-replace-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){$(".input").removeClass("ui-state-error");var n=!0;i.is(":checked")?(t.removeAttr("data-index-replace_function"),$("#replace-function-message").empty()):(e.val().isBlank()?e.addClass("ui-state-error"):e.removeClass("ui-state-error"),n&&(t.attr("data-index-replace_function",e.val()),$("#replace-function-message").text("This index has a replacement function."))),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){shimi.form.clear(e).removeClass("ui-state-error")}});return n},shimi.projectui=function(){var e={},t=function(t){window.confirm("Are you sure? This is permanent.")&&$.ajax({type:"DELETE",url:"/projects/"+t,dataType:"json",contentType:"application/json",complete:function(t){204===t.status?e.init():window.alert("An error occurred"+t.status)}})};return e.add=function(){var t=$("#project-name"),i=$("#project-description"),n=$(".validate-tips"),r=$([]).add(t).add(i),a=$("#add-dialog").dialog({autoOpen:!1,modal:!0,buttons:{"Add project":function(){r.removeClass("ui-state-error");var a=shimi.form.checkLength(t,"project name",1,50,n);a&&($.ajax({type:"POST",url:"projects/index",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({name:t.val(),description:i.val()}),complete:function(t){201===t.status?e.init():window.alert("An error occurred"+t.status)}}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){r.val("").removeClass("ui-state-error")}});return a},e.del=function(i){var n=$(i).attr("id");return t(n),e},e.init=function(){var e="/projects/index";$.get(e,function(e){$("tbody").empty(),$("tbody").html(e)})},e}(),$(function(){$(".notification").hide(),$("#loading").hide(),$(document).ajaxStart(function(){$("#loading").show()}).ajaxStop(function(){$("#loading").hide()}),shimi.form.initDateFields(),$("#configuration").length>0&&(shimi.initTabs(),$(".simple-tabs").tabs()),$("#all-document-container").length>0&&shimi.documents.init(),$("#file-upload").length>0&&shimi.fm.init(),$("#all-index-container").length>0&&shimi.ilistingui.init(),$("#projects-container").length>0&&shimi.projectui.init()});
/*! Dictionary Maker - v0.1.0 - 2012-11-20
* http://ling.wisc.edu/
* Copyright (c) 2012 UW Madison Board of Regents; Licensed GNU GPLv3 */
function clickDispatch(e){var t=dispatcher({".add-button span":function(e){initFieldset(e.parent())},".remove-button span":function(e){removeFieldset(e.parent())},"#save-document-button span":function(e){saveDoc(e.parent())},"#create-document-button span":function(e){createDoc(e.parent())},"#clear-document-button span":function(e){clearDoc(e.parent())},"#document-edit-button span":function(e){editDoc(e.parent())},"#document-delete-button span":function(e){deleteDoc(e.parent())},"#document-restore-button span":function(e){restoreDoc(e.parent())},"#document-view-tree > ul > li > b":function(e){collapseToggle(e)},".revision-link":function(e){fetchRevision(e)},".expander":function(e){toggleTextarea(e)},"label span":function(e){showHelpDialog(e)}});t(e)}function buildUrl(e,t,n){return"/projects/"+e+"/doctypes/"+t+"/fieldsets/"+n}function fsContainer(e){return $("#container-"+e)}function dpath(e,t){var n=path(e,t);return n.doctype=!1,n}function fsInfo(e,t){return getValue("fieldset-"+e,t)}function fInfo(e,t){return getValue("field-"+e,t)}function dInfo(e,t){return getValue("document-"+e,t)}function loadHash(e){e&&getDocument(e)}function getIndex(e,t,n,r){var i="documents/index?",s=$("#index-index-input").val(),o=$("#index-limit").val()*1;if(!n){var u=$("#index-filter").val(),a=JSON.stringify(u);e=btoa(unescape(encodeURIComponent(a))),n=[],r=[]}e&&(i=i+"&startkey="+escape(atob(e)),t&&(i=i+"&startkey_docid="+t)),o?i=i+"&limit="+(o+1):($("#index-limit").val(25),i+="&limit=26"),s&&(i=i+"&index="+s),$.get(i,function(e){$("#document-index #index-listing").html(e),$("#previous-index-page").button({icons:{primary:"ui-icon-circle-arrow-w"}}).click(function(){getIndex(n.pop(),r.pop(),n,r)}),$("#next-index-page").button({icons:{secondary:"ui-icon-circle-arrow-e"}}).click(function(){var e=$(this).attr("data-startkey"),t=$(this).attr("data-startid"),i=$("#first-index-element").attr("data-first-key"),s=$("#first-index-element").attr("data-first-id");n.push(i),r.push(s),getIndex(e,t,n,r)}),n.length==0&&$("#previous-index-page").button("disable"),$("#next-index-page").attr("data-last-page")&&$("#next-index-page").button("disable"),$("nav.pager").buttonset()})}function fillQueryOptions(){var e="/projects/project-"+$("#container").attr("data-project-id")+"/indexes?as=options";$.get(e,function(e){$("#index-index-input").html(e)})}function fillFieldsets(){$(".fieldset-view").each(function(e,t){fsInfo("multiple",$(t))=="true"?fillMultiFieldsets(t):fillNormalFieldsets(t)}),afterEditRefresh()}function fillMultiFieldsets(e){e=$(e);var t=fsInfo("fieldset",e),n=$("#container-"+t),r=dpath(e,"fieldset");n.html(""),e.find(".multifield").each(function(e,t){initFieldset(n,function(e){fillFields($(t),e)})})}function fillNormalFieldsets(e){fillFields($(e))}function fillFields(e,t){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),$("#save-document-button").removeAttr("disabled"),e.find(".field-view").each(function(e,n){var r=$(n).attr("data-field-value"),i=$(n).attr("data-field-field");t||(t=$("body")),setFieldValue(t.find(".field[data-field-field="+i+"]"),r)})}function setFieldValue(e,t){e.is("input.boolean")?e.attr("checked",t=="true"):t&&e.is("select.multiselect")?e.val(t.split(",")):t&&(e.is("input.text")||e.is("select.file"))?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.is("textarea.textarea")?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.val(t)}function fieldsetsToObject(e){var t={fieldsets:[]};return e.find("fieldset").each(function(e,n){n=$(n);var r,i={id:fsInfo("fieldset",n),multiple:fsInfo("multiple",n)=="true",collapse:fsInfo("collapse",n)=="true",name:fsInfo("name",n),label:fsInfo("label",n),order:fsInfo("order",n)*1};r=fsContainer(i.id).children(".fields"),i.multiple?(i.multifields=[],r.each(function(e,t){t=$(t),i.multifields[e]=fieldsToObject(t,e)})):$.extend(i,fieldsToObject(r.first())),t.fieldsets[e]=i}),t}function fieldsToObject(e,t){e=e.children(".field-container").children(".field");var n={fields:[]};return e.each(function(e,r){r=$(r),n.fields[e]={id:fInfo("field",r),name:fInfo("name",r),label:fInfo("label",r),head:fInfo("head",r)=="true",reversal:fInfo("reversal",r)=="true",required:fInfo("required",r)=="true",min:dateOrNumber(fInfo("subcategory",r),fInfo("min",r)),max:dateOrNumber(fInfo("subcategory",r),fInfo("max",r)),instance:fInfo("instance",r),charseq:fInfo("charseq",r),regex:fInfo("regex",r),order:fInfo("order",r)*1,subcategory:fInfo("subcategory",r),value:getFieldValue(r)},t>=0&&(n.fields[e].index=t)}),n}function dateOrNumber(e,t){switch(e){case"date":return t;default:return stringToNumber(t)}}function getOpenboolean(e){switch(e){case"true":e=!0;break;case"false":e=!1;break;default:e=null}return e}function getNumber(e){return isBlank(e)?e="":isNaN(e)||(e*=1),e}function getMultiple(e){return e?e=e.map(function(e){return getEncoded(e)}):e=null,e}function getEncoded(e){return decodeURIComponent(e.replace(/\+/g," "))}function getFieldValue(e){var t;switch(fInfo("subcategory",e)){case"boolean":t=e.is("input:checkbox:checked");break;case"openboolean":t=getOpenboolean(e.val());break;case"integer":case"rational":t=getNumber(e.val());break;case"multiselect":case"docmultiselect":t=getMultiple(e.val());break;case"select":case"docselect":t=getEncoded(e.val());break;default:t=e.val()}return t}function removeFieldset(e){e.parent().remove()}function saveDoc(e){var t=e;if(t.hasClass("oldrev")&&!confirm("This data is from an older version of this document. Are you sure you want to restore it?"))return!1;var n=$("#edit-document-form"),r=dInfo("document",t),i=dInfo("rev",t),s="./documents/"+r+"?rev="+i,o={doctype:dInfo("doctype",t),description:dInfo("description",t)};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),t.button("disable"),$.extend(o,fieldsetsToObject(n)),$.ajax({type:"PUT",url:s,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(o),complete:function(e,n){if(e.status==204||e.status==200){var i="Success",s="Your document was saved.";getDocument(r,!0),getIndex(),flashHighlight(i,s),t.removeClass("oldrev"),t.button("enable")}else if(e.status==403)setInvalidError(e),t.button("enable");else if(e.status==409){var s=JSON.parse(e.responseText),i=e.statusText;flashError(i,s.message),t.button("enable")}}})}function createDoc(e){var t=e,n=$("#edit-document-form"),r={doctype:dInfo("doctype",t),description:dInfo("description",t)};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),t.button("disable"),$.extend(r,fieldsetsToObject(n));var i=$.ajax({type:"POST",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(r),complete:function(e,n){if(e.status==201){var r="Success",s="Your document was created.",o=i.getResponseHeader("Location").match(/[a-z0-9]*$/);$("#save-document-button").hide(),$("#save-document-button").attr("disabled","true"),$(".fields").remove(),initFieldsets(),getDocument(o),getIndex(),flashHighlight(r,s),t.button("enable")}else e.status==403&&(setInvalidError(e),t.button("enable"))}})}function clearDoc(e){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),$("#save-document-button").hide(),$("#save-document-button").attr("disabled","disabled"),$(".fields").remove(),initFieldsets()}function editDoc(e){resetFields(),$("#document-view-tree").hasClass("oldrev")?$("#save-document-button").addClass("oldrev"):$("#save-document-button").removeClass("oldrev"),fillFieldsets()}function deleteDoc(e){if(confirm("Are you sure?")){var t=dInfo("document",e),n=dInfo("rev",e);deleteDocument(t,n)}}function restoreDoc(e){if(confirm("Are you sure?")){var t=dInfo("document",e),n=dInfo("rev",e);restoreDocument(t,n)}}function collapseToggle(e){e.parent("li").toggleClass("collapsed")}function showHelpDialog(e){e.is(".label-text")&&(e=e.parent("label").find(".ui-icon-help")),$("#help-dialog").dialog().dialog("open").find("#help-dialog-text").html(e.attr("title"))}function toggleTextarea(e){var t=$("#"+e.attr("data-group-id"));t.toggleClass("expanded"),e.toggleClass("expanded")}function initEdit(){var e="documents/edit";return $.get(e,function(e){$("#document-edit").html(e),$("#edit-tabs").tabs(),setKeyboardEvents(),initFieldsets(),initEditButtons()}),!0}function setKeyboardEvents(){var e="input, select",t=$("#edit-tabs"),n=function(){var n=t.find(".ui-tabs-selected a").attr("href");$(n).find(e+", textarea").first().focus()};$(document).bind("keydown","Alt+p",function(e){var r=t.tabs("length"),i=t.tabs("option","selected");return i!=0?(t.tabs("select",i-1),n()):(t.tabs("select",r-1),n()),!1}),$(document).bind("keydown","Alt+n",function(e){var r=t.tabs("length"),i=t.tabs("option","selected");return i<r-1?(t.tabs("select",i+1),n()):(t.tabs("select",0),n()),!1})}function initEditButtons(){return initAddButton(),initSaveButton(),initCreateButton(),initClearButton(),!0}function initAddButton(){return $(".add-button").button({icons:{primary:"ui-icon-plus"}}),!0}function initRemoveButton(){return $(".remove-button").button({icons:{primary:"ui-icon-minus"}})}function initSaveButton(){return $("#save-document-button").button({icons:{primary:"ui-icon-disk"}}),$("#save-document-button").hide(),$("#save-document-button").attr("disabled","disabled")}function setInvalidError(e){var t=JSON.parse(e.responseText),n=e.statusText,r=$("[data-field-instance="+t.instance+"]"),i=$("[href=#"+r.parents("fieldset").attr("id")+"]").parent("li");i.addClass("ui-state-error"),r.addClass("ui-state-error"),flashError(n,t.fieldname+" "+t.message)}function initCreateButton(){return $("#create-document-button").button({icons:{primary:"ui-icon-document"}})}function initClearButton(){return $("#clear-document-button").button({icons:{primary:"ui-icon-refresh"}})}function afterEditRefresh(){var e=$("#save-document-button"),t=$("#document-edit-button"),n=["data-document-id","data-document-rev"];return n.forEach(function(n){e.attr(n,t.attr(n))}),e.show(),afterRefresh(),!0}function afterFreshRefresh(){return initRemoveButton(),afterRefresh(),!0}function afterRefresh(){return initDateFields(),initInstances(),!0}function resetFields(){$(".field").each(function(e){var t=$(this),n=t.attr("data-field-default");n&&n!=""?t.is("select.multiselect")?t.val(n.split(",")):t.is("input.boolean")?t.attr("checked",n==1):t.val(n):(t.val(""),t.removeAttr("checked"))})}function getDocument(e,t){var n="documents/"+e;$("#document-view").fadeTo("slow",1),$.get(n,function(e){$("#document-view").html(e),formatTimestamps(),t&&afterEditRefresh();var n=$("#document-restore-button"),r=$("#document-edit-button"),i=$("#document-delete-button");r.button({icons:{primary:"ui-icon-pencil"}}),i.button({icons:{primary:"ui-icon-trash"}}),n.button({icons:{primary:"ui-icon-refresh"}}),dInfo("deleted",n)==="true"?(r.hide(),i.hide()):n.hide()})}function restoreDocument(e,t){var n="./documents/"+e+"?rev="+t,r=$("#document-restore-button");$.ajax({type:"DELETE",url:n,dataType:"json",contentType:"application/json",complete:function(t,n){if(t.status==200){var r="Success",i="Your document was restored.";getDocument(e,function(){getIndex()}),flashHighlight(r,i)}else if(t.status==409){var i=JSON.parse(t.responseText),r=t.statusText;flashError(r,i.message)}else if(t.status==404){var i="Document was erased and cannot be restored.",r=t.statusText;flashError(r,i)}}})}function deleteDocument(e,t){var n="./documents/"+e+"?rev="+t,r=$("#document-restore-button");$.ajax({type:"DELETE",url:n,dataType:"json",contentType:"application/json",complete:function(e,t){if(e.status==200){var n="Success",i="Your document was deleted.",s=JSON.parse(e.responseText);putValue("document-rev",s.rev,r),$("#document-delete-button").hide(),$("#document-edit-button").hide(),r.show(),$("#document-view h2").text("Deleted Document"),$("#document-view").fadeTo("slow",.5),getIndex(),flashHighlight(n,i)}else if(e.status==409){var i=JSON.parse(e.responseText),n=e.statusText;flashError(n,i.message)}else if(e.status==404){var i="Document appears to have been deleted already.",n=e.statusText;flashError(n,i)}}})}function path(e,t,n){var r={};if(t)var i=t+"-";else var i="";return n?r.string=n+"/":r.string="",r.category=t,r.origin=e,r.type=i+"path",r.valid_components=["doctype","fieldset","field"],r.valid_components.forEach(function(e){r[e]=function(){var t=getValue(i+e,r.origin);return t}()}),r.rev=getValue(i+"rev",r.origin),r.doctype=getValue(i+"doctype",r.origin),r.send=function(e,t,n,i){return sendConfigDoc(r.toString(),e,t,n,i),r},r.put=function(e,t,n){return r.send(e,"PUT",t,n),r},r.post=function(e,t,n){return r.send(e,"POST",t,n),r},r.delete=function(e,t){return r.send({},"DELETE",e,t),r},r.toString=function(){var e,t=r.string.concat(r.valid_components.map(function(e){var t=e+"s",n=r[e],i=null;return n?i=t+"/"+n:e==r.category&&(i=t),i}).filter(function(e){return typeof e=="string"&&!e.isBlank()}).join("/"));return r.rev&&(t=t.concat("?rev="+r.rev)),t},r}function addProjectDialog(){var e=$("#project-name"),t=$("#project-description"),n=$(".validate-tips"),r=$([]).add(e).add(t),i=$("#add-dialog").dialog({autoOpen:!1,modal:!0,buttons:{"Add project":function(){r.removeClass("ui-state-error"),checkResult=checkLength(e,"project name",1,50,n),checkResult&&($.ajax({type:"POST",url:"projects/index",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({name:e.val(),description:t.val()}),complete:function(e,t){e.status==201?populateProjectsTable():alert("An error occurred"+e.status)}}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){r.val("").removeClass("ui-state-error")}});return i}function deleteProject(e){confirm("Are you sure? This is permanent.")&&$.ajax({type:"DELETE",url:"/projects/"+e,dataType:"json",contentType:"application/json",complete:function(e,t){e.status==204?populateProjectsTable():alert("An error occurred"+e.status)}})}function populateProjectsTable(){var e="/projects/index";$.get(e,function(e){$("tbody").empty(),$("tbody").html(e),$(".configure-button").button({icons:{primary:"ui-icon-wrench"}}),$(".delete-button").button({icons:{primary:"ui-icon-trash"}}).click(function(e){id=$(e.target).attr("id"),deleteProject(id),$("#delete-dialog").dialog("open")})})}function clickDispatch(e){var t=dispatcher({".edit-field-button span":function(e){editFieldButton(e.parent("a"))},".delete-field-button span":function(e){deleteFieldButton(e.parent("a"))},".add-field-button span":function(e){addFieldButton(e.parent("a"))},".edit-fieldset-button span":function(e){editFieldsetButton(e.parent("a"))},".delete-fieldset-button span":function(e){deleteFieldsetButton(e.parent("a"))},".add-fieldset-button span":function(e){addFieldsetButton(e.parent("a"))},".delete-doctype-button span":function(e){deleteDoctypeButton(e.parent("a"))},".edit-doctype-button span":function(e){editDoctypeButton(e.parent("a"))},".touch-doctype-button span":function(e){touchDoctypeButton(e.parent("a"))},"#doctype-add-button span":function(e){addDoctypeButton(e.parent("a"))},".delete-charseq-button span":function(e){deleteCharseqButton(e.parent("a"))},".edit-charseq-button span":function(e){editCharseqButton(e.parent("a"))},"#charseq-add-button span":function(e){addCharseqButton(e.parent("a"))},"#maintenance-upgrade-button span":function(e){upgradeButton(e.parent("a"))}});t(e)}function fieldsetDialog(e,t){var n=fieldsetElems().get(t),r=$("#fieldset-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.getFieldsetInputVals(),i=function(t){e.fieldset=!1,e.rev=!1,populateFieldsets(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.fieldset,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r}function fieldsetElems(){var e={};return e.attrs=["name","label","order","description","doctype","rev","multiple","collapse","fieldset"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t]),n[t].is("input[type=checkbox]")&&e[t]=="true"&&n[t].attr("checked",!0)}),n},n.getFieldsetInputVals=function(){var e={category:"fieldset",name:n.name.val(),label:n.label.val(),order:n.order.val()*1,description:n.description.val(),doctype:n.doctype.val(),multiple:n.multiple.is(":checked"),collapse:n.collapse.is(":checked")};return e},n.clear=function(){return clearValues($("#fieldset-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#fieldset-"+e+"-input")}),n.copyValues(t),n},e}function doctypeDialog(e,t){var n=doctypeElems().get(t);t.rev&&!t.rev.isBlank()&&n.doctype.attr("disabled","disabled");var r=$("#doctype-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.getDoctypeInputVals(),i=function(e){populateDoctypeTabs(),$(e).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.doctype,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r}function fieldDialog(e,t){var n=fieldElems().get(t),r=$("#field-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.clearDisabled().getFieldInputVals(),i=function(t){populateFields(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.field,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r}function fieldElems(){var e={};return e.attrs=["name","label","order","description","subcategory","head","reversal","default","required","allowed","source","max","min","regex","doctype","fieldset","charseq","rev","field"],e.get=function(t){var n={};return n.attrs=e.attrs,n.notDefault=function(){return[n.charseq,n.allowed,n.source,n.min,n.max,n.regex]},n.disable=function(){return n.notDefault().forEach(function(e){e.attr("disabled","disabled")}),n},n.clearDisabled=function(){return n.notDefault().forEach(function(e){e.attr("disabled")&&e.val("")}),n},n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t]),n[t].is("input[type=checkbox]")&&e[t]=="true"&&n[t].attr("checked",!0)}),n},n.getFieldInputVals=function(){var e={category:"field",name:n.name.val(),label:n.label.val(),"default":n.decodeDefaults(n.subcategory.val(),n.default.val()),head:n.head.is(":checked"),reversal:n.reversal.is(":checked"),required:n.required.is(":checked"),order:n.order.val()*1,allowed:n.allowed.val().split(",").trimAll(),source:n.decodeSource(n.subcategory.val(),n.source.val()),min:n.decodeBound(n.subcategory.val(),n.min.val()),max:n.decodeBound(n.subcategory.val(),n.max.val()),regex:n.regex.val(),description:n.description.val(),charseq:n.charseq.val(),doctype:n.doctype.val(),fieldset:n.fieldset.val(),subcategory:n.subcategory.val()};return e},n.clear=function(){return clearValues($("#field-dialog .input")).removeClass("ui-state-error"),n.disable(),n},n.decodeBound=function(e,t){switch(e){case"date":return t;default:return stringToNumber(n.min.val())}},n.decodeSource=function(e,t){switch(e){case"file":return t.split("/").trimAll();default:return t}},n.decodeDefaults=function(e,t){switch(e){case"docmultiselect":case"multiselect":return t.split(",").trimAll();case"file":return t.split("/").trimAll();default:return t}},n.displayFields=function(e){switch(e){case"select":case"multiselect":n.disable(),n.allowed.removeAttr("disabled");break;case"docselect":case"docmultiselect":case"file":n.disable(),n.source.removeAttr("disabled");break;case"text":case"textarea":n.disable(),n.charseq.removeAttr("disabled"),n.regex.removeAttr("disabled");break;case"date":case"integer":case"rational":n.disable(),n.min.removeAttr("disabled"),n.max.removeAttr("disabled");break;default:n.disable()}},n.attrs.forEach(function(e){n[e]=$("#field-"+e+"-input")}),n.copyValues(t),n.displayFields(n.subcategory.val()),n.subcategory.change(function(){n.displayFields(n.subcategory.val())}),n},e}function cpath(e,t){return path(e,t,"config")}function populateFields(e){e.field=!1,$.get(e.toString(),function(t){var n=$("#fields-"+e.fieldset);n.empty(),n.html(t),$(".link-button").button()})}function populateFieldsets(e){$.get(e.toString(),function(t){var n=$("#fieldsets-"+e.doctype);n.empty(),n.accordion("destroy"),n.html(t),$(".link-button").button(),n.accordion({autoHeight:!1,collapsible:!0,active:!1})})}function populateDoctypeTabs(){var e="config/doctypes";$.get(e,function(e){var t=$("#fieldset-doctype-input");$("#doctype-tabs-headings").empty(),$("#doctype-tabs-headings + .ui-tabs-panel").remove(),$("#doctype-tabs").tabs("destroy"),$("#doctype-tabs-headings").html(e),$(".link-button").button();var n=function(e,t){var n=$(t.panel).children("div[data-fieldset-doctype]"),r=path(n,"fieldset","config");populateFieldsets(r)};$("#doctype-tabs").tabs({load:function(e,t){n(e,t)}})})}function populateCharseqTabs(){var e="config/charseqs";$.get(e,function(e){$("#charseq-tabs-headings").empty(),$("#charseq-tabs-headings + .ui-tabs-panel").remove(),$("#charseq-tabs").tabs("destroy"),$("#charseq-tabs-headings").html(e);var t=function(e,t){$(".link-button").button()};$("#charseq-tabs").tabs({load:function(e,n){t(e,n)}})})}function initTabs(){return $("#doctype-tabs").tabs(),populateDoctypeTabs(),$("#main-tabs").tabs(),$("#charseq-tabs").tabs(),populateCharseqTabs(),!0}function initHelpText(){return $("#doctype-info").hide(),$("#charseq-info").hide(),$("#doctype-info-toggle").click(function(){return $("#doctype-info").toggle("blind",{},500),!1}),$("#charseq-info-toggle").click(function(){return $("#charseq-info").toggle("blind",{},500),!1}),!0}function doctypeElems(){var e={};return e.attrs=["description","doctype","rev"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t])}),n},n.getDoctypeInputVals=function(){var e={category:"doctype",description:n.description.val(),_id:n.doctype.val()};return e},n.clear=function(){return clearValues($("#doctype-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#doctype-"+e+"-input")}),n.copyValues(t),n},e}function charseqDialog(e){var t=charseqElems().get(e),n=$("#charseq-dialog").dialog({width:650,autoOpen:!1,modal:!0,buttons:{Save:function(){var n=t.getCharseqInputVals(),r="config/charseqs",i="POST",s=function(e){populateCharseqTabs(),$(e).dialog("close")};e.rev&&!e.rev.isBlank()&&(i="PUT",r="config/charseqs/"+n._id+"?rev="+n.rev),sendConfigDoc(r,n,i,s,this)},Cancel:function(){$(this).dialog("close")}},close:function(){t.clear()}});return n}function setIndexDoctypeEvents(e,t,n){return e.change(function(){var r="doctypes/"+e.val()+"/fieldsets",i;n&&(i=n()),fillOptionsFromUrl(r,t,i)}),!1}function setIndexFieldsetEvents(e,t,n,r){return t.change(function(){var i;typeof e!="string"&&(e=e.val());if(t.val()){var s="doctypes/"+e+"/fieldsets/"+t.val()+"/fields?as=options";r&&(i=r()),fillOptionsFromUrl(s,n,i)}}),!1}function setIndexFieldEvents(e,t,n,r){return n.change(function(){var i=n.val(),s=t.val(),o;r&&(o=r()),i.isBlank()||getFieldDoc(i,s,e,function(e){alterOperatorField(e,i,o)})}),!1}function setIndexOperatorEvents(e,t,n,r){return t.change(function(){var i;r&&(i=r()),alterArgumentField(e,t,n,i)}),!1}function putDoc(e){return sessionStorage[e._id]||(sessionStorage[e._id]=JSON.stringify(e)),e._id}function getDoc(e){var t=sessionStorage[e];return t?JSON.parse(t):null}function initIndexNewDialog(){var e=$("#index-doctype-input"),t=$("#index-fieldset-input").inputDisable(),n=$("#index-field-input").inputDisable(),r=$("#index-name-input"),i=$("#index-show_deleted-input"),s=function(){setIndexDoctypeEvents(e,t,function(){return t.inputDisable(),n.inputDisable(),function(){t.inputEnable()}})},o=function(){setIndexFieldsetEvents(e,t,n,function(){return n.inputDisable(),function(){n.inputEnable()}})},u=function(e){return $('#index-new-dialog option[value="'+e+'"]').text()},a=function(){return[u(t.val()),u(n.val())].join(":")},f=$("#index-new-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var t=!0;if(t){var s={category:"index",name:r.val(),show_deleted:i.is(":checked"),conditions:[],doctype:e.val(),fields_label:[a()],fields:[n.val()]},o=function(e){initIndexIndex(),$(e).dialog("close")};sendConfigDoc("indexes",s,"POST",o,this)}},Cancel:function(){$(this).dialog("close")}},close:function(){t.unbind("change"),e.unbind("change"),clearValues($(".input")).removeClass("ui-state-error")}});return s(),o(),f}function getValue(e,t){var n=function(e,t,r){var i=t.attr("data-group-id"),s=$("#"+i),o=s.attr("data-"+e),u=s.attr("data-group-id");return o===undefined&&u!==undefined&&i!==u?n.r(e,s,r):r.r(o)};return n.t(e,t,identity)}function putValue(e,t,n){var r=n.attr("data-group-id");$("#"+r).attr("data-"+e,t)}function isBlank(e){return/^\s*$/.test(e)||e===null||e===undefined||typeof e=="number"&&isNaN(e)||Object.prototype.toString.call(e)==="[object Array]"&&e.length===0}function stringToNumber(e){return typeof e=="string"&&!isNaN(e)&&e!==""?e*1:""}function dispatcher(e){var t=function(t){var n=$(t.target);Object.keys(e).forEach(function(t){if(n.is(t)){var r=e[t];r(n)}})};return t}function clearValues(e){return e.each(function(e){var t=$(this);t.attr("data-retain")||(t.is(":checked")&&t.attr("checked",!1),t.val(""))}),e}function sendConfigDoc(e,t,n,r,i){var s;t&&(s=JSON.stringify(t)),$.ajax({type:n,url:e,dataType:"json",context:i,contentType:"application/json",processData:!1,data:s,complete:function(e,t){if(e.status>=200&&e.status<300)r(this,e);else if(e.status==500)flashError("Unknown Server Error","Please report that you received this message");else if(e.status>=400){var n=JSON.parse(e.responseText),i=e.statusText;flashError(i,n.fieldname+" "+n.message)}}})}function updateTips(e,t){t.text(e).addClass("ui-state-highlight"),setTimeout(function(){t.removeClass("ui-state-highlight",1500)},500)}function checkLength(e,t,n,r,i){return e.val().length>r||e.val().length<n?(e.addClass("ui-state-error"),updateTips("Length of "+t+" must be between "+n+" and "+r+".",i),!1):!0}function checkRegexp(e,t,n,r){return t.test(e.val())?!0:(e.addClass("ui-state-error"),updateTips(n,r),!1)}function initDateFields(){$(".date").datepicker({dateFormat:"yy-mm-dd"})}(function(e){function t(t){if(typeof t.data!="string")return;var n=t.handler,r=t.data.toLowerCase().split(" ");t.handler=function(t){var i=t.type!=="keypress"&&e.hotkeys.specialKeys[t.which],s=String.fromCharCode(t.which).toLowerCase(),o,u="",a={};t.altKey&&i!=="alt"&&(u+="alt+"),t.ctrlKey&&i!=="ctrl"&&(u+="ctrl+"),t.metaKey&&!t.ctrlKey&&i!=="meta"&&(u+="meta+"),t.shiftKey&&i!=="shift"&&(u+="shift+"),i?a[u+i]=!0:(a[u+s]=!0,a[u+e.hotkeys.shiftNums[s]]=!0,u==="shift+"&&(a[e.hotkeys.shiftNums[s]]=!0));for(var f=0,l=r.length;f<l;f++)if(a[r[f]])return n.apply(this,arguments)}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})})(jQuery);var jumpForm=function(){$("#view-jump-id").live("keydown",function(e){if(e.which===13){var t=$("#view-jump-id").val();loadDocument(t)}return!0})},searchForm=function(){searches.clearSearchVals(!0),searches.loadSearchVals(),searchAllFieldsSwitch(),searchFieldItems(),fieldViews(),excludeCheck(),searchIndex(),$("#document-search-term").live("keydown",function(e){return e.which===13?(searches.getSearch(),!1):!0})},searchAllFieldsSwitch=function(){$("#search-all-fields-switch a").live("click",function(){searches.clearSearchVals()})},searchFieldItems=function(){$(".search-field-item").live("click",function(e){searches.removeSearchField(e)})},fieldViews=function(){$(".search-result-field-id a, .field-view b, .field-container label span").live("dblclick",function(e){searches.addSearchField(e)})},searchIndex=function(){$("#index-index-input-label").live("dblclick",function(e){searches.addSearchIndex(e)})},excludeCheck=function(){$("#document-search-exclude").live("change",function(e){searches.toggleExclusion(e)})},loadDocument=function(e){$("#document-view").html("<em>Loading...</em>"),clearDoc(),getDocument(e)},documentLinks=function(){$(".view-document-link").live("click",function(){loadDocument(this.hash.slice(1))})};$(function(){var e;$("body").click(function(e){clickDispatch(e)}),documentLinks(),fillQueryOptions(),getIndex(),jumpForm(),searchForm(),initEdit(),$("#index-filter-form input").keyup(function(){clearTimeout(e),e=setTimeout(function(){getIndex()},500)}),$("#index-filter-form select").change(function(){getIndex()}),loadHash($(location)[0].hash.split("#")[1])});var searches={getSearch:function(){var e=$("#document-search-term").val(),t="documents/search?q="+encodeURIComponent(e),n=$("#document-search-field").val(),r=$("#document-search-exclude").is(":checked"),i=$("#document-search-index").val(),s=searches.fieldLookup();i?t=t+"&index="+i:(n&&(t=t+"&field="+n),r&&(t+="&exclude=true")),$("#search-listing").hide(),$.get(t,function(t){$("#search-listing").html(t),$(".search-result-field-id").each(function(e,t){var n=s[$(t).attr("data-field-field")],r=$(t).children("a").first();r.html(n),r.attr("data-search-label",n)}),$(".search-results th").each(function(t,n){var r=$.trim($(n).children("a").html()),i=new RegExp("("+e+")","g"),s=r.replace(i,"<span class='highlight'>$1</span>");$(n).children("a").html(s)}),$("#search-listing").show()})},fieldLookup:function(){var e={};return $("fieldset").each(function(t,n){var r=$(n).attr("data-fieldset-label");$(n).find(".field-container").each(function(t,n){var i=$(n).attr("data-field-field"),s=$(n).find(".label-text").first().text();e[i]=r+": "+s})}),e},lookup:function(e){var t=localStorage.getItem(e);return t===""||t==="null"?null:t},excludedVal:function(){var e=$("#document-search-exclude").is(":checked");return e?e:null},toggleExclusion:function(e){var t=searches.excludedVal(),n=$("#search-exclude-label");t?n.show():n.hide(),localStorage.setItem("searchExclude",t)},clearSearchVals:function(e){$("#document-search-field").val(null),$("#document-search-index").val(null),$("#document-search-exclude:checked").click(),$(".search-optional, #search-exclude-label").hide(),$(".search-field-item").remove(),$("#search-index-label").empty(),e||(localStorage.setItem("searchLabels",null),localStorage.setItem("searchFields",null),localStorage.setItem("searchExclude",null),localStorage.setItem("searchIndex",null),localStorage.setItem("searchIndexLabel",null))},loadSearchVals:function(){var e=searches.lookup("searchIndex"),t=searches.lookup("searchFields");e!==null?($("#document-search-index").val(e),$("#search-index-label").html(localStorage.getItem("searchIndexLabel")),$(".search-optional").show(),$("#document-search-exclude").parent("div").hide()):t!==null&&($("#document-search-field").val(t),$("#search-field-label").html(localStorage.getItem("searchLabels")),searches.lookup("searchExclude")!=searches.excludedVal()&&$("#document-search-exclude").click(),$(".search-optional").show())},updateSearchVals:function(e,t,n,r){r?(localStorage.setItem("searchIndex",r),localStorage.setItem("searchIndexLabel",t),localStorage.setItem("searchLabels",null),localStorage.setItem("searchFields",null),localStorage.setItem("searchExclude",null)):(localStorage.setItem("searchIndex",null),localStorage.setItem("searchIndexLabel",null),localStorage.setItem("searchLabels",t),localStorage.setItem("searchFields",e),localStorage.setItem("searchExclude",n))},removeSearchField:function(e){var t=$(e.target),n=t.attr("data-index"),r=$("#document-search-field"),i=r.val(),s=JSON.parse(i),o=searches.excludedVal(),u=null;if(s.length===1)searches.clearSearchVals();else{var a=s.indexOf(n);a>=0&&(s.splice(a,1),u=JSON.stringify(s),r.val(JSON.stringify(s))),t.remove()}searches.updateSearchVals(u,$("#search-field-label").html(),o)},addSearchIndex:function(e){var t=$("#index-index-input").val(),n=$("option[value="+t+"]").text();validID(t)&&($("#search-all-fields-switch").show(),$("#search-field-label").hide(),$("#search-exclude-label").empty(),$("#document-search-field").val(null),$("#document-search-exclude").parent("div").hide(),$("#search-index-label").html(n).show(),$("#document-search-index").val(t),searches.updateSearchVals(null,n,null,t))},addSearchField:function(e){var t=$(e.target).closest("[data-field-field]").attr("data-field-field");if(validID(t)){var n=searches.fieldLookup()[t],r=$("#document-search-field"),i=r.val(),s=$("#search-field-label"),o=searches.excludedVal(),u,a=null,f='<a href="#" data-index="'+t+'" class="search-field-item" title="click to remove">'+n+"</a>",l=function(e){s.html()?s.children().last().after(f):s.html(f),a=JSON.stringify(e),r.val(a),searches.updateSearchVals(a,s.html(),o)};if(i!==""){var c=JSON.parse(i);c.indexOf(t)<0&&(u=c.concat(t),l(u))}else u=[t],l(u);$(".search-optional").show()}}},fetchRevision=function(e){var t=dInfo("document",e),n=dInfo("rev",e),r=e.attr("data-document-oldrev");n!=r?$("#document-view-tree").addClass("oldrev"):$("#document-view-tree").removeClass("oldrev"),getRevision(t,r)},ifStoredElse=function(e,t,n){var r=null;r=localStorage.getItem(e),r?t(r):$.get(e,n)},initFieldsets=function(){var e,t=$("#create-document-button"),n=dInfo("doctype",t),r=n+"_version",i=localStorage.getItem(r),s=dInfo("version",t);return e=i!=s,localStorage.setItem(r,s),$("fieldset").each(function(t,n){initFieldset(n,!1,e)}),!0},initFieldset=function(e,t,n){var r=dpath($(e),"fieldset").toString(),i=fsInfo("fieldset",$(e)),s=$("#container-"+i),o=function(e){s.append(e),initFields(s,t,n)},u=function(e){localStorage.setItem(r,e),o(e)};return n&&localStorage.removeItem(r),ifStoredElse(r.toString(),o,u),!1},initFields=function(e,t,n){var r=dpath(e,"field"),i=e.children(".fields").last(),s=function(e){i.prepend(e),t&&t(i),afterFreshRefresh()},o=function(e){localStorage.setItem(r,e),s(e)};return n&&localStorage.removeItem(r),ifStoredElse(r.toString(),s,o),!0},initInstances=function(){var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],t=function(){return e.map(function(){return e[Math.floor(Math.random()*e.length)]}).join("")};return $("[data-field-instance]").each(function(e,n){var r=t();$(n).first().attr("data-field-instance",r),$(n).first().attr("data-group-id",r),$(n).first().attr("id",r),$(n).first().next(".expander").attr("data-group-id",r),$(n).first().next().next(".expander").attr("data-group-id",r)}),!0},formatTimestamps=function(){$(".timestamp").each(function(e,t){var n=(new Date($(t).text())).toLocaleString();n!=="Invalid Date"&&$(t).text(n)})},getRevision=function(e,t){var n="documents/"+e+"/"+t,r=$("#document-view-tree");r.hide(),$.get(n,function(e){r.html(e),formatTimestamps(),r.show()})};$(function(){populateProjectsTable(),$("#create-project").button({icons:{primary:"ui-icon-plus"}}).click(function(){addProjectDialog().dialog("open")})}),$(function(){$("body").click(function(e){clickDispatch(e)}),initTabs(),initHelpText(),$(".link-button").button(),$(".simple-tabs").tabs()});var charseqElems=function(){var e={};return e.attrs=["description","characters","name","sort_ignore","locale","tailoring","vowels","consonants","ietf_tag","iso639_tag","charseq","rev"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t])}),n},n.getCharseqInputVals=function(){var e={category:"charseq",description:n.description.val(),characters:n.parse(n.characters.val()),name:n.name.val(),sort_ignore:n.parse(n.sort_ignore.val()),locale:n.locale.val(),tailoring:n.tailoring.val(),vowels:n.parse(n.vowels.val()),consonants:n.parse(n.consonants.val()),ietf_tag:n.ietf_tag.val(),iso639_tag:n.iso639_tag.val(),_id:n.charseq.val()||undefined,rev:n.rev.val()||undefined};return e},n.parse=function(e){return e&&!e.isBlank()?JSON.parse(e):[]},n.clear=function(){return clearValues($("#charseq-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#charseq-"+e+"-input")}),n.copyValues(t),n},e},addCharsec=function(e){$("#charseq-add-dialog").dialog("open")},addDoctype=function(e){initDoctypeAddDialog().dialog("open")},editFieldButton=function(e){var t=cpath(e,"field"),n={},r=fieldElems().attrs,i="config/charseqs?as=options";$.get(i,function(i){$("#field-charseq-input").html(i),r.forEach(function(t){n[t]=getValue("field-"+t,e)}),fieldDialog(t,n).dialog("open")})},deleteFieldButton=function(e){var t=confirm("Are you sure? This is permanent.");if(t){var n=cpath(e,"field"),r=function(){n.field=!1,n.rev=!1,populateFields(n)};n.delete(r,this)}},addFieldButton=function(e){var t=cpath(e,"field"),n="config/charseqs?as=options";$.get(n,function(e){$("#field-charseq-input").html(e),fieldDialog(t,{fieldset:t.fieldset,doctype:t.doctype}).dialog("open")})},editFieldsetButton=function(e){var t=cpath(e,"fieldset"),n={},r=fieldsetElems().attrs;r.forEach(function(t){n[t]=getValue("fieldset-"+t,e)}),fieldsetDialog(t,n).dialog("open")},deleteFieldsetButton=function(e){var t=cpath(e,"fieldset"),n=function(){t.fieldset=!1,t.rev=!1,populateFieldsets(t)};confirm("Are you sure? This is permanent.")&&t.delete(n,this)},addFieldsetButton=function(e){var t=cpath(e,"fieldset");fieldsetDialog(t,{doctype:t.doctype}).dialog("open")},editCharseqButton=function(e){var t={},n=charseqElems().attrs;n.forEach(function(n){t[n]=getValue("charseq-"+n,e)}),charseqDialog(t).dialog("open")},deleteCharseqButton=function(e){var t=getValue("charseq-charseq",e),n=getValue("charseq-rev",e),r="config/charseqs/"+t+"?rev="+n,i=function(){populateCharseqTabs()};confirm("Are you sure? This is permanent.")&&sendConfigDoc(r,{},"DELETE",i,this)},editDoctypeButton=function(e){var t=cpath(e,"doctype"),n={},r=doctypeElems().attrs;r.forEach(function(t){n[t]=getValue("doctype-"+t,e)}),doctypeDialog(t,n).dialog("open")},touchDoctypeButton=function(e){var t=getValue("doctype-doctype",e);$.post("config/doctypes/"+t+"/touch"),alert("Touch In Progress")},upgradeButton=function(e){$.post("config/upgrade"),alert("Upgrade In Progress")},deleteDoctypeButton=function(e){var t=cpath(e,"doctype"),n=function(){t.doctype=!1,t.rev=!1,populateDoctypeTabs()};confirm("Are you sure? This is permanent.")&&t.delete(n,this)},addDoctypeButton=function(e){var t=cpath(e,"doctype");doctypeDialog(t,{}).dialog("open")},addCharseqButton=function(e){charseqDialog({}).dialog("open")},initIndexBuilderDialog=function(e){var t=$("#builder-or-input"),n=$("#builder-paren-input"),r=$("#builder-negate-input"),i=$("#builder-operator-input").inputDisable(),s=$("#builder-argument-input").inputDisable(),o=$("#builder-fieldset-input").inputDisable(),u=$("#builder-field-input").inputDisable(),a=[i,o,u],f="doctypes/"+e+"/fieldsets",l="indexes/condition";$(".ui-helper-reset div").show();var c=function(e){var t=$("#index-conditions-listing tbody");return t.append(e),t.sortable(),initConditionRemoveButtons(t),!1};fillOptionsFromUrl(f,o,function(){o.inputEnable()}),t.change(function(){t.is(":checked")?($("#builder-conditions").hide(),$("#builder-parens").hide()):($("#builder-conditions").show(),$("#builder-parens").show())}),n.change(function(){n.val()?($("#builder-or").hide(),$("#builder-conditions").hide()):($("#builder-or").show(),$("#builder-conditions").show())});var h=function(){setIndexFieldsetEvents(e,o,u,function(){return i.inputDisable(),u.inputDisable(),s.inputDisable(),function(){u.inputEnable()}})},p=function(){setIndexFieldEvents(e,o,u,function(){return i.inputDisable(),s.inputDisable(),function(){i.inputEnable()}})},d=function(){setIndexOperatorEvents(s,i,u,function(){return s.inputDisable(),function(){s.inputEnable()}})},v=$("#index-builder-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var e=!0;!t.is(":checked")&&!n.val()&&a.forEach(function(t){t.val().isBlank()?(t.addClass("ui-state-error"),e=!1):t.removeClass("ui-state-error")}),e&&(t.is(":checked")?$.get(l,{is_or:!0},function(e){c(e)}):n.val()?$.get(l,{is_or:!1,parens:n.val(),negate:!1},function(e){c(e)}):$.get(l,{is_or:!1,parens:!1,negate:r.is(":checked"),fieldset:o.val(),field:u.val(),operator:i.val(),argument:s.val()},function(e){c(e)}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){$("#builder-conditions").show(),o.unbind("change"),u.unbind("change"),i.unbind("change"),clearValues($(".input")).removeClass("ui-state-error")}});return h(),p(),d(),v},initIndexNewButton=function(){return $("#new-index-button").button({icons:{primary:"ui-icon-plus"}}).click(function(){initIndexNewDialog().dialog("open")}),!1},initConditionRemoveButtons=function(e){return e.find(".remove-condition-button").button({icons:{primary:"ui-icon-minus"}}).click(function(e){$(e.target).closest("tr").remove()}),!1},initIndexDeleteButton=function(e,t){return e.button({icons:{primary:"ui-icon-trash"}}).click(function(e){var n=t();if(!n.length<1){var r=$(e.target),i=n.attr("data-index-id"),s=n.attr("data-index-rev"),o="Your index has been deleted.",u=function(){$("#index-conditions").empty(),initIndexIndex()};confirm("Are you sure?")&&deleteIndex(i,s,o,u)}else flashHighlight("Info","No index has been chosen to delete.")}),!1},initIndexAddConditionButton=function(e,t){return e.button({icons:{primary:"ui-icon-plus"}}).click(function(e){var n=t();!n.length<1?initIndexBuilderDialog(n.attr("data-index-doctype")).dialog("open"):flashHighlight("Info","You must choose an index first.")}),!1},initReplaceButton=function(e,t){return e.button({icons:{primary:"ui-icon-shuffle"}}).click(function(e){var n=t();!n.length<1?initReplaceDialog().dialog("open"):flashHighlight("Info","You must choose an index first.")}),!1},initIndexEditButtons=function(e){return initIndexSaveButton($("#save-index-button"),e),initIndexDeleteButton($("#delete-index-button"),e),initIndexAddConditionButton($("#add-index-condition-button"),e),initReplaceButton($("#replace-button"),e),!1},initIndexSaveButton=function(e,t){var n,r;e.button({icons:{primary:"ui-icon-document"}}).click(function(e){r=t(),!r.length<1?(n=function(){getIndexEdit(r.attr("data-index-id")),flashHighlight("Success","Your index has been saved.")},saveIndex(r,n)):flashHighlight("Info","No index has been chosen to save.")})},initReplaceDialog=function(){var e=$("#index-replace_function-input"),t=$("#index-editing-data"),n=$("#index-remove_function-input");t.attr("data-index-replace_function")?e.val(t.attr("data-index-replace_function")):clearValues(e).removeClass("ui-state-error");var r=$("#index-replace-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){$(".input").removeClass("ui-state-error");var r=!0;n.is(":checked")?(t.removeAttr("data-index-replace_function"),$("#replace-function-message").empty()):(e.val().isBlank()?e.addClass("ui-state-error"):e.removeClass("ui-state-error"),r&&(t.attr("data-index-replace_function",e.val()),$("#replace-function-message").text("This index has a replacement function."))),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){clearValues(e).removeClass("ui-state-error")}});return r},getFieldDoc=function(e,t,n,r){var i=getDoc(e),s="doctypes/"+n+"/fieldsets/"+t+"/fields/"+e+"?format=json";return i?(r&&r(i),i):($.ajax({url:s,async:!1,dataType:"json",success:function(t){putDoc(t),r&&r(getDoc(e))}}),getDoc(e))},fillOptionsFromUrl=function(e,t,n){return $.get(e,function(e){t.html(e),n&&n()}),!1},alterOperatorField=function(e,t,n){return disableOperatorOptions(e),n(),!1},disableOperatorOptions=function(e){var t=$("#builder-operator-input");switch(e.subcategory){case"select":case"docselect":case"text":case"textarea":disableOptions(t,["member","true"]);break;case"integer":case"rational":case"date":disableOptions(t,["member","true","match"]);break;case"boolean":case"openboolean":disableOptions(t,["equal","greater","less","member","match"]);break;case"multiselect":case"docmultiselect":disableOptions(t,["equal","greater","less","true","match"])}return!1},disableOptions=function(e,t){return e.children().show(),t.forEach(function(t){e.children("option:contains("+t+")").hide()}),!1},alterArgumentField=function(e,t,n,r){var i=function(){return getDoc(n.val())};r(),e.removeAttr("disabled").datepicker("destroy"),e.removeAttr("disabled").autocomplete("destroy");var s=function(e,t){return t.subcategory=="date"?(e.removeAttr("disabled"),e.datepicker({dateFormat:"yy-mm-dd"})):(e.removeAttr("disabled"),e.autocomplete({source:t.allowed})),!1},o=i();if(o)switch(t.val()){case"true":case"isDefined":case"blank":e.attr("disabled","disabled").val("");break;case"equal":case"member":case"greater":case"less":case"hasExactly":case"hasGreater":case"hasLess":s(e,o)}},fixArgumentType=function(e,t,n){switch(t){case"integer":case"rational":e*=1}switch(n){case"hasExactly":case"hasGreater":case"hasLess":e=Math.floor(e*1)}return e},getIndexConditions=function(e,t){var n=t.map(function(t,n){n=$(n);var r=n.find("td.or-condition").attr("data-value")=="true",i=n.find("td.paren-condition").attr("data-value"),s;if(r)s={is_or:!0,parens:!1};else if(i)s={is_or:!1,parens:i};else{var o=n.find("td.field-condition").attr("data-value"),u=n.find("td.fieldset-condition").attr("data-value"),a=n.find("td.argument-condition").attr("data-value"),f=getFieldDoc(o,u,e),l=n.find("td.negate-condition").attr("data-value")=="true",c=n.find("td.operator-condition").attr("data-value");a=fixArgumentType(a,f.subcategory,c),s={is_or:!1,parens:!1,negate:l,fieldset:u,field:o,operator:c,argument:a}}return s}).toArray();return n},saveIndex=function(e,t){var n=e.attr("data-index-id"),r=e.attr("data-index-rev"),i="indexes/"+n+"?rev="+r,s=e.attr("data-index-doctype"),o={_id:n,category:"index",doctype:s,show_deleted:e.attr("data-index-show_deleted")==="true",fields:JSON.parse(e.attr("data-index-fields")),fields_label:JSON.parse(e.attr("data-index-fields_label")),name:e.attr("data-index-name"),conditions:getIndexConditions(s,$("#index-conditions-listing tbody tr"))};return e.attr("data-index-replace_function")&&(o.replace_function=e.attr("data-index-replace_function")),sendConfigDoc(i,o,"PUT",t,this),!1},deleteIndex=function(e,t,n,r){var i="indexes/"+e+"?rev="+t;return $.ajax({type:"DELETE",url:i,dataType:"json",contentType:"application/json",complete:function(e,t){if(e.status==204){var i="Success",s=n;r(),flashHighlight(i,s)}else if(e.status==409){var s=JSON.parse(e.responseText),i=e.statusText;flashError(i,s.message)}else if(e.status==404){var s="Index appears to have been deleted already.",i=e.statusText;flashError(i,s)}}}),!1},getIndexEdit=function(e){var t="indexes/"+e,n=$("#index-conditions");return $.get(t,function(e){n.html(e);var t=$("#index-conditions-listing tbody");t.sortable(),initConditionRemoveButtons(t),getIndexView()}),!1},initIndexIndex=function(){var e="indexes",t=$("#index-index-listing");$.get(e,function(e){t.html(e),t.click(function(e){getIndexEdit($(e.target).attr("data-index-id"))})})},getIndexView=function(e,t,n,r){var i={startkey:e,startid:t,prevkeys:n,previds:r},s=$("#index-editing-data"),o=s.attr("data-index-id"),u="indexes/"+o+"/view?",a=$("#index-limit").val()*1;if(!i.prevkeys){var f=$("#index-filter").val(),l=JSON.stringify(f);i.startkey=btoa(unescape(encodeURIComponent(l))),i.prevkeys=[],i.previds=[]}i.startkey&&(u=u+"&startkey="+escape(atob(i.startkey)),i.startid&&(u=u+"&startkey_docid="+i.startid)),a?u=u+"&limit="+(a+1):($("#index-limit").val(10),u+="&limit=11"),sendConfigDoc(u,!1,"GET",function(e,t){fillIndexPreview(t,i)},this)},fillIndexPreview=function(e,t){$("#index-list-view").html(e.responseText),$("#previous-page").button({icons:{primary:"ui-icon-circle-arrow-w"}}).click(function(){getIndexView(t.prevkeys.pop(),t.previds.pop(),t.prevkeys,t.previds)}),$("#next-page").button({icons:{secondary:"ui-icon-circle-arrow-e"}}).click(function(){var e=$(this).attr("data-startkey"),n=$(this).attr("data-startid"),r=$("#first-index-element").attr("data-first-key"),i=$("#first-index-element").attr("data-first-id");t.prevkeys.push(r),t.previds.push(i),getIndexView(e,n,t.prevkeys,t.previds)}),t.prevkeys.length==0&&$("#previous-page").button("disable"),$("#next-page").attr("data-last-page")&&$("#next-page").button("disable"),$("nav.pager").buttonset()};$(function(){$("#index-builder-dialog").hide(),$("#index-new-dialog").hide(),$("#index-replace-dialog").hide(),initIndexEditButtons(function(){return $("#index-editing-data")}),initIndexNewButton(),$("#button-bar").buttonset(),initIndexIndex(),$("#index-filter-form input").keyup(function(){getIndexView()})});var identity=function(e){return e};Function.prototype.r=function(){return[this,arguments]},Function.prototype.t=function(){var e=[this,arguments],t=arguments[arguments.length-1];while(e[0]!==t)e=e[0].apply(this,e[1]);return t.apply(this,e[1])},String.prototype.parseQuoted=function(e){var e=e||"'",t=[],n=this.split(""),r=!1,i=0,s=[],o=function(){r&&i%2===0?++i:r&&i%2===1?(++i,s.push("'")):r||(r=!0)},u=function(){t.push(s.join("")),s=[],i=0,r=!1};return n.forEach(function(e){if(/'/.test(e))o();else if(i%2===1)u();else if(i%2===0){i=0;if(r)s.push(e);else if(/\S/.test(e))return!1}}),t.push(s.join("")),t},String.prototype.isBlank=function(){return/^\s*$/.test(this)&&!/\S/.test(this)&&this!==null},String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")},Array.prototype.trimAll=function(){return this.map(function(e){return e.trim()}).filter(function(e){return!e.match(/^$/)})};var flash=function(e,t,n){var r=function(){e.fadeOut()};e.find(".notification-summary").text(t+": "),e.find(".notification-message").text(n);var i=setTimeout(r,7e3);e.fadeIn(),e.find(".close").click(function(){clearTimeout(i),e.hide()})},flashError=function(e,t){flash($("#notifications-main .ui-state-error"),e,t)},flashHighlight=function(e,t){flash($("#notifications-main .ui-state-highlight"),e,t)},fillOptionsFromUrl=function(e,t,n){return $.get(e,function(e){t.html(e),n&&n()}),!1},validID=function(e){return!!e.match(/^[a-f0-9]{32}$/)},uiToggle=function(){var e=function(e){var t;$(e.target).attr("data-target")&&(t=$("#"+$(e.target).attr("data-target")),t.toggle())};$(".toggler").live("click",function(t){e(t)})},panelToggle=function(){var e=function(e){var t;$(e.target).attr("data-panel")?t=$("#"+$(e.target).attr("data-panel")):t=$(e.target).closest(".panel"),t.toggle()};$("#panel-toggle li").live("click",function(t){e(t)}),$(".panel > h2").live("dblclick",function(t){e(t)})};$(function(){$(".notification").hide(),$("#loading").hide().ajaxStart(function(){$(this).show()}).ajaxStop(function(){$(this).hide()}),panelToggle(),uiToggle(),$(".remove-button").button({icons:{primary:"ui-icon-minus"},text:!1}).click(function(){$(this).parent().remove()}),$(".help-button").button({icons:{primary:"ui-icon-help"},text:!1}),$(".link-button").button({icons:{primary:"ui-icon-link"}}),$(".edit-button").button({icons:{primary:"ui-icon-pencil"}}),$(".create-continue-button").button({icons:{primary:"ui-icon-disk",secondary:"ui-icon-arrowthick-1-e"}}),initDateFields(),$("#sortable").sortable({update:function(e,t){var n=$(e.target).children("li");n.forEach(function(e){$(e).text($(e).text()+" "+x)})}})}),function(e){e.fn.inputDisable=function(){return this.val(""),this.attr("disabled","disabled"),this.addClass("ui-state-disabled"),this},e.fn.inputEnable=function(){return this.removeAttr("disabled"),this.removeClass("ui-state-disabled"),this}}(jQuery);var getDirListing=function(e){e===undefined&&(e=""),$.get("file_manager/list_dirs/"+e,function(t){$("#file-paths").html(t),$(".dir").click(function(e){var t=$(e.target).attr("data-path");refreshListings(t)}),$("#up-dir").button().click(function(){var t=e.split("/");t.pop(),t=t.join("/"),refreshListings(t)}),$("#root-dir").button().click(function(){refreshListings()})})},getFileListing=function(e){e===undefined&&(e=""),$.get("file_manager/list_files/"+e,function(t){$("#file-listing").html(t),refreshButtons(e)})},refreshListings=function(e){getDirListing(e),getFileListing(e)},refreshButtons=function(e){refreshEditButton(),refreshDeleteButton()},refreshEditButton=function(e){$(".edit-file-button").button({icons:{primary:"ui-icon-pencil"}}).click(function(t){var n=$(t.target).parent("a"),r=n.attr("data-file-id"),i="file_manager/"+r;$.getJSON(i,function(t){pathEditDialog(t,e).dialog("open")})})},refreshDeleteButton=function(e){$(".delete-file-button").button({icons:{primary:"ui-icon-trash"}}).click(function(t){var n=$(t.target).parent("a"),r=n.attr("data-file-id"),i=n.attr("data-file-rev"),s="file_manager/"+r+"?rev="+i,o=function(){refreshListings(e),flashHighlight("Success","File Deleted")};sendConfigDoc(s,null,"DELETE",o,n)})},pathEditDialog=function(e,t){var n=$("#file-path-input");e.path?n.val(e.path.join("/")):n.val("");var r=$("#edit-path-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Move:function(){var i="file_manager/"+e._id+"?rev="+e._rev,s=function(){refreshListings(t),flashHighlight("Success","File Moved")};e.path=n.val().replace(/^\s*|\s*$/g,"").replace(/\/+/g,"/").replace(/^\/|\/$/g,"").split("/"),sendConfigDoc(i,e,"PUT",s,r),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return r};$(function(){refreshListings(),$("#file-upload-target").load(function(){var e=$("#file-upload-target").contents().find("body pre").html(),t=function(){if(e)return e.length>0?JSON.parse(e):{message:!1}};t()&&(t().message&&t().status==="error"?(flashError("Error",t().message),refreshListings()):t().message&&(flashHighlight("Success",t().message),refreshListings()))})}),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}),Array.prototype.reduce||(Array.prototype.reduce=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;if(n==0&&arguments.length==1)throw new TypeError;var r=0,i;if(arguments.length>=2)i=arguments[1];else do{if(r in t){i=t[r++];break}if(++r>=n)throw new TypeError}while(!0);while(r<n)r in t&&(i=e.call(undefined,i,t[r],r,t)),r++;return i});
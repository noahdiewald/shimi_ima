/*! Dictionary Maker - v0.1.0 - 2013-01-30
* http://ling.wisc.edu/
* Copyright (c) 2013 UW Madison Board of Regents; Licensed GNU GPLv3 */
var shimi={};String.prototype.isBlank=function(){return/^\s*$/.test(this)&&!/\S/.test(this)&&this!==null},String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")},Array.prototype.trimAll=function(){return this.map(function(e){return e.trim()}).filter(function(e){return!e.match(/^$/)})},shimi.panelToggle=function(){var e={};return e.toggler=function(e){var t;$(e).attr("data-panel")?t=$("#"+$(e).attr("data-panel")):t=$(e).closest(".panel"),t.toggle()},e}(),shimi.utils=function(){var e={};return e.stringToNumber=function(e){return typeof e=="string"&&!isNaN(e)&&e!==""?e*1:""},e.isBlank=function(e){return/^\s*$/.test(e)||e===null||e===undefined||typeof e=="number"&&isNaN(e)||Object.prototype.toString.call(e)==="[object Array]"&&e.length===0},e.validID=function(e){return!!e.match(/^[a-f0-9]{32}$/)},e.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var n="",r,i,s,o,u,a,f,l=0;t=e.Base64._utf8_encode(t);while(l<t.length)r=t.charCodeAt(l++),i=t.charCodeAt(l++),s=t.charCodeAt(l++),o=r>>2,u=(r&3)<<4|i>>4,a=(i&15)<<2|s>>6,f=s&63,isNaN(i)?a=f=64:isNaN(s)&&(f=64),n=n+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)+this._keyStr.charAt(f);return n},decode:function(t){var n="",r,i,s,o,u,a,f,l=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(l<t.length)o=this._keyStr.indexOf(t.charAt(l++)),u=this._keyStr.indexOf(t.charAt(l++)),a=this._keyStr.indexOf(t.charAt(l++)),f=this._keyStr.indexOf(t.charAt(l++)),r=o<<2|u>>4,i=(u&15)<<4|a>>2,s=(a&3)<<6|f,n+=String.fromCharCode(r),a!==64&&(n+=String.fromCharCode(i)),f!==64&&(n+=String.fromCharCode(s));return n=e.Base64._utf8_decode(n),n},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t},_utf8_decode:function(e){var t="",n=0,r=0,i=0,s=0,o=0;while(n<e.length)r=e.charCodeAt(n),r<128?(t+=String.fromCharCode(r),n++):r>191&&r<224?(s=e.charCodeAt(n+1),t+=String.fromCharCode((r&31)<<6|s&63),n+=2):(s=e.charCodeAt(n+1),o=e.charCodeAt(n+2),t+=String.fromCharCode((r&15)<<12|(s&63)<<6|o&63),n+=3);return t}},e},shimi.flash=function(e,t){var n={},r=function(e,t,n){var r=function(){e.fadeOut()};e.find(".notification-summary").text(t+": "),e.find(".notification-message").text(n);var i=window.setTimeout(r,7e3);e.fadeIn(),e.find(".close").click(function(){window.clearTimeout(i),e.hide()})};return n.error=function(){return r($("#notifications-main .ui-state-error"),e,t),n},n.highlight=function(){return r($("#notifications-main .ui-state-highlight"),e,t),n},n};var identity=function(e){return e};Function.prototype.r=function(){return[this,arguments]},Function.prototype.t=function(){var e=[this,arguments],t=arguments[arguments.length-1];while(e[0]!==t)e=e[0].apply(this,e[1]);return t.apply(this,e[1])},shimi.store=function(e){var t={};return t.get=function(t){var n=e.attr("data-"+t);if(n)return n;var r=function(e,t,n){var i=t.attr("data-group-id"),s=$("#"+i),o=s.attr("data-"+e),u=s.attr("data-group-id");return o===undefined&&u!==undefined&&i!==u?r.r(e,s,n):n.r(o)};return r.t(t,e,identity)},t.get64=function(e){var n=t.get(e);return n=shimi.utils().Base64.decode(n.replace(/"/g,"")).replace(/(^"|"$)/g,""),n},t.put=function(t,n){var r=e.attr("data-group-id");$("#"+r).attr("data-"+t,n)},t.fs=function(e){return t.get("fieldset-"+e)},t.f=function(e){return t.get("field-"+e)},t.d=function(e){return t.get("document-"+e)},t},shimi.path=function(e,t,n){var r={},i;t?i=t+"-":i="",n?r.string=n+"/":r.string="",r.category=t,r.origin=e,r.type=i+"path",r.valid_components=["doctype","fieldset","field"];var s=shimi.store(r.origin);return r.valid_components.forEach(function(e){r[e]=function(){var t=s.get(i+e);return t}()}),r.rev=s.get(i+"rev"),r.doctype=s.get(i+"doctype"),r.send=function(e,t,n,i){return shimi.form.send(r.toString(),e,t,n,i),r},r.put=function(e,t,n){return r.send(e,"PUT",t,n),r},r.post=function(e,t,n){return r.send(e,"POST",t,n),r},r.del=function(e,t){return r.send({},"DELETE",e,t),r},r.toString=function(){var e,t=r.string.concat(r.valid_components.map(function(e){var t=e+"s",n=r[e],i=null;return n?i=t+"/"+n:e===r.category&&(i=t),i}).filter(function(e){return typeof e=="string"&&!e.isBlank()}).join("/"));return r.rev&&(t=t.concat("?rev="+r.rev)),t},r},function(e){function t(t){if(typeof t.data!="string")return;var n=t.handler,r=t.data.toLowerCase().split(" ");t.handler=function(t){var i=t.type!=="keypress"&&e.hotkeys.specialKeys[t.which],s=String.fromCharCode(t.which).toLowerCase(),o,u="",a={};t.altKey&&i!=="alt"&&(u+="alt+"),t.ctrlKey&&i!=="ctrl"&&(u+="ctrl+"),t.metaKey&&!t.ctrlKey&&i!=="meta"&&(u+="meta+"),t.shiftKey&&i!=="shift"&&(u+="shift+"),i?a[u+i]=!0:(a[u+s]=!0,a[u+e.hotkeys.shiftNums[s]]=!0,u==="shift+"&&(a[e.hotkeys.shiftNums[s]]=!0));for(var f=0,l=r.length;f<l;f++)if(a[r[f]])return n.apply(this,arguments)}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})}(jQuery),function(e){e.fn.inputDisable=function(){return this.val(""),this.attr("disabled","disabled"),this.addClass("ui-state-disabled"),this},e.fn.inputEnable=function(){return this.removeAttr("disabled"),this.removeClass("ui-state-disabled"),this}}(jQuery),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}),Array.prototype.reduce||(Array.prototype.reduce=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;if(n===0&&arguments.length===1)throw new TypeError;var r=0,i;if(arguments.length>=2)i=arguments[1];else do{if(r in t){i=t[r++];break}if(++r>=n)throw new TypeError}while(!0);while(r<n)r in t&&(i=e.call(undefined,i,t[r],r,t)),r++;return i}),shimi.dispatcher=function(e){var t=function(t){var n=$(t.target);Object.keys(e).forEach(function(t){if(n.is(t)){var r=e[t];r(n)}})};return t},shimi.dblclickDispatch=function(e){var t=shimi.sui,n=shimi.dispatcher({".search-result-field-id a":function(e){t.addField($(e).parent("h5"))},".field-view b":function(e){t.addField($(e).parent("li"))},".field-container label span":function(e){t.addField($(e).parent("label").parent("div"))},"#index-index-input-label":function(){t.addIndex()},".panel > h2":function(e){shimi.panelToggle.toggler(e)}});n(e)},shimi.clickDispatch=function(e){var t=shimi.doctypeTab,n=shimi.charseqTab,r=shimi.eui,i=shimi.vui,s=shimi.iui,o=shimi.sui,u=shimi.efs,a=shimi.ieui,f=shimi.form,l=shimi.pui,c=shimi.fm,h=shimi.dispatcher({".edit-field-button":function(e){t.editField(e)},".delete-field-button":function(e){t.deleteField(e)},".add-field-button":function(e){t.addField(e)},".edit-fieldset-button":function(e){t.editFieldset(e)},".delete-fieldset-button":function(e){t.deleteFieldset(e)},".add-fieldset-button":function(e){t.addFieldset(e)},".delete-doctype-button":function(e){t.deleteDoctype(e)},".edit-doctype-button":function(e){t.editDoctype(e)},".touch-doctype-button":function(e){t.touchDoctype(e)},"#doctype-add-button":function(e){t.addDoctype(e)},".delete-charseq-button":function(e){n.del(e)},".edit-charseq-button":function(e){n.edit(e)},"#charseq-add-button":function(e){n.add()},"#maintenance-upgrade-button":function(e){shimi.upgradeButton(e)},".add-button":function(e){u.initFieldset(e)},".remove-button":function(e){u.removeFieldset(e)},"#save-document-button":function(e){r.save()},"#create-document-button":function(e){r.create()},"#clear-document-button":function(e){r.clear()},".expander":function(e){r.toggleTextarea(e)},"label span.ui-icon-help":function(e){r.showHelpDialog(e)},"#document-edit-button":function(e){i.edit(e)},"#document-delete-button":function(e){i.confirmDelete()},"#document-restore-button":function(e){i.confirmRestore()},"#document-view-tree > ul > li > b":function(e){i.collapseToggle(e)},".revision-link":function(e){i.fetchRevision(e)},"#search-all-fields-switch a":function(){o.allFields()},".search-field-item":function(e){o.removeField(e)},"#document-search-exclude":function(){o.toggleExclusion()},"#document-search-invert":function(){o.toggleInversion()},".view-document-link":function(e){s.load(e)},"#new-index-button":function(e){a.newCond()},".remove-condition-button":function(e){a.remCond(e)},"#delete-index-button":function(e){a.del()},"#save-index-button":function(e){a.save()},"#replace-button":function(e){a.replace()},"#add-index-condition-button":function(e){a.addCond()},"#index-index-listing ul li a":function(e){a.init(e)},"#create-project":function(){l.add().dialog("open")},".project-delete-button":function(e){l.del(e)},"#up-dir":function(){c.upDir()},"#root-dir":function(){c.rootDir()},".dir":function(e){c.goDir(e)},".delete-file-button":function(e){c.deleteFile(e)},".edit-file-button":function(e){c.editFile(e)},".toggler":function(e){f.toggle(e)},"#panel-toggle li":function(e){shimi.panelToggle.toggler(e)}});h(e)},$(function(){$("body").click(function(e){shimi.clickDispatch(e)}),$("body").dblclick(function(e){shimi.dblclickDispatch(e)})}),shimi.index=function(e){var t={};return t.get=function(n,r,i,s){var o=e.url+"?",u=e.indexId,a=$("#index-limit"),f=a.val()*1,l=e.target,c=JSON.stringify($("#index-filter").val()),h={sk:n,sid:r,pks:i,pids:s};return h.pks||(h.sk=window.btoa(window.unescape(window.encodeURIComponent(c))),h.pks=[],h.pids=[]),h.sk&&(o=o+"&startkey="+window.escape(window.atob(h.sk)),h.sid&&(o=o+"&startkey_docid="+h.sid)),f?o=o+"&limit="+(f+1):(a.val(25),o+="&limit=26"),u&&(o=o+"&index="+u),shimi.form.send(o,!1,"GET",function(e,n){t.fill(n,h,l)},this),t},t.fill=function(e,n,r){return r.html(e.responseText),$("#previous-index-page").click(function(){t.get(n.pks.pop(),n.pids.pop(),n.pks,n.pids)}),$("#next-index-page").click(function(){var e=$("#next-index-page").attr("data-startkey"),r=$("#next-index-page").attr("data-startid"),i=$("#first-index-element").attr("data-first-key"),s=$("#first-index-element").attr("data-first-id");n.pks.push(i),n.pids.push(s),t.get(e,r,n.pks,n.pids)}),n.pks.length===0&&$("#previous-index-page").hide(),$("#next-index-page").attr("data-last-page")&&$("#next-index-page").hide(),t},t},shimi.form=function(){var e={};return e.toggle=function(t){var n,r=$(t);return r.attr("data-target")&&(n=$("#"+r.attr("data-target")),n.toggle()),e},e.clear=function(e){return e.each(function(e){var t=$(this);t.attr("data-retain")||(t.is(":checked")&&t.attr("checked",!1),t.val(""))}),e},e.send=function(e,t,n,r,i){var s;return t&&(s=JSON.stringify(t)),$.ajax({type:n,url:e,dataType:"json",context:i,contentType:"application/json",processData:!1,data:s,complete:function(e,t){if(e.status>=200&&e.status<300)r(this,e);else if(e.status===500)shimi.flash("Unknown Server Error","Please report that you received this message").error();else if(e.status>=400){var n=JSON.parse(e.responseText),i=e.statusText;shimi.flash(i,n.fieldname+" "+n.message).error()}}}),!0},e.updateTips=function(e,t){return t.text(e).addClass("ui-state-highlight"),setTimeout(function(){t.removeClass("ui-state-highlight",1500)},500),!0},e.checkLength=function(t,n,r,i,s){return t.val().length>i||t.val().length<r?(t.addClass("ui-state-error"),e.updateTips("Length of "+n+" must be between "+r+" and "+i+".",s),!1):!0},e.checkRegexp=function(t,n,r,i){return n.test(t.val())?!0:(t.addClass("ui-state-error"),e.updateTips(r,i),!1)},e.initDateFields=function(){return $(".date").datepicker({dateFormat:"yy-mm-dd"}),!0},e.fillOptionsFromUrl=function(e,t,n){return $.get(e,function(e){t.html(e),n&&n()}),!1},e}(),shimi.sess=function(){var e={};return e.put=function(e){return window.sessionStorage[e._id]||(window.sessionStorage[e._id]=JSON.stringify(e)),e._id},e.get=function(e){var t=window.sessionStorage[e];return t?JSON.parse(t):null},e},shimi.charseqDialog=function(e){var t=shimi.charseqElems.get(e),n=$("#charseq-dialog").dialog({width:650,autoOpen:!1,modal:!0,buttons:{Save:function(){var n=t.getCharseqInputVals(),r="config/charseqs",i="POST",s=function(e){shimi.charseqTab.init(),$(e).dialog("close")};e&&e.rev&&(i="PUT",r="config/charseqs/"+n._id+"?rev="+n.rev),shimi.form.send(r,n,i,s,this)},Cancel:function(){$(this).dialog("close")}},close:function(){t.clear()}});return n},shimi.charseqElems=function(){var e={};return e.attrs=["description","characters","name","sort_ignore","locale","tailoring","vowels","consonants","ietf_tag","iso639_tag","charseq","rev"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t])}),n},n.getCharseqInputVals=function(){var e={category:"charseq",description:n.description.val(),characters:n.parse(n.characters.val()),name:n.name.val(),sort_ignore:n.parse(n.sort_ignore.val()),locale:n.locale.val(),tailoring:n.tailoring.val(),vowels:n.parse(n.vowels.val()),consonants:n.parse(n.consonants.val()),ietf_tag:n.ietf_tag.val(),iso639_tag:n.iso639_tag.val(),_id:n.charseq.val()||undefined,rev:n.rev.val()||undefined};return e},n.parse=function(e){return e&&!e.isBlank()?JSON.parse(e):[]},n.clear=function(){return shimi.form.clear($("#charseq-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#charseq-"+e+"-input")}),t&&n.copyValues(t),n},e}(),shimi.charseqTab=function(){var e={};return e.add=function(){return shimi.charseqDialog().dialog("open"),e},e.edit=function(t){var n={},r=shimi.charseqElems.attrs;return r.forEach(function(e){n[e]=shimi.store(t).get64("charseq-"+e)}),shimi.charseqDialog(n).dialog("open"),e},e.del=function(t){var n=shimi.store(t),r=n.get("charseq-charseq"),i=n.get("charseq-rev"),s="config/charseqs/"+r+"?rev="+i,o=function(){e.init()};return window.confirm("Are you sure? This is permanent.")&&shimi.form.send(s,{},"DELETE",o,this),e},e.init=function(){var t=$("#charseq-tabs"),n=$("#charseq-tabs-headings"),r="config/charseqs";return t.tabs(),$.get(r,function(e){n.empty(),n.find(".ui-tabs-panel").remove(),t.tabs("destroy"),n.html(e),t.tabs()}),e},e}(),shimi.upgradeButton=function(e){$.post("config/upgrade"),window.alert("Upgrade In Progress")},shimi.initTabs=function(){return shimi.doctypeTab.init(),$("#main-tabs").tabs(),shimi.charseqTab.init(),!0},shimi.doctypeDialog=function(e,t){var n=shimi.doctypeElems.get(t);t.rev&&!t.rev.isBlank()?n.doctype.attr("disabled","disabled"):n.doctype.removeAttr("disabled");var r=$("#doctype-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.getDoctypeInputVals(),i=function(e){shimi.doctypeTab.init(),$(e).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.doctype,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r},shimi.doctypeElems=function(){var e={};return e.attrs=["description","doctype","rev"],e.get=function(t){var n={};return n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t])}),n},n.getDoctypeInputVals=function(){var e={category:"doctype",description:n.description.val(),_id:n.doctype.val()};return e},n.clear=function(){return shimi.form.clear($("#doctype-dialog .input")).removeClass("ui-state-error"),n},e.attrs.forEach(function(e){n[e]=$("#doctype-"+e+"-input")}),n.copyValues(t),n},e}(),shimi.doctypeTab=function(){var e={},t=function(e,t){return shimi.path(e,t,"config")};return e.initFields=function(t){return t.field=!1,$.get(t.toString(),function(e){var n=$("#fields-"+t.fieldset);n.empty(),n.html(e)}),e},e.initFieldsets=function(e){$.get(e.toString(),function(t){var n=$("#fieldsets-"+e.doctype);n.empty(),n.accordion("destroy"),n.html(t),n.accordion({autoHeight:!1,collapsible:!0,active:!1})})},e.init=function(){var t="config/doctypes";$("#doctype-tabs").tabs(),$.get(t,function(t){var n=$("#fieldset-doctype-input");$("#doctype-tabs-headings").empty(),$("#doctype-tabs-headings + .ui-tabs-panel").remove(),$("#doctype-tabs").tabs("destroy"),$("#doctype-tabs-headings").html(t);var r=function(t,n){var r=$(n.panel).children("div[data-fieldset-doctype]"),i=shimi.path(r,"fieldset","config");e.initFieldsets(i)};$("#doctype-tabs").tabs({load:function(e,t){r(e,t)}})})},e.editField=function(e){var n=t(e,"field"),r={},i=shimi.fieldElems.attrs,s="config/charseqs?as=options";$.get(s,function(t){$("#field-charseq-input").html(t),i.forEach(function(t){r[t]=shimi.store(e).get("field-"+t)}),shimi.fieldDialog(n,r).dialog("open")})},e.deleteField=function(n){var r=window.confirm("Are you sure? This is permanent.");if(r){var i=t(n,"field"),s=function(){i.field=!1,i.rev=!1,e.initFields(i)};i.del(s,this)}},e.addField=function(e){var n=t(e,"field"),r="config/charseqs?as=options";$.get(r,function(e){$("#field-charseq-input").html(e),shimi.fieldDialog(n,{fieldset:n.fieldset,doctype:n.doctype}).dialog("open")})},e.editFieldset=function(e){var n=t(e,"fieldset"),r={},i=shimi.fieldsetElems.attrs;i.forEach(function(t){r[t]=shimi.store(e).get("fieldset-"+t)}),shimi.fieldsetDialog(n,r).dialog("open")},e.deleteFieldset=function(n){var r=t(n,"fieldset"),i=function(){r.fieldset=!1,r.rev=!1,e.initFieldsets(r)};window.confirm("Are you sure? This is permanent.")&&r.del(i,this)},e.addFieldset=function(e){var n=t(e,"fieldset");shimi.fieldsetDialog(n,{doctype:n.doctype}).dialog("open")},e.editDoctype=function(e){var n=t(e,"doctype"),r={},i=shimi.doctypeElems.attrs;i.forEach(function(t){r[t]=shimi.store(e).get("doctype-"+t)}),shimi.doctypeDialog(n,r).dialog("open")},e.touchDoctype=function(e){var t=shimi.store(e).get("doctype-doctype");$.post("config/doctypes/"+t+"/touch"),window.alert("Touch In Progress")},e.deleteDoctype=function(n){var r=t(n,"doctype"),i=function(){r.doctype=!1,r.rev=!1,e.init()};window.confirm("Are you sure? This is permanent.")&&r.del(i,this)},e.addDoctype=function(e){var n=t(e,"doctype");shimi.doctypeDialog(n,{}).dialog("open")},e}(),shimi.fieldDialog=function(e,t){var n=shimi.fieldElems.get(t),r=$("#field-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.clearDisabled().getFieldInputVals(),i=function(t){shimi.doctypeTab.initFields(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.field,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r},shimi.fieldElems=function(){var e={};return e.attrs=["name","label","order","description","subcategory","head","reversal","default","required","allowed","source","max","min","regex","doctype","fieldset","charseq","rev","field"],e.get=function(t){var n={};return n.attrs=e.attrs,n.notDefault=function(){return[n.charseq,n.allowed,n.source,n.min,n.max,n.regex]},n.disable=function(){return n.notDefault().forEach(function(e){e.attr("disabled","disabled")}),n},n.clearDisabled=function(){return n.notDefault().forEach(function(e){e.attr("disabled")&&e.val("")}),n},n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t]),n[t].is("input[type=checkbox]")&&e[t]==="true"&&n[t].attr("checked",!0)}),n},n.getFieldInputVals=function(){var e={category:"field",name:n.name.val(),label:n.label.val(),"default":n.decodeDefaults(n.subcategory.val(),n["default"].val()),head:n.head.is(":checked"),reversal:n.reversal.is(":checked"),required:n.required.is(":checked"),order:n.order.val()*1,allowed:n.allowed.val().split(",").trimAll(),source:n.decodeSource(n.subcategory.val(),n.source.val()),min:n.decodeBound(n.subcategory.val(),n.min.val()),max:n.decodeBound(n.subcategory.val(),n.max.val()),regex:n.regex.val(),description:n.description.val(),charseq:n.charseq.val(),doctype:n.doctype.val(),fieldset:n.fieldset.val(),subcategory:n.subcategory.val()};return e},n.clear=function(){return shimi.form.clear($("#field-dialog .input")).removeClass("ui-state-error"),n.disable(),n},n.decodeBound=function(e,t){return e==="date"?t:shimi.utils().stringToNumber(n.min.val())},n.decodeSource=function(e,t){return e==="file"?t.split("/").trimAll():t},n.decodeDefaults=function(e,t){switch(e){case"docmultiselect":case"multiselect":return t.split(",").trimAll();case"file":return t.split("/").trimAll();default:return t}},n.displayFields=function(e){switch(e){case"select":case"multiselect":n.disable(),n.allowed.removeAttr("disabled");break;case"docselect":case"docmultiselect":case"file":n.disable(),n.source.removeAttr("disabled");break;case"text":case"textarea":n.disable(),n.charseq.removeAttr("disabled"),n.regex.removeAttr("disabled");break;case"date":case"integer":case"rational":n.disable(),n.min.removeAttr("disabled"),n.max.removeAttr("disabled");break;default:n.disable()}},n.attrs.forEach(function(e){n[e]=$("#field-"+e+"-input")}),n.copyValues(t),n.displayFields(n.subcategory.val()),n.subcategory.change(function(){n.displayFields(n.subcategory.val())}),n},e}(),shimi.fieldsetDialog=function(e,t){var n=shimi.fieldsetElems.get(t),r=$("#fieldset-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){var r=n.getFieldsetInputVals(),i=function(t){e.fieldset=!1,e.rev=!1,shimi.doctypeTab.initFieldsets(e),$(t).dialog("close")};!t.rev||t.rev.isBlank()?e.post(r,i,this):(r._id=e.fieldset,e.put(r,i,this))},Cancel:function(){$(this).dialog("close")}},close:function(){n.clear()}});return r},shimi.fieldsetElems=function(){var e={};return e.attrs=["name","label","order","description","doctype","rev","multiple","collapse","fieldset"],e.get=function(t){var n={};return n.attrs=e.attrs,n.copyValues=function(e){return Object.keys(e).forEach(function(t){n[t].val(e[t]),n[t].is("input[type=checkbox]")&&e[t]==="true"&&n[t].attr("checked",!0)}),n},n.getFieldsetInputVals=function(){var e={category:"fieldset",name:n.name.val(),label:n.label.val(),order:n.order.val()*1,description:n.description.val(),doctype:n.doctype.val(),multiple:n.multiple.is(":checked"),collapse:n.collapse.is(":checked")};return e},n.clear=function(){return shimi.form.clear($("#fieldset-dialog .input")).removeClass("ui-state-error"),n},n.attrs.forEach(function(e){n[e]=$("#fieldset-"+e+"-input")}),n.copyValues(t),n},e}(),shimi.loadHash=function(e){return e&&shimi.vui.get(e),!1},shimi.jumpForm=function(){$("#view-jump").live("submit",function(){return!1}),$("#view-jump-id").live("keypress",function(e){if(e.which===13){var t=$("#view-jump-id").val();shimi.vui.get(t)}return!0})},shimi.searchForm=function(){shimi.sui.loadSearchVals(),$("#document-search-form").on("submit",function(){return!1}),$("#document-search-term").on("keydown",function(e){return e.which===13?(shimi.sui.getSearch(),!1):!0})},shimi.efs=function(){var e={},t=shimi.store,n=shimi.utils(),r=function(e){return $("#container-"+e)},i=function(e,t){var n=shimi.path(e,t);return n.doctype=!1,n},s=function(e,t,n){var r=null;r=sessionStorage.getItem(e),r?t(r):$.get(e,n)},o=function(e,n){e=e.children(".field-container").children(".field");var r={fields:[]};return e.each(function(e,i){i=$(i);var s=t(i);r.fields[e]={id:s.f("field"),name:s.f("name"),label:s.f("label"),head:s.f("head")==="true",reversal:s.f("reversal")==="true",required:s.f("required")==="true",min:u(s.f("subcategory"),s.f("min")),max:u(s.f("subcategory"),s.f("max")),instance:s.f("instance"),charseq:s.f("charseq"),regex:s.f("regex"),order:s.f("order")*1,subcategory:s.f("subcategory"),value:h(i)},n>=0&&(r.fields[e].index=n)}),r},u=function(e,t){return e==="date"?t:n.stringToNumber(t)},a=function(e){switch(e){case"true":e=!0;break;case"false":e=!1;break;default:e=null}return e},f=function(e){return n.isBlank(e)?e="":isNaN(e)||(e*=1),e},l=function(e){return e?e=e.map(function(e){return c(e)}):e=null,e},c=function(e){return window.decodeURIComponent(e.replace(/\+/g," "))},h=function(e){var n;switch(t(e).f("subcategory")){case"boolean":n=e.is("input:checkbox:checked");break;case"openboolean":n=a(e.val());break;case"integer":case"rational":n=f(e.val());break;case"multiselect":case"docmultiselect":n=l(e.val());break;case"select":case"docselect":n=c(e.val());break;default:n=e.val()}return n},p=function(e,t){var n=i(e,"field"),r=e.children(".fields").last(),o=function(e){r.prepend(e),t&&t(r),shimi.eui.afterFreshRefresh()},u=function(e){sessionStorage.setItem(n,e),o(e)};return s(n.toString(),o,u),!0},d=function(n){n=$(n);var r=t(n).fs("fieldset"),s=$("#container-"+r),o=i(n,"fieldset");s.html(""),n.find(".multifield").each(function(t,n){e.initFieldset(s,function(e){m($(n),e)})})},v=function(e){m($(e))},m=function(e,t){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),$("#save-document-button").show(),e.find(".field-view").each(function(e,n){var r=$(n).attr("data-field-value"),i=$(n).attr("data-field-field");t||(t=$("body")),y(t.find(".field[data-field-field="+i+"]"),r)})},g=function(e){$.getJSON(e,function(e){sessionStorage.setItem("lables",JSON.stringify(e))})},y=function(e,t){e.is("input.boolean")?e.attr("checked",t==="true"):t&&e.is("select.multiselect")?e.val(t.split(",")):t&&(e.is("input.text")||e.is("select.file"))?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.is("textarea.textarea")?e.val(decodeURIComponent(t.replace(/\+/g," "))):e.val(t)};return e.initFieldset=function(e,n){var r=i($(e),"fieldset").toString(),o=t($(e)).fs("fieldset"),u=$("#container-"+o),a=function(e){u.append(e),p(u,n)},f=function(e){sessionStorage.setItem(r,e),a(e)};return s(r.toString(),a,f),!1},e.fieldsetsToObject=function(e){var n={fieldsets:[]};return e.find("fieldset").each(function(e,i){i=$(i);var s=t(i),u,a={id:s.fs("fieldset"),multiple:s.fs("multiple")==="true",collapse:s.fs("collapse")==="true",name:s.fs("name"),label:s.fs("label"),order:s.fs("order")*1};u=r(a.id).children(".fields"),a.multiple?(a.multifields=[],u.each(function(e,t){t=$(t),a.multifields[e]=o(t,e)})):$.extend(a,o(u.first())),n.fieldsets[e]=a}),n},e.initFieldsets=function(){var n=$("#create-document-button"),r=t(n),i=r.d("doctype"),s=i+"_version",o=sessionStorage.getItem(s),u=r.d("version");if(o!==u){sessionStorage.clear();var a=shimi.path(n,"fieldset").toString();g(a)}return sessionStorage.setItem(s,u),$("fieldset").each(function(n,r){var i=t($(r));i.fs("multiple")==="false"&&e.initFieldset(r,!1)}),e},e.removeFieldset=function(e){e.parent().remove()},e.fillFieldsets=function(){return $(".fieldset-view").each(function(e,n){t($(n)).fs("multiple")==="true"?d(n):v(n)}),shimi.eui.afterEditRefresh(),e},e}(),shimi.eui=function(){var e={},t=shimi.store,n=shimi.flash,r=function(){return $("#save-document-button")},i=function(){return $("#create-document-button")},s=function(){return $("#document-edit-button")},o=function(){var t="input, select",n=$("#edit-tabs"),r=function(){var e=n.find(".ui-tabs-selected a").attr("href");$(e).find(t+", textarea").first().focus()};return $(document).bind("keydown","Alt+p",function(e){var t=n.tabs("length"),i=n.tabs("option","selected");return i!==0?(n.tabs("select",i-1),r()):(n.tabs("select",t-1),r()),!1}),$(document).bind("keydown","Alt+n",function(e){var t=n.tabs("length"),i=n.tabs("option","selected");return i<t-1?(n.tabs("select",i+1),r()):(n.tabs("select",0),r()),!1}),$(document).live("keydown","Alt+c",function(t){var n=$(document.activeElement);return e.showCommandDialog(n),!0}),$("#edit-command-form").live("submit",function(e){return!1}),$("#edit-command-input").live("keydown",function(t){if(t.which===13){var n=$("#edit-command-input").val(),i=!0;$("#command-dialog").dialog("close");switch(n){case"w":case"clear":e.clear();break;case"c":case"create":e.create();break;case"s":case"save":e.save();break;case"d":case"delete":$("#document-view").show(),$("#document-delete-button").css("display")!=="none"&&$("#document-delete-button").click();break;case"e":case"edit":$("#document-view").show(),$("#document-edit-button").css("display")!=="none"&&($("#document-edit-button").click(),i=!1);break;case"r":case"restore":$("#document-view").show(),$("#document-restore-button").css("display")!=="none"&&$("#document-restore-button").click()}i?$("#"+$("#command-dialog").attr("data-last-active")).focus():r()}return!0}),$("#edit-document-form input").live("keydown",function(t){return t.which===13&&($("#save-document-button").css("display")==="none"?e.create():e.save()),!0}),$("#edit-document-form textarea").on("keydown","Alt+x",function(t){return e.toggleTextarea($(t.target)),!1}),e},u=function(t){var r=JSON.parse(t.responseText),i=t.statusText,s=$("[data-field-instance="+r.instance+"]"),o=$("[href=#"+s.parents("fieldset").attr("id")+"]").parent("li");return o.addClass("ui-state-error"),s.addClass("ui-state-error"),n(i,r.fieldname+" "+r.message).error(),e},a=function(){var t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],n=function(){return t.map(function(){return t[Math.floor(Math.random()*t.length)]}).join("")};return $("[data-field-instance]").each(function(e,t){var r=n();$(t).first().attr("data-field-instance",r),$(t).first().attr("data-group-id",r),$(t).first().attr("id",r),$(t).first().next(".expander").attr("data-group-id",r),$(t).first().next().next(".expander").attr("data-group-id",r)}),e};e.init=function(){var t="documents/edit";return $.get(t,function(e){$("#document-edit").html(e),$("#edit-tabs").tabs(),o(),shimi.efs.initFieldsets()}),e},e.afterFreshRefresh=function(){return f(),e},e.afterEditRefresh=function(){var t=["data-document-id","data-document-rev"];return t.forEach(function(e){r().attr(e,s().attr(e))}),r().show(),f(),e};var f=function(){return shimi.form.initDateFields(),a(),e};return e.resetFields=function(){return $(".field").each(function(e){var t=$(this),n=t.attr("data-field-default");n&&n!==""?t.is("select.multiselect")?t.val(n.split(",")):t.is("input.boolean")?t.attr("checked",n===!0):t.val(n):(t.val(""),t.removeAttr("checked"))}),e},e.save=function(){if(r().hasClass("oldrev")&&!window.confirm("This data is from an older version of this document. Are you sure you want to restore it?"))return!1;var e,i,s=t(r()),o=$("#edit-document-form"),a=s.d("document"),f=s.d("rev"),l="./documents/"+a+"?rev="+f,c=$("#first-index-element").attr("data-first-key"),h=$("#first-index-element").attr("data-first-id"),p={doctype:s.d("doctype"),description:s.d("description")};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),r().hide(),$.extend(p,shimi.efs.fieldsetsToObject(o)),$.ajax({type:"PUT",url:l,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(p),complete:function(t,s){t.status===204||t.status===200?(i="Success",e="Your document was saved.",shimi.vui.get(a),shimi.iui.get(c,h),n(i,e).highlight(),r().removeClass("oldrev").show()):t.status===403?(u(t),r().show()):t.status===409&&(e=JSON.parse(t.responseText),i=t.statusText,n(i,e.message).error(),r().hide())}})},e.create=function(){var e=t(i()),s=$("#edit-document-form"),o=$("#first-index-element").attr("data-first-key"),a=$("#first-index-element").attr("data-first-id"),f={doctype:e.d("doctype"),description:e.d("description")};$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),i().hide(),$.extend(f,shimi.efs.fieldsetsToObject(s));var l=$.ajax({type:"POST",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(f),complete:function(e,t){if(e.status===201){var s="Success",f="Your document was created.",c=l.getResponseHeader("Location").match(/[a-z0-9]*$/);r().hide().attr("disabled","true"),$(".fields").remove(),shimi.efs.initFieldsets(),shimi.vui.get(c),shimi.iui.get(o,a),n(s,f).highlight(),i().show()}else e.status===403&&(u(e),i().show())}})},e.clear=function(){$("#edit-document-form .ui-state-error").removeClass("ui-state-error"),r().hide().attr("disabled","disabled"),$(".fields").remove(),shimi.efs.initFieldsets()},e.showHelpDialog=function(t){return t.is(".label-text")&&(t=t.parent("label").find(".ui-icon-help")),$("#help-dialog").dialog().dialog("open").find("#help-dialog-text").html(t.attr("title")),e},e.showCommandDialog=function(t){$("#edit-command-input").val(""),$("#edit-dialog").attr("data-last-active",t.id);var n=$("#command-dialog").dialog({modal:!0,close:function(){$("#edit-command-input").val(""),t.focus()}});return n.dialog("open"),e},e.toggleTextarea=function(t){var n=$("#"+t.attr("data-group-id"));return t.attr("id")===n.attr("data-group-id")?(n.toggleClass("expanded"),n.next().next("span").toggleClass("expanded")):(n.toggleClass("expanded"),t.toggleClass("expanded")),e},e}(),shimi.iui=function(){var e={},t=shimi.store,n=shimi.flash,r=shimi.index;return e.get=function(t,n,i,s){var o="documents/index",u=$("#index-index-input").val(),a=$("#index-listing");return r({url:o,indexId:u,target:a}).get(t,n,i,s),e},e.iOpts=function(){var t="/projects/project-"+$("#container").attr("data-project-id")+"/indexes?as=options";return $.get(t,function(e){$("#index-index-input").html(e)}),e},e.load=function(t){var n=$(t).attr("href").slice(1);return $("#document-view").html("<em>Loading...</em>"),shimi.eui.clear(),shimi.vui.get(n),e},e}(),shimi.sui=function(){var e={},t=shimi.utils(),n=window.localStorage,r=function(){return $("#document-search-index")},i=function(){return $("#search-index-label")},s=function(){return $("#document-search-term")},o=function(){return $("#document-search-field")},u=function(){return $("#search-field-label")},a=function(){return $("#document-search-exclude")},f=function(){return $("#document-search-invert")},l=function(){return $("#search-all-fields-switch")},c=function(){return $("#search-listing")},h=[r,i,o,u,a,f,l],p=function(){var e=$("#index-index-input").val();return e.length===0?null:e},d=function(e){return e?!0:null},v=function(){n.setItem("searchIndex",null),n.setItem("searchIndexLabel",null),n.setItem("searchFields",null),n.setItem("searchExclude",null),n.setItem("searchInvert",null)},m=function(){h.forEach(function(e){var t=e();switch(t.attr("type")){case"hidden":t.val("");break;case"checkbox":t.attr("checked",!1)}})},g=function(){h.forEach(function(e){var t=e();switch(t.attr("type")){case"hidden":break;case"checkbox":t.parent("div").hide();break;default:t.hide()}})},y=function(){var e=JSON.parse(sessionStorage.getItem("lables"));return e},b=function(e,t){return"<a class='search-field-item' title='click to remove' data-field-field='"+e+"' href='#'>"+t+"</a>"},w=function(e){var t=y(),r=JSON.stringify(e),i=u();o().val(r),n.setItem("searchFields",r);var s=e.map(function(e){return b(e,t[e].join(": "))});return i.html(s.join(" ")),!0};return e.allFields=function(){return v(),g(),m(),e},e.singleField=function(t){return e.multipleFields(t),f().parent().show(),e},e.singleFieldInverse=function(t){return e.singleField(t),f().attr("checked",!0),n.setItem("searchInvert",!0),e},e.multipleFields=function(t){return e.allFields(),w(t),[l(),u(),a().parent()].forEach(function(e){e.show()}),e},e.excludedFields=function(t){return t.length>1?e.multipleFields(t):e.singleField(t),a().attr("checked",!0),n.setItem("searchExclude",!0),e},e.indexOnly=function(t,s){return e.allFields(),n.setItem("searchIndex",t),n.setItem("searchIndexLabel",s),r().val(t),i().html(s),[l(),r(),i(),f().parent()].forEach(function(e){e.show()}),e},e.indexInverse=function(t,r){return e.indexOnly(t,r),f().attr("checked",!0),n.setItem("searchInvert",!0),e},e.getSearch=function(){var t=s().val(),n="documents/search?q="+window.encodeURIComponent(t),i=o().val(),u=a().is(":checked"),l=f().is(":checked"),h=r().val(),p=y();return h?n=n+"&index="+h:(i&&(n=n+"&field="+i),u&&(n+="&exclude=true")),l&&(n+="&invert=true"),c().hide(),$.get(n,function(e){c().html(e),$(".search-result-field-id").each(function(e,t){var n=p[$(t).attr("data-field-field")].join(": "),r=$(t).children("a").first();r.html(n),r.attr("data-search-label",n)}),l||$(".search-results th").each(function(e,n){var r=$.trim($(n).children("a").html()),i=new RegExp("("+t+")","g"),s=r.replace(i,"<span class='highlight'>$1</span>");$(n).children("a").html(s)}),c().show()}),e},e.removeField=function(t){var r=n.getItem("searchFields"),i,s=JSON.parse(r),o,u=$(t).attr("data-field-field");return s!==null&&(o=s.filter(function(e){return e!==u}),i=JSON.stringify(o),n.setItem("searchFields",o.length===0?null:i),n.setItem("searchIndex",null),e.loadSearchVals()),e},e.addField=function(t){var r=n.getItem("searchFields"),i,s=JSON.parse(r),o,u=$(t).attr("data-field-field");return s===null&&(s=[]),o=s.concat(u),i=JSON.stringify(o),n.setItem("searchFields",o.length===0?null:i),n.setItem("searchIndex",null),e.loadSearchVals(),e},e.addIndex=function(){var t=p();return t&&(n.setItem("searchFields",null),n.setItem("searchIndex",t),n.setItem("searchIndexLabel",$("option[value="+t+"]").html()),e.loadSearchVals()),e},e.toggleInversion=function(){return n.setItem("searchInvert",d(f().is(":checked"))),n.setItem("searchExclude",null),e.loadSearchVals(),e},e.toggleExclusion=function(){return n.setItem("searchExclude",d(a().is(":checked"))),n.getItem("searchInvert",null),e.loadSearchVals(),e},e.loadSearchVals=function(){var t=n.getItem("searchExclude"),r=n.getItem("searchInvert"),i=n.getItem("searchIndex"),s=n.getItem("searchFields"),o,u,a=[t,r,i,s].map(function(e){return e==="null"||e==="false"||e==="true"?JSON.parse(e):e}),f=a.every(function(e){return e===null});try{f?e.allFields():a[0]===!0?(o=JSON.parse(s),e.excludedFields(o)):a[1]===null&&a[3]!==null?(o=JSON.parse(s),o.length>1?e.multipleFields(o):e.singleField(o)):a[3]!==null?(o=JSON.parse(s),o.length>1?e.multipleFields(o):e.singleFieldInverse(o)):a[1]===null?(u=n.getItem("searchIndexLabel"),e.indexOnly(i,u)):a[1]===!0&&(u=n.getItem("searchIndexLabel"),e.indexInverse(i,u))}catch(l){window.console.log(l),e.allFields()}return e},e}(),shimi.vui=function(e){var t={},n=function(){return $("#document-view")},r=function(){return $("#document-view-tree")},i=function(){return $("#document-view-info")};return t.formatTimestamps=function(){return $(".timestamp").each(function(e,t){var n=(new Date($(t).text())).toLocaleString();n!=="Invalid Date"&&$(t).text(n)}),t},t.get=function(e,i,s){var o="documents/"+e,u=n();return i&&(o=o+"/"+i,u=r()),$.get(o,function(r){u.html(r),window.location.hash=e,t.formatTimestamps(),n().fadeTo("slow",1),s&&s();if(!i){var o=$("#document-restore-button"),a=$("#document-edit-button"),f=$("#document-delete-button");shimi.store(o).d("deleted")==="true"&&(a.hide(),f.hide(),o.show())}}),t},t.restore=function(e,r){var i="./documents/"+e+"?rev="+r,s=$("#document-restore-button"),o=$("#first-index-element").attr("data-first-key"),u=$("#first-index-element").attr("data-first-id"),a,f;return $.ajax({type:"DELETE",url:i,dataType:"json",contentType:"application/json",complete:function(r,i){r.status===200?(f="Success",a="Your document was restored.",t.get(e,null,function(){n().fadeTo("slow",1),shimi.iui.get(o,u)}),shimi.flash(f,a).highlight()):r.status===409?(a=JSON.parse(r.responseText),f=r.statusText,shimi.flash(f,a.message).error()):r.status===404&&(a="Document was erased and cannot be restored.",f=r.statusText,shimi.flash(f,a).error())}}),t},t.del=function(e,r){var i="./documents/"+e+"?rev="+r,s=$("#document-restore-button"),o=$("#first-index-element").attr("data-first-key"),u=$("#first-index-element").attr("data-first-id"),a,f;return $.ajax({type:"DELETE",url:i,dataType:"json",contentType:"application/json",complete:function(e,t){if(e.status===200){f="Success",a="Your document was deleted.";var r=JSON.parse(e.responseText);shimi.store(s).put("document-rev",r.rev),$("#document-delete-button").hide(),$("#document-edit-button").hide(),s.show(),n().fadeTo("slow",.5),shimi.iui.get(o,u),shimi.flash(f,a).highlight()}else e.status===409?(a=JSON.parse(e.responseText),f=e.statusText,shimi.flash(f,a.message).error()):e.status===404&&(a="Document appears to have been deleted already.",f=e.statusText,shimi.flash(f,a).error())}}),t},t.confirmIt=function(e){if(window.confirm("Are you sure?")){var n=shimi.store(i()),r=n.d("document"),s=n.d("rev");e(r,s)}return t},t.edit=function(){return shimi.eui.resetFields(),$("#document-view-tree").hasClass("oldrev")?$("#save-document-button").addClass("oldrev"):$("#save-document-button").removeClass("oldrev"),shimi.efs.fillFieldsets(),t},t.confirmDelete=function(){var e=shimi.store(i()),n=e.d("document"),r=e.d("rev");return t.confirmIt(function(){t.del(n,r)})},t.confirmRestore=function(){var e=shimi.store(i()),n=e.d("document"),r=e.d("rev");return t.confirmIt(function(){t.restore(n,r)})},t.collapseToggle=function(e){return $(e).parent("li").toggleClass("collapsed"),t},t.fetchRevision=function(e){var n=shimi.store($(e)),r=n.d("document"),i=n.d("oldrev");return $(".revision-link").removeClass("selected-revision"),$(e).addClass("selected-revision"),t.get(r,i),t},t}(),shimi.fm=function(){var e={},t=function(e){e===undefined&&(e=""),$.get("file_manager/list_dirs/"+e,function(e){$("#file-paths").html(e)})};e.goDir=function(t){var n=$(t).attr("data-path");return window.sessionStorage.fmPath=n,e.refreshListings(n),e},e.rootDir=function(){var t=window.sessionStorage.fmPath="";return e.refreshListings(),e},e.upDir=function(){var t=window.sessionStorage.fmPath,n=t.split("/");return n.pop(),n=n.join("/"),window.sessionStorage.fmPath=n,e.refreshListings(n),e};var n=function(e){e===undefined&&(e=""),$.get("file_manager/list_files/"+e,function(e){$("#file-listing").html(e)})};e.editFile=function(t){var n=window.sessionStorage.fmPath,i=t.attr("data-file-id"),s="file_manager/"+i;return $.getJSON(s,function(e){r(e,n).dialog("open")}),e},e.deleteFile=function(t){var n=window.sessionStorage.fmPath,r=t.attr("data-file-id"),i=t.attr("data-file-rev"),s="file_manager/"+r+"?rev="+i,o=function(){e.refreshListings(n),shimi.flash("Success","File Deleted").highlight()};return shimi.form.send(s,null,"DELETE",o,t),e};var r=function(t,n){var r=$("#file-path-input");t.path?r.val(t.path.join("/")):r.val("");var i=$("#edit-path-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Move:function(){var s="file_manager/"+t._id+"?rev="+t._rev,o=function(){e.refreshListings(n),shimi.flash("Success","File Moved").highlight()};t.path=r.val().replace(/^\s*|\s*$/g,"").replace(/\/+/g,"/").replace(/^\/|\/$/g,"").split("/"),shimi.form.send(s,t,"PUT",o,i),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return i};return e.refreshListings=function(e){t(e),n(e)},e}(),shimi.initIndexBuilderDialog=function(e){var t=$("#builder-or-input"),n=$("#builder-paren-input"),r=$("#builder-negate-input"),i=$("#builder-operator-input").inputDisable(),s=$("#builder-argument-input").inputDisable(),o=$("#builder-fieldset-input").inputDisable(),u=$("#builder-field-input").inputDisable(),a=[i,o,u],f="doctypes/"+e+"/fieldsets",l="indexes/condition",c=shimi.ihelpers.evs;$(".ui-helper-reset div").show();var h=function(e){var t=$("#index-conditions-listing tbody");return t.append(e),t.sortable(),!1};shimi.ihelpers.fOpts(f,o,function(){o.inputEnable()}),t.change(function(){t.is(":checked")?($("#builder-conditions").hide(),$("#builder-parens").hide()):($("#builder-conditions").show(),$("#builder-parens").show())}),n.change(function(){n.val()?($("#builder-or").hide(),$("#builder-conditions").hide()):($("#builder-or").show(),$("#builder-conditions").show())});var p=function(){c.setIndexFieldsetEvents(e,o,u,function(){return i.inputDisable(),u.inputDisable(),s.inputDisable(),function(){u.inputEnable()}})},d=function(){c.setIndexFieldEvents(e,o,u,function(){return i.inputDisable(),s.inputDisable(),function(){i.inputEnable()}})},v=function(){c.setIndexOperatorEvents(s,i,u,function(){return s.inputDisable(),function(){s.inputEnable()}})},m=$("#index-builder-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var e=!0;!t.is(":checked")&&!n.val()&&a.forEach(function(t){t.val().isBlank()?(t.addClass("ui-state-error"),e=!1):t.removeClass("ui-state-error")}),e&&(t.is(":checked")?$.get(l,{is_or:!0},function(e){h(e)}):n.val()?$.get(l,{is_or:!1,parens:n.val(),negate:!1},function(e){h(e)}):$.get(l,{is_or:!1,parens:!1,negate:r.is(":checked"),fieldset:o.val(),field:u.val(),operator:i.val(),argument:s.val()},function(e){h(e)}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){$("#builder-conditions").show(),o.unbind("change"),u.unbind("change"),i.unbind("change"),shimi.form.clear($(".input")).removeClass("ui-state-error")}});return p(),d(),v(),m},shimi.ieui=function(){var e={},t=function(){return $("#index-conditions-listing tbody")},n=function(){return $("#index-editing-data")},r=function(e,t,n){switch(t){case"integer":case"rational":e*=1}switch(n){case"hasExactly":case"hasGreater":case"hasLess":e=Math.floor(e*1)}return e},i=function(e,t){var n=t.map(function(t,n){n=$(n);var i=n.find("td.or-condition").attr("data-value")==="true",s=n.find("td.paren-condition").attr("data-value"),o;if(i)o={is_or:!0,parens:!1};else if(s)o={is_or:!1,parens:s};else{var u=n.find("td.field-condition").attr("data-value"),a=n.find("td.fieldset-condition").attr("data-value"),f=n.find("td.argument-condition").attr("data-value"),l=shimi.ihelpers.getFieldDoc(u,a,e),c=n.find("td.negate-condition").attr("data-value")==="true",h=n.find("td.operator-condition").attr("data-value");f=r(f,l.subcategory,h),o={is_or:!1,parens:!1,negate:c,fieldset:a,field:u,operator:h,argument:f}}return o}).toArray();return n},s=function(e,t){var n=e.attr("data-index-id"),r=e.attr("data-index-rev"),s="indexes/"+n+"?rev="+r,o=e.attr("data-index-doctype"),u={_id:n,category:"index",doctype:o,show_deleted:e.attr("data-index-show_deleted")==="true",fields:JSON.parse(e.attr("data-index-fields")),fields_label:JSON.parse(e.attr("data-index-fields_label")),name:e.attr("data-index-name"),conditions:i(o,$("#index-conditions-listing tbody tr"))};return e.attr("data-index-replace_function")&&(u.replace_function=e.attr("data-index-replace_function")),shimi.form.send(s,u,"PUT",t,this),!1},o=function(e,t,n,r){var i="indexes/"+e+"?rev="+t,s,o;return $.ajax({type:"DELETE",url:i,dataType:"json",contentType:"application/json",complete:function(e,t){e.status===204?(s="Success",o=n,r(),shimi.flash(s,o).highlight()):e.status===409?(o=JSON.parse(e.responseText),s=e.statusText,shimi.flash(s,o.message).error()):e.status===404&&(o="Index appears to have been deleted already.",s=e.statusText,shimi.flash(s,o).error())}}),!1};return e.init=function(e){var n=$(e).attr("data-index-id"),r="indexes/"+n,i=$("#index-conditions");return $.get(r,function(e){i.html(e),t().sortable(),shimi.piui.get()}),!1},e.save=function(){var t=n();if(t.length!==0){var r=function(){e.init(t),shimi.flash("Success","Your index has been saved.").highlight()};s(t,r)}else shimi.flash("Info","No index has been chosen to save.").highlight()},e.replace=function(){var t=n();return t.length!==0?shimi.initReplaceDialog().dialog("open"):shimi.flash("Info","You must choose an index first.").highlight(),e},e.addCond=function(){var t=n();return t.length!==0?shimi.initIndexBuilderDialog(t.attr("data-index-doctype")).dialog("open"):shimi.flash("Info","You must choose an index first.").highlight(),e},e.remCond=function(t){return $(t).closest("tr").remove(),e},e.newCond=function(){return shimi.initIndexNewDialog().dialog("open"),e},e.del=function(){var t=n();if(t.length!==0){var r=t.attr("data-index-id"),i=t.attr("data-index-rev"),s="Your index has been deleted.",u=function(){$("#index-conditions").empty(),shimi.iiui.init()};window.confirm("Are you sure?")&&o(r,i,s,u)}else shimi.flash("Info","No index has been chosen to delete.").highlight();return e},e}(),shimi.ihelpers=function(){var e={},t=shimi.sess();e.evs={};var n=function(e,t){return e.children().show(),t.forEach(function(t){e.children("option:contains("+t+")").hide()}),!1},r=function(e){var t=$("#builder-operator-input");switch(e.subcategory){case"select":case"docselect":case"text":case"textarea":n(t,["member","true"]);break;case"integer":case"rational":case"date":n(t,["member","true","match"]);break;case"boolean":case"openboolean":n(t,["equal","greater","less","member","match"]);break;case"multiselect":case"docmultiselect":n(t,["equal","greater","less","true","match"])}return!1};return e.alterArg=function(n,r,i,o){var u=function(){return t.get(i.val())};o(),n.removeAttr("disabled").datepicker("destroy"),n.removeAttr("disabled").autocomplete("destroy");var a=function(t,n){return n.subcategory==="date"?(t.removeAttr("disabled"),t.datepicker({dateFormat:"yy-mm-dd"})):(t.removeAttr("disabled"),t.autocomplete({source:n.allowed})),e},f=u();if(f)switch(r.val()){case"true":case"isDefined":case"blank":n.attr("disabled","disabled").val("");break;case"equal":case"member":case"greater":case"less":case"hasExactly":case"hasGreater":case"hasLess":a(n,f)}return e},e.alterOpts=function(t,n,i){return r(t),i(),e},e.fOpts=function(t,n,r){return $.get(t,function(e){n.html(e),r&&r()}),e},e.getFieldDoc=function(e,n,r,i){var o=t.get(e),u="doctypes/"+r+"/fieldsets/"+n+"/fields/"+e+"?format=json";return o?(i&&i(o),o):($.ajax({url:u,async:!1,dataType:"json",success:function(n){t.put(n),i&&i(t.get(e))}}),t.get(e))},e.evs.setIndexDoctypeEvents=function(t,n,r){return t.change(function(){var i="doctypes/"+t.val()+"/fieldsets",s;r&&(s=r()),e.fOpts(i,n,s)}),!1},e.evs.setIndexFieldsetEvents=function(t,n,r,i){return n.change(function(){var s;typeof t!="string"&&(t=t.val());if(n.val()){var o="doctypes/"+t+"/fieldsets/"+n.val()+"/fields?as=options";i&&(s=i()),e.fOpts(o,r,s)}}),e},e.evs.setIndexFieldEvents=function(t,n,r,i){return r.change(function(){var s=r.val(),o=n.val(),u;i&&(u=i()),s.isBlank()||e.getFieldDoc(s,o,t,function(e){shimi.ihelpers.alterOpts(e,s,u)})}),e},e.evs.setIndexOperatorEvents=function(t,n,r,i){return n.change(function(){var s;i&&(s=i()),e.alterArg(t,n,r,s)}),e},e}(),shimi.iiui=function(){var e={};return e.init=function(){var t="indexes",n=$("#index-index-listing");return $.get(t,function(e){n.html(e)}),e},e}(),shimi.piui=function(){var e={},t=shimi.index;return e.get=function(n,r,i,s){var o=$("#index-editing-data").attr("data-index-id"),u="indexes/"+o+"/view",a=$("#index-list-view"),f=$("#index-filter-form input");return o&&t({url:u,target:a}).get(n,r,i,s),e},e}(),shimi.initIndexNewDialog=function(){var e=$("#index-doctype-input"),t=$("#index-fieldset-input").inputDisable(),n=$("#index-field-input").inputDisable(),r=$("#index-name-input"),i=$("#index-show_deleted-input"),s=shimi.ihelpers.evs,o=function(){s.setIndexDoctypeEvents(e,t,function(){return t.inputDisable(),n.inputDisable(),function(){t.inputEnable()}})},u=function(){s.setIndexFieldsetEvents(e,t,n,function(){return n.inputDisable(),function(){n.inputEnable()}})},a=function(e){return $('#index-new-dialog option[value="'+e+'"]').text()},f=function(){return[a(t.val()),a(n.val())].join(":")},l=$("#index-new-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(".input").removeClass("ui-state-error");var t=!0;if(t){var s={category:"index",name:r.val(),show_deleted:i.is(":checked"),conditions:[],doctype:e.val(),fields_label:[f()],fields:[n.val()]},o=function(e){shimi.iiui.init(),$(e).dialog("close")};shimi.form.send("indexes",s,"POST",o,this)}},Cancel:function(){$(this).dialog("close")}},close:function(){t.unbind("change"),e.unbind("change"),shimi.form.clear($(".input")).removeClass("ui-state-error")}});return o(),u(),l},shimi.initReplaceDialog=function(){var e=$("#index-replace_function-input"),t=$("#index-editing-data"),n=$("#index-remove_function-input");t.attr("data-index-replace_function")?e.val(t.attr("data-index-replace_function")):shimi.form.clear(e).removeClass("ui-state-error");var r=$("#index-replace-dialog").dialog({autoOpen:!1,modal:!0,buttons:{Save:function(){$(".input").removeClass("ui-state-error");var r=!0;n.is(":checked")?(t.removeAttr("data-index-replace_function"),$("#replace-function-message").empty()):(e.val().isBlank()?e.addClass("ui-state-error"):e.removeClass("ui-state-error"),r&&(t.attr("data-index-replace_function",e.val()),$("#replace-function-message").text("This index has a replacement function."))),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){shimi.form.clear(e).removeClass("ui-state-error")}});return r},shimi.pui=function(){var e={},t=function(t){window.confirm("Are you sure? This is permanent.")&&$.ajax({type:"DELETE",url:"/projects/"+t,dataType:"json",contentType:"application/json",complete:function(t,n){t.status===204?e.init():window.alert("An error occurred"+t.status)}})};return e.add=function(){var t=$("#project-name"),n=$("#project-description"),r=$(".validate-tips"),i=$([]).add(t).add(n),s=$("#add-dialog").dialog({autoOpen:!1,modal:!0,buttons:{"Add project":function(){i.removeClass("ui-state-error");var s=shimi.form.checkLength(t,"project name",1,50,r);s&&($.ajax({type:"POST",url:"projects/index",dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({name:t.val(),description:n.val()}),complete:function(t,n){t.status===201?e.init():window.alert("An error occurred"+t.status)}}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}},close:function(){i.val("").removeClass("ui-state-error")}});return s},e.del=function(n){var r=$(n).attr("id");return t(r),e},e.init=function(){var e="/projects/index";$.get(e,function(e){$("tbody").empty(),$("tbody").html(e)})},e}(),$(function(){$(".notification").hide(),$("#loading").hide().ajaxStart(function(){$(this).show()}).ajaxStop(function(){$(this).hide()}),shimi.form.initDateFields(),$("#configuration").length>0&&(shimi.initTabs(),$(".simple-tabs").tabs());if($("#all-document-container").length>0){var e;shimi.iui.iOpts().get(),shimi.jumpForm(),shimi.searchForm(),shimi.eui.init(),$("#index-filter-form input").keyup(function(t){clearTimeout(e),e=setTimeout(function(){t.which!==8&&t.which!==46&&shimi.iui.get()},500)}),$("#index-filter-form select").change(function(){shimi.iui.get()}),shimi.loadHash($(location)[0].hash.split("#")[1])}$("#file-upload").length>0&&(shimi.fm.refreshListings(),$("#file-upload-target").load(function(){var e=$("#file-upload-target").contents().find("body pre").html(),t=function(){return e&&e.length>0?JSON.parse(e):{message:!1}};t()&&t().message&&t().status==="error"?(shimi.flash("Error",t().message).error(),shimi.fm.refreshListings()):t().message&&(shimi.flash("Success",t().message).highlight(),shimi.fm.refreshListings())})),$("#all-index-container").length>0&&shimi.iiui.init(),$("#projects-container").length>0&&shimi.pui.init()});